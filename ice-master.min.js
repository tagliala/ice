//
// ice - Master
// The MIT License
// Copyright (c) 2012 The New York Times, CMS Group, Matthew DeLambo <delambo@gmail.com>
//

!function(e,t){"function"==typeof define&&define.amd?define(e):"undefined"!=typeof module&&"object"==typeof exports?module.exports=e():t.rangy=e()}(function(){var i="object",r="function",n="undefined",c=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],l=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],t=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],o=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"];function d(e,t){var n=typeof e[t];return n==r||!(n!=i||!e[t])||"unknown"==n}function s(e,t){return!(typeof e[t]!=i||!e[t])}function e(e,t){return typeof e[t]!=n}function a(i){return function(e,t){for(var n=t.length;n--;)if(!i(e,t[n]))return!1;return!0}}var u=a(d),h=a(s),f=a(e);function g(e){return e&&u(e,o)&&f(e,t)}function m(e){return s(e,"body")?e.body:e.getElementsByTagName("body")[0]}var p,C,v={},N=typeof window!=n&&typeof document!=n,E={isHostMethod:d,isHostObject:s,isHostProperty:e,areHostMethods:u,areHostObjects:h,areHostProperties:f,isTextRange:g,getBody:m,forEach:[].forEach?function(e,t){e.forEach(t)}:function(e,t){for(var n=0,i=e.length;n<i;++n)t(e[n],n)}},y={version:"1.3.0",initialized:!1,isBrowser:N,supported:!0,util:E,features:{},modules:v,config:{alertOnFail:!1,alertOnWarn:!1,preferTextRange:!1,autoInitialize:typeof rangyAutoInitialize==n||rangyAutoInitialize}};function T(e){typeof console!=n&&d(console,"log")&&console.log(e)}function _(e,t){(N&&t?alert:T)(e)}function S(e){y.initialized=!0,y.supported=!1,_("Rangy is not supported in this environment. Reason: "+e,y.config.alertOnFail)}y.fail=S,y.warn=function(e){_("Rangy warning: "+e,y.config.alertOnWarn)},!{}.hasOwnProperty?S("hasOwnProperty not supported"):(E.extend=p=function(e,t,n){var i,r;for(var o in t)t.hasOwnProperty(o)&&(i=e[o],r=t[o],n&&null!==i&&"object"==typeof i&&null!==r&&"object"==typeof r&&p(i,r,!0),e[o]=r);return t.hasOwnProperty("toString")&&(e.toString=t.toString),e},E.createOptions=function(e,t){var n={};return p(n,t),e&&p(n,e),n}),N||S("Rangy can only run in a browser"),function(){var e;if(N){var t=document.createElement("div");t.appendChild(document.createElement("span"));var n=[].slice;try{1==n.call(t.childNodes,0)[0].nodeType&&(e=function(e){return n.call(e,0)})}catch(e){}}e=e||function(e){for(var t=[],n=0,i=e.length;n<i;++n)t[n]=e[n];return t},E.toArray=e}(),N&&(d(document,"addEventListener")?C=function(e,t,n){e.addEventListener(t,n,!1)}:d(document,"attachEvent")?C=function(e,t,n){e.attachEvent("on"+t,n)}:S("Document does not have required addEventListener or attachEvent method"),E.addListener=C);var R=[];function b(e){return e.message||e.description||String(e)}function w(){if(N&&!y.initialized){var e,t=!1,n=!1;d(document,"createRange")&&(e=document.createRange(),u(e,l)&&f(e,c)&&(t=!0));var i,r=m(document);if(r&&"body"==r.nodeName.toLowerCase())if(r&&d(r,"createTextRange")&&g(e=r.createTextRange())&&(n=!0),t||n){for(var o in y.initialized=!0,y.features={implementsDomRange:t,implementsTextRange:n},v)(i=v[o])instanceof D&&i.init(i,y);for(var s=0,a=R.length;s<a;++s)try{R[s](y)}catch(e){T("Rangy init listener threw an exception. Continuing. Detail: "+b(e))}}else S("Neither Range nor TextRange are available");else S("No body element found")}}function O(e,t,n){n&&(e+=" in module "+n.name),y.warn("DEPRECATED: "+e+" is deprecated. Please use "+t+" instead.")}function x(e,t,n,i){e[t]=function(){return O(t,n,i),e[n].apply(e,E.toArray(arguments))}}E.deprecationNotice=O,E.createAliasForDeprecatedMethod=x,y.init=w,y.addInitListener=function(e){y.initialized?e(y):R.push(e)};var k=[];function D(e,t,n){this.name=e,this.dependencies=t,this.initialized=!1,this.supported=!1,this.initializer=n}function A(t,e,n){var i=new D(t,e,function(e){if(!e.initialized){e.initialized=!0;try{n(y,e),e.supported=!0}catch(e){T("Module '"+t+"' failed to load: "+b(e)),e.stack&&T(e.stack)}}});return v[t]=i}function P(){}y.addShimListener=function(e){k.push(e)},N&&(y.shim=y.createMissingNativeApi=function(e){e=e||window,w();for(var t=0,n=k.length;t<n;++t)k[t](e)},x(y,"createMissingNativeApi","shim")),D.prototype={init:function(){for(var e,t,n=this.dependencies||[],i=0,r=n.length;i<r;++i){if(!((e=v[t=n[i]])&&e instanceof D))throw new Error("required module '"+t+"' not found");if(e.init(),!e.supported)throw new Error("required module '"+t+"' not supported")}this.initializer(this)},fail:function(e){throw this.initialized=!0,this.supported=!1,new Error(e)},warn:function(e){y.warn("Module "+this.name+": "+e)},deprecationNotice:function(e,t){y.warn("DEPRECATED: "+e+" in module "+this.name+" is deprecated. Please use "+t+" instead")},createError:function(e){return new Error("Error in Rangy "+this.name+" module: "+e)}},y.createModule=function(e){var t,n=2==arguments.length?(t=arguments[1],[]):(t=arguments[2],arguments[1]),i=A(e,n,t);y.initialized&&y.supported&&i.init()},y.createCoreModule=function(e,t,n){A(e,t,n)},y.RangePrototype=P,y.rangePrototype=new P,y.selectionPrototype=new function(){},y.createCoreModule("DomUtil",[],function(n,l){var i="undefined",r=n.util,s=r.getBody;r.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||l.fail("document missing a Node creation method"),r.isHostMethod(document,"getElementsByTagName")||l.fail("document missing getElementsByTagName method");var e=document.createElement("div");r.areHostMethods(e,["insertBefore","appendChild","cloneNode"])||l.fail("Incomplete Element implementation"),r.isHostProperty(e,"innerHTML")||l.fail("Element is missing innerHTML property");var t=document.createTextNode("test");r.areHostMethods(t,["splitText","deleteData","insertData","appendData","cloneNode"])||l.fail("Incomplete Text Node implementation");var o=function(e,t){for(var n=e.length;n--;)if(e[n]===t)return!0;return!1};function d(e){for(var t=0;e=e.previousSibling;)++t;return t}function u(e,t){for(var n=[],i=e;i;i=i.parentNode)n.push(i);for(i=t;i;i=i.parentNode)if(o(n,i))return i;return null}function a(e,t,n){for(var i=n?t:t.parentNode;i;){if(i===e)return!0;i=i.parentNode}return!1}function h(e,t,n){for(var i,r=n?e:e.parentNode;r;){if((i=r.parentNode)===t)return r;r=i}return null}function c(e){var t=e.nodeType;return 3==t||4==t||8==t}function f(e,t){var n=t.nextSibling,i=t.parentNode;return n?i.insertBefore(e,n):i.appendChild(e),e}function g(e){if(9==e.nodeType)return e;if(typeof e.ownerDocument!=i)return e.ownerDocument;if(typeof e.document!=i)return e.document;if(e.parentNode)return g(e.parentNode);throw l.createError("getDocument: no document found for node")}function m(e){var t=g(e);if(typeof t.defaultView!=i)return t.defaultView;if(typeof t.parentWindow!=i)return t.parentWindow;throw l.createError("Cannot get a window object for node")}function p(e){if(typeof e.contentDocument!=i)return e.contentDocument;if(typeof e.contentWindow!=i)return e.contentWindow.document;throw l.createError("getIframeDocument: No Document object found for iframe element")}function C(e){return e&&r.isHostMethod(e,"setTimeout")&&r.isHostObject(e,"document")}var v,N;function E(e){try{return e.parentNode,!1}catch(e){return!0}}function y(e){if(!e)return"[No node]";if(v&&E(e))return"[Broken node]";if(c(e))return'"'+e.data+'"';if(1!=e.nodeType)return e.nodeName;var t=e.id?' id="'+e.id+'"':"";return"<"+e.nodeName+t+">[index:"+d(e)+",length:"+e.childNodes.length+"]["+(e.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}function T(e){this.root=e,this._next=e}function _(e,t){this.node=e,this.offset=t}function S(e){this.code=this[e],this.codeName=e,this.message="DOMException: "+this.codeName}!function(){var e=document.createElement("b");e.innerHTML="1";var t=e.firstChild;e.innerHTML="<br />",v=E(t),n.features.crashyTextNodes=v}(),typeof window.getComputedStyle!=i?N=function(e,t){return m(e).getComputedStyle(e,null)[t]}:typeof document.documentElement.currentStyle!=i?N=function(e,t){return e.currentStyle?e.currentStyle[t]:""}:l.fail("No means of obtaining computed style properties found"),T.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var e,t,n=this._current=this._next;if(this._current)if(e=n.firstChild)this._next=e;else{for(t=null;n!==this.root&&!(t=n.nextSibling);)n=n.parentNode;this._next=t}return this._current},detach:function(){this._current=this._next=this.root=null}},_.prototype={equals:function(e){return!!e&&this.node===e.node&&this.offset==e.offset},inspect:function(){return"[DomPosition("+y(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},(S.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24}).toString=function(){return this.message},n.dom={arrayContains:o,isHtmlNamespace:function(e){var t;return typeof e.namespaceURI==i||null===(t=e.namespaceURI)||"http://www.w3.org/1999/xhtml"==t},parentElement:function(e){var t=e.parentNode;return 1==t.nodeType?t:null},getNodeIndex:d,getNodeLength:function(e){switch(e.nodeType){case 7:case 10:return 0;case 3:case 8:return e.length;default:return e.childNodes.length}},getCommonAncestor:u,isAncestorOf:a,isOrIsAncestorOf:function(e,t){return a(e,t,!0)},getClosestAncestorIn:h,isCharacterDataNode:c,isTextOrCommentNode:function(e){if(!e)return!1;var t=e.nodeType;return 3==t||8==t},insertAfter:f,splitDataNode:function(e,t,n){var i=e.cloneNode(!1);if(i.deleteData(0,t),e.deleteData(t,e.length-t),f(i,e),n)for(var r,o=0;r=n[o++];)r.node==e&&r.offset>t?(r.node=i,r.offset-=t):r.node==e.parentNode&&r.offset>d(e)&&++r.offset;return i},getDocument:g,getWindow:m,getIframeWindow:function(e){if(typeof e.contentWindow!=i)return e.contentWindow;if(typeof e.contentDocument!=i)return e.contentDocument.defaultView;throw l.createError("getIframeWindow: No Window object found for iframe element")},getIframeDocument:p,getBody:s,isWindow:C,getContentDocument:function(e,t,n){var i;if(e?r.isHostProperty(e,"nodeType")?i=(1==e.nodeType&&"iframe"==e.tagName.toLowerCase()?p:g)(e):C(e)&&(i=e.document):i=document,!i)throw t.createError(n+"(): Parameter must be a Window object or DOM node");return i},getRootContainer:function(e){for(var t;t=e.parentNode;)e=t;return e},comparePoints:function(e,t,n,i){var r,o,s,a,c;if(e==n)return t===i?0:t<i?-1:1;if(r=h(n,e,!0))return t<=d(r)?-1:1;if(r=h(e,n,!0))return d(r)<i?-1:1;if(!(o=u(e,n)))throw new Error("comparePoints error: nodes have no common ancestor");if((s=e===o?o:h(e,o,!0))===(a=n===o?o:h(n,o,!0)))throw l.createError("comparePoints got to case 4 and childA and childB are the same!");for(c=o.firstChild;c;){if(c===s)return-1;if(c===a)return 1;c=c.nextSibling}},isBrokenNode:E,inspectNode:y,getComputedStyleProperty:N,createTestElement:function(e,t,n){var i=s(e),r=e.createElement("div");r.contentEditable=""+!!n,t&&(r.innerHTML=t);var o=i.firstChild;return o?i.insertBefore(r,o):i.appendChild(r),r},removeNode:function(e){return e.parentNode.removeChild(e)},fragmentFromNodeChildren:function(e){for(var t,n=g(e).createDocumentFragment();t=e.firstChild;)n.appendChild(t);return n},createIterator:function(e){return new T(e)},DomPosition:_},n.DOMException=S}),y.createCoreModule("DomRange",["DomUtil"],function(s,e){var a=s.dom,i=s.util,t=a.DomPosition,c=s.DOMException,u=a.isCharacterDataNode,h=a.getNodeIndex,l=a.isOrIsAncestorOf,r=a.getDocument,f=a.comparePoints,d=a.splitDataNode,g=a.getClosestAncestorIn,m=a.getNodeLength,o=a.arrayContains,p=a.getRootContainer,n=s.features.crashyTextNodes,C=a.removeNode;function v(e,t){return 3!=e.nodeType&&(l(e,t.startContainer)||l(e,t.endContainer))}function N(e){return e.document||r(e.startContainer)}function E(e){return new t(e.parentNode,h(e))}function y(e){return new t(e.parentNode,h(e)+1)}function T(e,t,n){var i=11==e.nodeType?e.firstChild:e;return u(t)?n==t.length?a.insertAfter(e,t):t.parentNode.insertBefore(e,0==n?t:d(t,n)):n>=t.childNodes.length?t.appendChild(e):t.insertBefore(e,t.childNodes[n]),i}function _(e,t,n){if(V(e),V(t),N(t)!=N(e))throw new c("WRONG_DOCUMENT_ERR");var i=f(e.startContainer,e.startOffset,t.endContainer,t.endOffset),r=f(e.endContainer,e.endOffset,t.startContainer,t.startOffset);return n?i<=0&&0<=r:i<0&&0<r}function S(e,t,n){var i,r,o,s;for(n=n||{stop:!1};o=e.next();)if(e.isPartiallySelectedSubtree()){if(!1===t(o))return void(n.stop=!0);if(S(s=e.getSubtreeIterator(),t,n),s.detach(),n.stop)return}else for(i=a.createIterator(o);r=i.next();)if(!1===t(r))return void(n.stop=!0)}function R(e){for(var t;e.next();)e.isPartiallySelectedSubtree()?(R(t=e.getSubtreeIterator()),t.detach()):e.remove()}function b(e){for(var t,n,i=N(e.range).createDocumentFragment();t=e.next();){if(e.isPartiallySelectedSubtree()?(t=t.cloneNode(!1),n=e.getSubtreeIterator(),t.appendChild(b(n)),n.detach()):e.remove(),10==t.nodeType)throw new c("HIERARCHY_REQUEST_ERR");i.appendChild(t)}return i}function w(e){return"["+(void 0===e.getName?"Range":e.getName())+"("+a.inspectNode(e.startContainer)+":"+e.startOffset+", "+a.inspectNode(e.endContainer)+":"+e.endOffset+")]"}function O(e,t){var n;this.range=e,this.clonePartiallySelectedTextNodes=t,e.collapsed||(this.sc=e.startContainer,this.so=e.startOffset,this.ec=e.endContainer,this.eo=e.endOffset,n=e.commonAncestorContainer,this.sc===this.ec&&u(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==n||u(this.sc)?g(this.sc,n,!0):this.sc.childNodes[this.so],this._last=this.ec!==n||u(this.ec)?g(this.ec,n,!0):this.ec.childNodes[this.eo-1]))}O.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var e=this._current=this._next;return e&&(this._next=e!==this._last?e.nextSibling:null,u(e)&&this.clonePartiallySelectedTextNodes&&(e===this.ec&&(e=e.cloneNode(!0)).deleteData(this.eo,e.length-this.eo),this._current===this.sc&&(e=e.cloneNode(!0)).deleteData(0,this.so))),e},remove:function(){var e,t,n=this._current;!u(n)||n!==this.sc&&n!==this.ec?n.parentNode&&C(n):(e=n===this.sc?this.so:0)!=(t=n===this.ec?this.eo:n.length)&&n.deleteData(e,t-e)},isPartiallySelectedSubtree:function(){return v(this._current,this.range)},getSubtreeIterator:function(){var e,t,n,i,r,o;return this.isSingleCharacterDataNode?(e=this.range.cloneRange()).collapse(!1):(e=new he(N(this.range)),t=this._current,i=0,o=m(r=n=t),l(t,this.sc)&&(n=this.sc,i=this.so),l(t,this.ec)&&(r=this.ec,o=this.eo),ue(e,n,i,r,o)),new O(e,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var x=[1,3,4,5,7,8,10],k=[2,9,11],D=[1,3,4,5,7,8,10,11],A=[1,3,4,5,7,8];function P(r){return function(e,t){for(var n,i=t?e:e.parentNode;i;){if(n=i.nodeType,o(r,n))return i;i=i.parentNode}return null}}var I=P([9,11]),B=P([5,6,10,12]),M=P([6,10,12]);function L(e,t){if(M(e,t))throw new c("INVALID_NODE_TYPE_ERR")}function H(e,t){if(!o(t,e.nodeType))throw new c("INVALID_NODE_TYPE_ERR")}function j(e,t){if(t<0||t>(u(e)?e.length:e.childNodes.length))throw new c("INDEX_SIZE_ERR")}function U(e,t){if(I(e,!0)!==I(t,!0))throw new c("WRONG_DOCUMENT_ERR")}function W(e){if(B(e,!0))throw new c("NO_MODIFICATION_ALLOWED_ERR")}function F(e,t){if(!e)throw new c(t)}function Q(e,t){return t<=(u(e)?e.length:e.childNodes.length)}function K(e){return!!e.startContainer&&!!e.endContainer&&!(n&&(a.isBrokenNode(e.startContainer)||a.isBrokenNode(e.endContainer)))&&p(e.startContainer)==p(e.endContainer)&&Q(e.startContainer,e.startOffset)&&Q(e.endContainer,e.endOffset)}function V(e){if(!K(e))throw new Error("Range error: Range is not valid. This usually happens after DOM mutation. Range: ("+e.inspect()+")")}var z=document.createElement("style"),X=!1;try{z.innerHTML="<b>x</b>",X=3==z.firstChild.nodeType}catch(e){}var q=(s.features.htmlParsingConforms=X)?function(e){var t=this.startContainer,n=r(t);if(!t)throw new c("INVALID_STATE_ERR");var i=null;return 1==t.nodeType?i=t:u(t)&&(i=a.parentElement(t)),(i=null===i||"HTML"==i.nodeName&&a.isHtmlNamespace(r(i).documentElement)&&a.isHtmlNamespace(i)?n.createElement("body"):i.cloneNode(!1)).innerHTML=e,a.fragmentFromNodeChildren(i)}:function(e){var t=N(this).createElement("body");return t.innerHTML=e,a.fragmentFromNodeChildren(t)};function Y(e,t){V(e);var n=e.startContainer,i=e.startOffset,r=e.endContainer,o=e.endOffset,s=n===r;u(r)&&0<o&&o<r.length&&d(r,o,t),u(n)&&0<i&&i<n.length&&(n=d(n,i,t),s?(o-=i,r=n):r==n.parentNode&&o>=h(n)&&o++,i=0),e.setStartAndEnd(n,i,r,o)}function $(e){V(e);var t=e.commonAncestorContainer.parentNode.cloneNode(!1);return t.appendChild(e.cloneContents()),t.innerHTML}var G=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],Z=0,J=1,ee=2,te=3,ne=0,ie=1,re=2,oe=3;function se(e){e.START_TO_START=Z,e.START_TO_END=J,e.END_TO_END=ee,e.END_TO_START=te,e.NODE_BEFORE=ne,e.NODE_AFTER=ie,e.NODE_BEFORE_AND_AFTER=re,e.NODE_INSIDE=oe}function ae(e){se(e),se(e.prototype)}function ce(s,a){return function(){V(this);var e,t=this.startContainer,n=this.startOffset,i=this.commonAncestorContainer,r=new O(this,!0);t!==i&&(t=(e=y(g(t,i,!0))).node,n=e.offset),S(r,W),r.reset();var o=s(r);return r.detach(),a(this,t,n,t,n),o}}function le(e,d){function t(n,i){return function(e){H(e,x),H(p(e),k);var t=(n?E:y)(e);(i?r:o)(this,t.node,t.offset)}}function r(e,t,n){var i=e.endContainer,r=e.endOffset;t===e.startContainer&&n===e.startOffset||(p(t)==p(i)&&1!=f(t,n,i,r)||(i=t,r=n),d(e,t,n,i,r))}function o(e,t,n){var i=e.startContainer,r=e.startOffset;t===e.endContainer&&n===e.endOffset||(p(t)==p(i)&&-1!=f(t,n,i,r)||(i=t,r=n),d(e,i,r,t,n))}function n(){}n.prototype=s.rangePrototype,e.prototype=new n,i.extend(e.prototype,{setStart:function(e,t){L(e,!0),j(e,t),r(this,e,t)},setEnd:function(e,t){L(e,!0),j(e,t),o(this,e,t)},setStartAndEnd:function(){var e=arguments,t=e[0],n=e[1],i=t,r=n;switch(e.length){case 3:r=e[2];break;case 4:i=e[2],r=e[3]}d(this,t,n,i,r)},setBoundary:function(e,t,n){this["set"+(n?"Start":"End")](e,t)},setStartBefore:t(!0,!0),setStartAfter:t(!1,!0),setEndBefore:t(!0,!1),setEndAfter:t(!1,!1),collapse:function(e){V(this),e?d(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):d(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(e){L(e,!0),d(this,e,0,e,m(e))},selectNode:function(e){L(e,!1),H(e,x);var t=E(e),n=y(e);d(this,t.node,t.offset,n.node,n.offset)},extractContents:ce(b,d),deleteContents:ce(R,d),canSurroundContents:function(){V(this),W(this.startContainer),W(this.endContainer);var e=new O(this,!0),t=e._first&&v(e._first,this)||e._last&&v(e._last,this);return e.detach(),!t},splitBoundaries:function(){Y(this)},splitBoundariesPreservingPositions:function(e){Y(this,e)},normalizeBoundaries:function(){V(this);function e(e){var t=e.nextSibling;t&&t.nodeType==e.nodeType&&(c=(a=e).length,e.appendData(t.data),C(t))}function t(e){var t,n,i=e.previousSibling;i&&i.nodeType==e.nodeType&&(t=(o=e).length,s=i.length,e.insertData(0,i.data),C(i),o==a?(c+=s,a=o):a==e.parentNode&&(n=h(e),c==n?(a=e,c=t):n<c&&c--))}var n,i,r,o=this.startContainer,s=this.startOffset,a=this.endContainer,c=this.endOffset,l=!0;u(a)?c==a.length?e(a):0==c&&(n=a.previousSibling)&&n.nodeType==a.nodeType&&(c=n.length,o==a&&(l=!1),n.appendData(a.data),C(a),a=n):(0<c&&((i=a.childNodes[c-1])&&u(i)&&e(i)),l=!this.collapsed),l?u(o)?0==s?t(o):s==o.length&&(n=o.nextSibling)&&n.nodeType==o.nodeType&&(a==n&&(c+=(a=o).length),o.appendData(n.data),C(n)):s<o.childNodes.length&&((r=o.childNodes[s])&&u(r)&&t(r)):(o=a,s=c),d(this,o,s,a,c)},collapseToPoint:function(e,t){L(e,!0),j(e,t),this.setStartAndEnd(e,t)}}),ae(e)}function de(e){e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset,e.commonAncestorContainer=e.collapsed?e.startContainer:a.getCommonAncestor(e.startContainer,e.endContainer)}function ue(e,t,n,i,r){e.startContainer=t,e.startOffset=n,e.endContainer=i,e.endOffset=r,e.document=a.getDocument(t),de(e)}function he(e){this.startContainer=e,this.startOffset=0,this.endContainer=e,this.endOffset=0,this.document=e,de(this)}i.extend(s.rangePrototype,{compareBoundaryPoints:function(e,t){V(this),U(this.startContainer,t.startContainer);var n=e==te||e==Z?"start":"end",i=e==J||e==Z?"start":"end",r=this[n+"Container"],o=this[n+"Offset"],s=t[i+"Container"],a=t[i+"Offset"];return f(r,o,s,a)},insertNode:function(e){if(V(this),H(e,D),W(this.startContainer),l(e,this.startContainer))throw new c("HIERARCHY_REQUEST_ERR");var t=T(e,this.startContainer,this.startOffset);this.setStartBefore(t)},cloneContents:function(){var e;if(V(this),this.collapsed)return N(this).createDocumentFragment();if(this.startContainer===this.endContainer&&u(this.startContainer))return(n=this.startContainer.cloneNode(!0)).data=n.data.slice(this.startOffset,this.endOffset),(e=N(this).createDocumentFragment()).appendChild(n),e;var t=new O(this,!0),n=function e(t){for(var n,i,r,o=N(t.range).createDocumentFragment();i=t.next();){if(n=t.isPartiallySelectedSubtree(),i=i.cloneNode(!n),n&&(r=t.getSubtreeIterator(),i.appendChild(e(r)),r.detach()),10==i.nodeType)throw new c("HIERARCHY_REQUEST_ERR");o.appendChild(i)}return o}(t);return t.detach(),n},canSurroundContents:function(){V(this),W(this.startContainer),W(this.endContainer);var e=new O(this,!0),t=e._first&&v(e._first,this)||e._last&&v(e._last,this);return e.detach(),!t},surroundContents:function(e){if(H(e,A),!this.canSurroundContents())throw new c("INVALID_STATE_ERR");var t=this.extractContents();if(e.hasChildNodes())for(;e.lastChild;)e.removeChild(e.lastChild);T(e,this.startContainer,this.startOffset),e.appendChild(t),this.selectNode(e)},cloneRange:function(){V(this);for(var e,t=new he(N(this)),n=G.length;n--;)t[e=G[n]]=this[e];return t},toString:function(){V(this);var e=this.startContainer;if(e===this.endContainer&&u(e))return 3==e.nodeType||4==e.nodeType?e.data.slice(this.startOffset,this.endOffset):"";var t=[],n=new O(this,!0);return S(n,function(e){3!=e.nodeType&&4!=e.nodeType||t.push(e.data)}),n.detach(),t.join("")},compareNode:function(e){V(this);var t=e.parentNode,n=h(e);if(!t)throw new c("NOT_FOUND_ERR");var i=this.comparePoint(t,n),r=this.comparePoint(t,n+1);return i<0?0<r?re:ne:0<r?ie:oe},comparePoint:function(e,t){return V(this),F(e,"HIERARCHY_REQUEST_ERR"),U(e,this.startContainer),f(e,t,this.startContainer,this.startOffset)<0?-1:0<f(e,t,this.endContainer,this.endOffset)?1:0},createContextualFragment:q,toHtml:function(){return $(this)},intersectsNode:function(e,t){if(V(this),p(e)!=p(this.startContainer))return!1;var n=e.parentNode,i=h(e);if(!n)return!0;var r=f(n,i,this.endContainer,this.endOffset),o=f(n,i+1,this.startContainer,this.startOffset);return t?r<=0&&0<=o:r<0&&0<o},isPointInRange:function(e,t){return V(this),F(e,"HIERARCHY_REQUEST_ERR"),U(e,this.startContainer),0<=f(e,t,this.startContainer,this.startOffset)&&f(e,t,this.endContainer,this.endOffset)<=0},intersectsRange:function(e){return _(this,e,!1)},intersectsOrTouchesRange:function(e){return _(this,e,!0)},intersection:function(e){if(this.intersectsRange(e)){var t=f(this.startContainer,this.startOffset,e.startContainer,e.startOffset),n=f(this.endContainer,this.endOffset,e.endContainer,e.endOffset),i=this.cloneRange();return-1==t&&i.setStart(e.startContainer,e.startOffset),1==n&&i.setEnd(e.endContainer,e.endOffset),i}return null},union:function(e){if(this.intersectsOrTouchesRange(e)){var t=this.cloneRange();return-1==f(e.startContainer,e.startOffset,this.startContainer,this.startOffset)&&t.setStart(e.startContainer,e.startOffset),1==f(e.endContainer,e.endOffset,this.endContainer,this.endOffset)&&t.setEnd(e.endContainer,e.endOffset),t}throw new c("Ranges do not intersect")},containsNode:function(e,t){return t?this.intersectsNode(e,!1):this.compareNode(e)==oe},containsNodeContents:function(e){return 0<=this.comparePoint(e,0)&&this.comparePoint(e,m(e))<=0},containsRange:function(e){var t=this.intersection(e);return null!==t&&e.equals(t)},containsNodeText:function(e){var t=this.cloneRange();t.selectNode(e);var n=t.getNodes([3]);if(0<n.length){t.setStart(n[0],0);var i=n.pop();return t.setEnd(i,i.length),this.containsRange(t)}return this.containsNodeContents(e)},getNodes:function(e,t){return V(this),function(i,e,r){var o,s=!(!e||!e.length),a=!!r;s&&(o=new RegExp("^("+e.join("|")+")$"));var c=[];return S(new O(i,!1),function(e){var t,n;s&&!o.test(e.nodeType)||a&&!r(e)||(e==(t=i.startContainer)&&u(t)&&i.startOffset==t.length||(e==(n=i.endContainer)&&u(n)&&0==i.endOffset||c.push(e)))}),c}(this,e,t)},getDocument:function(){return N(this)},collapseBefore:function(e){this.setEndBefore(e),this.collapse(!1)},collapseAfter:function(e){this.setStartAfter(e),this.collapse(!0)},getBookmark:function(e){var t=N(this),n=s.createRange(t);e=e||a.getBody(t),n.selectNodeContents(e);var i=this.intersection(n),r=0,o=0;return i&&(n.setEnd(i.startContainer,i.startOffset),o=(r=n.toString().length)+i.toString().length),{start:r,end:o,containerNode:e}},moveToBookmark:function(e){var t=e.containerNode,n=0;this.setStart(t,0),this.collapse(!0);for(var i,r,o,s,a=[t],c=!1,l=!1;!l&&(i=a.pop());)if(3==i.nodeType)r=n+i.length,!c&&e.start>=n&&e.start<=r&&(this.setStart(i,e.start-n),c=!0),c&&e.end>=n&&e.end<=r&&(this.setEnd(i,e.end-n),l=!0),n=r;else for(o=(s=i.childNodes).length;o--;)a.push(s[o])},getName:function(){return"DomRange"},equals:function(e){return he.rangesEqual(this,e)},isValid:function(){return K(this)},inspect:function(){return w(this)},detach:function(){}}),le(he,ue),i.extend(he,{rangeProperties:G,RangeIterator:O,copyComparisonConstants:ae,createPrototypeRange:le,inspect:w,toHtml:$,getRangeDocument:N,rangesEqual:function(e,t){return e.startContainer===t.startContainer&&e.startOffset===t.startOffset&&e.endContainer===t.endContainer&&e.endOffset===t.endOffset}}),s.DomRange=he}),y.createCoreModule("WrappedRange",["DomRange"],function(d,u){var h,o,r,e,t,n,T=d.dom,f=d.util,_=T.DomPosition,g=d.DomRange,m=T.getBody,p=T.getContentDocument,S=T.isCharacterDataNode;d.features.implementsDomRange&&function(){var t,n,i=g.rangeProperties;function r(e){for(var t,n=i.length;n--;)e[t=i[n]]=e.nativeRange[t];e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset}h=function(e){if(!e)throw u.createError("WrappedRange: Range must be specified");this.nativeRange=e,r(this)},g.createPrototypeRange(h,function(e,t,n,i,r){var o=e.startContainer!==t||e.startOffset!=n,s=e.endContainer!==i||e.endOffset!=r,a=!e.equals(e.nativeRange);(o||s||a)&&(e.setEnd(i,r),e.setStart(t,n))}),(t=h.prototype).selectNode=function(e){this.nativeRange.selectNode(e),r(this)},t.cloneContents=function(){return this.nativeRange.cloneContents()},t.surroundContents=function(e){this.nativeRange.surroundContents(e),r(this)},t.collapse=function(e){this.nativeRange.collapse(e),r(this)},t.cloneRange=function(){return new h(this.nativeRange.cloneRange())},t.refresh=function(){r(this)},t.toString=function(){return this.nativeRange.toString()};var e=document.createTextNode("test");m(document).appendChild(e);var o=document.createRange();o.setStart(e,0),o.setEnd(e,0);try{o.setStart(e,1),t.setStart=function(e,t){this.nativeRange.setStart(e,t),r(this)},t.setEnd=function(e,t){this.nativeRange.setEnd(e,t),r(this)},n=function(t){return function(e){this.nativeRange[t](e),r(this)}}}catch(e){t.setStart=function(t,n){try{this.nativeRange.setStart(t,n)}catch(e){this.nativeRange.setEnd(t,n),this.nativeRange.setStart(t,n)}r(this)},t.setEnd=function(t,n){try{this.nativeRange.setEnd(t,n)}catch(e){this.nativeRange.setStart(t,n),this.nativeRange.setEnd(t,n)}r(this)},n=function(n,i){return function(t){try{this.nativeRange[n](t)}catch(e){this.nativeRange[i](t),this.nativeRange[n](t)}r(this)}}}t.setStartBefore=n("setStartBefore","setEndBefore"),t.setStartAfter=n("setStartAfter","setEndAfter"),t.setEndBefore=n("setEndBefore","setStartBefore"),t.setEndAfter=n("setEndAfter","setStartAfter"),t.selectNodeContents=function(e){this.setStartAndEnd(e,0,T.getNodeLength(e))},o.selectNodeContents(e),o.setEnd(e,3);var s=document.createRange();s.selectNodeContents(e),s.setEnd(e,4),s.setStart(e,2),-1==o.compareBoundaryPoints(o.START_TO_END,s)&&1==o.compareBoundaryPoints(o.END_TO_START,s)?t.compareBoundaryPoints=function(e,t){return e==(t=t.nativeRange||t).START_TO_END?e=t.END_TO_START:e==t.END_TO_START&&(e=t.START_TO_END),this.nativeRange.compareBoundaryPoints(e,t)}:t.compareBoundaryPoints=function(e,t){return this.nativeRange.compareBoundaryPoints(e,t.nativeRange||t)};var a=document.createElement("div");a.innerHTML="123";var c=a.firstChild,l=m(document);l.appendChild(a),o.setStart(c,1),o.setEnd(c,2),o.deleteContents(),"13"==c.data&&(t.deleteContents=function(){this.nativeRange.deleteContents(),r(this)},t.extractContents=function(){var e=this.nativeRange.extractContents();return r(this),e}),l.removeChild(a),l=null,f.isHostMethod(o,"createContextualFragment")&&(t.createContextualFragment=function(e){return this.nativeRange.createContextualFragment(e)}),m(document).removeChild(e),t.getName=function(){return"WrappedRange"},d.WrappedRange=h,d.createNativeRange=function(e){return(e=p(e,u,"createNativeRange")).createRange()}}(),d.features.implementsTextRange&&(o=function(e,t,n,i,r){var o=e.duplicate();o.collapse(n);var s=o.parentElement();if(T.isOrIsAncestorOf(t,s)||(s=t),!s.canHaveHTML){var a=new _(s.parentNode,T.getNodeIndex(s));return{boundaryPosition:a,nodeInfo:{nodeIndex:a.offset,containerElement:a.node}}}var c=T.getDocument(s).createElement("span");c.parentNode&&T.removeNode(c);for(var l,d,u,h,f,g=n?"StartToStart":"StartToEnd",m=r&&r.containerElement==s?r.nodeIndex:0,p=s.childNodes.length,C=p,v=C;v==p?s.appendChild(c):s.insertBefore(c,s.childNodes[v]),o.moveToElementText(c),0!=(l=o.compareEndPoints(g,e))&&m!=C;){if(-1==l){if(C==m+1)break;m=v}else C=C==m+1?m:v;v=Math.floor((m+C)/2),s.removeChild(c)}if(f=c.nextSibling,-1==l&&f&&S(f)){if(o.setEndPoint(n?"EndToStart":"EndToEnd",e),/[\r\n]/.test(f.data))for(var N=o.duplicate(),E=N.text.replace(/\r\n/g,"\r").length,y=N.moveStart("character",E);-1==(l=N.compareEndPoints("StartToEnd",N));)y++,N.moveStart("character",1);else y=o.text.length;h=new _(f,y)}else d=(i||!n)&&c.previousSibling,h=(u=(i||n)&&c.nextSibling)&&S(u)?new _(u,0):d&&S(d)?new _(d,d.data.length):new _(s,T.getNodeIndex(c));return T.removeNode(c),{boundaryPosition:h,nodeInfo:{nodeIndex:v,containerElement:s}}},r=function(e,t){var n,i,r=e.offset,o=T.getDocument(e.node),s=m(o).createTextRange(),a=S(e.node),c=a?(n=e.node).parentNode:(n=r<(i=e.node.childNodes).length?i[r]:null,e.node),l=o.createElement("span");return l.innerHTML="&#feff;",n?c.insertBefore(l,n):c.appendChild(l),s.moveToElementText(l),s.collapse(!t),c.removeChild(l),a&&s[t?"moveStart":"moveEnd"]("character",r),s},((e=function(e){this.textRange=e,this.refresh()}).prototype=new g(document)).refresh=function(){var e,t,n,i=function(e){var t=e.parentElement(),n=e.duplicate();n.collapse(!0);var i=n.parentElement();(n=e.duplicate()).collapse(!1);var r=n.parentElement(),o=i==r?i:T.getCommonAncestor(i,r);return o==t?o:T.getCommonAncestor(t,o)}(this.textRange),r=0==(n=this.textRange).compareEndPoints("StartToEnd",n)?e=o(this.textRange,i,!0,!0).boundaryPosition:(e=(t=o(this.textRange,i,!0,!1)).boundaryPosition,o(this.textRange,i,!1,!1,t.nodeInfo).boundaryPosition);this.setStart(e.node,e.offset),this.setEnd(r.node,r.offset)},e.prototype.getName=function(){return"WrappedTextRange"},g.copyComparisonConstants(e),e.rangeToTextRange=t=function(e){if(e.collapsed)return r(new _(e.startContainer,e.startOffset),!0);var t=r(new _(e.startContainer,e.startOffset),!0),n=r(new _(e.endContainer,e.endOffset),!1),i=m(g.getRangeDocument(e)).createTextRange();return i.setEndPoint("StartToStart",t),i.setEndPoint("EndToEnd",n),i},e.prototype.toTextRange=function(){return t(this)},d.WrappedTextRange=e,d.features.implementsDomRange&&!d.config.preferTextRange||(void 0===(n=Function("return this;")()).Range&&(n.Range=e),d.createNativeRange=function(e){return e=p(e,u,"createNativeRange"),m(e).createTextRange()},d.WrappedRange=e)),d.createRange=function(e){return e=p(e,u,"createRange"),new d.WrappedRange(d.createNativeRange(e))},d.createRangyRange=function(e){return e=p(e,u,"createRangyRange"),new g(e)},f.createAliasForDeprecatedMethod(d,"createIframeRange","createRange"),f.createAliasForDeprecatedMethod(d,"createIframeRangyRange","createRangyRange"),d.addShimListener(function(e){var t=e.document;void 0===t.createRange&&(t.createRange=function(){return d.createRange(t)}),t=e=null})}),y.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(u,c){u.config.checkSelectionRanges=!0;var r,o,e="boolean",t="number",h=u.dom,n=u.util,i=n.isHostMethod,a=u.DomRange,s=u.WrappedRange,l=u.DOMException,d=h.DomPosition,f=u.features,g="Control",m=h.getDocument,p=h.getBody,C=a.rangesEqual;function v(e){return"string"==typeof e?/^backward(s)?$/i.test(e):!!e}function N(e,t){if(e){if(h.isWindow(e))return e;if(e instanceof V)return e.win;var n=h.getContentDocument(e,c,t);return h.getWindow(n)}return window}function E(e){return N(e,"getDocSelection").document.selection}function y(e){var t=!1;return e.anchorNode&&(t=1==h.comparePoints(e.anchorNode,e.anchorOffset,e.focusNode,e.focusOffset)),t}var T=i(window,"getSelection"),_=n.isHostObject(document,"selection");f.implementsWinGetSelection=T;var S=(f.implementsDocSelection=_)&&(!T||u.config.preferTextRange);if(S)r=E,u.isSelectionValid=function(e){var t=N(e,"isSelectionValid").document,n=t.selection;return"None"!=n.type||m(n.createRange().parentElement())==t};else{if(!T)return c.fail("Neither document.selection or window.getSelection() detected."),!1;r=function(e){return N(e,"getWinSelection").getSelection()},u.isSelectionValid=function(){return!0}}var R=(u.getNativeSelection=r)();if(!R)return c.fail("Native selection was null (possibly issue 138?)"),!1;var b=u.createNativeRange(document),w=p(document),O=n.areHostProperties(R,["anchorNode","focusNode","anchorOffset","focusOffset"]);f.selectionHasAnchorAndFocus=O;var x=i(R,"extend");f.selectionHasExtend=x;var k=typeof R.rangeCount==t;f.selectionHasRangeCount=k;var D=!1,A=!0,P=x?function(e,t){var n=a.getRangeDocument(t),i=u.createRange(n);i.collapseToPoint(t.endContainer,t.endOffset),e.addRange(j(i)),e.extend(t.startContainer,t.startOffset)}:null;n.areHostMethods(R,["addRange","getRangeAt","removeAllRanges"])&&typeof R.rangeCount==t&&f.implementsDomRange&&function(){var e=window.getSelection();if(e){for(var t=e.rangeCount,n=1<t,i=[],r=y(e),o=0;o<t;++o)i[o]=e.getRangeAt(o);var s,a,c=h.createTestElement(document,"",!1),l=c.appendChild(document.createTextNode("   ")),d=document.createRange();for(d.setStart(l,1),d.collapse(!0),e.removeAllRanges(),e.addRange(d),A=1==e.rangeCount,e.removeAllRanges(),n||(s=window.navigator.appVersion.match(/Chrome\/(.*?) /),D=!(s&&36<=parseInt(s[1]))&&(a=d.cloneRange(),d.setStart(l,0),a.setEnd(l,3),a.setStart(l,2),e.addRange(d),e.addRange(a),2==e.rangeCount)),h.removeNode(c),e.removeAllRanges(),o=0;o<t;++o)0==o&&r?P?P(e,i[o]):(u.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend"),e.addRange(i[o])):e.addRange(i[o])}}(),f.selectionSupportsMultipleRanges=D,f.collapsedNonEditableSelectionsSupported=A;var I,B,M=!1;function L(e,t,n){var i=n?"end":"start",r=n?"start":"end";e.anchorNode=t[i+"Container"],e.anchorOffset=t[i+"Offset"],e.focusNode=t[r+"Container"],e.focusOffset=t[r+"Offset"]}function H(e){e.anchorNode=e.focusNode=null,e.anchorOffset=e.focusOffset=0,e.rangeCount=0,e.isCollapsed=!0,e._ranges.length=0}function j(e){var t;return e instanceof a?((t=u.createNativeRange(e.getDocument())).setEnd(e.endContainer,e.endOffset),t.setStart(e.startContainer,e.startOffset)):e instanceof s?t=e.nativeRange:f.implementsDomRange&&e instanceof h.getWindow(e.startContainer).Range&&(t=e),t}function U(e){var t=e.getNodes();if(!function(e){if(e.length&&1==e[0].nodeType){for(var t=1,n=e.length;t<n;++t)if(!h.isAncestorOf(e[0],e[t]))return;return 1}}(t))throw c.createError("getSingleElementFromRange: range "+e.inspect()+" did not consist of a single element");return t[0]}function W(e){return e&&void 0!==e.text}function F(e,t){var n=new s(t);e._ranges=[n],L(e,n,!1),e.rangeCount=1,e.isCollapsed=n.collapsed}function Q(e){if(e._ranges.length=0,"None"==e.docSelection.type)H(e);else{var t=e.docSelection.createRange();if(W(t))F(e,t);else{e.rangeCount=t.length;for(var n,i=m(t.item(0)),r=0;r<e.rangeCount;++r)(n=u.createRange(i)).selectNode(t.item(r)),e._ranges.push(n);e.isCollapsed=1==e.rangeCount&&e._ranges[0].collapsed,L(e,e._ranges[e.rangeCount-1],!1)}}}function K(e,t){for(var n=e.docSelection.createRange(),i=U(t),r=m(n.item(0)),o=p(r).createControlRange(),s=0,a=n.length;s<a;++s)o.add(n.item(s));try{o.add(i)}catch(e){throw c.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}o.select(),Q(e)}function V(e,t,n){this.nativeSelection=e,this.docSelection=t,this._ranges=[],this.win=n,this.refresh()}function z(e){e.win=e.anchorNode=e.focusNode=e._ranges=null,e.rangeCount=e.anchorOffset=e.focusOffset=0,e.detached=!0}w&&i(w,"createControlRange")&&(I=w.createControlRange(),n.areHostProperties(I,["item","add"])&&(M=!0)),f.implementsControlRange=M,o=O?function(e){return e.anchorNode===e.focusNode&&e.anchorOffset===e.focusOffset}:function(e){return!!e.rangeCount&&e.getRangeAt(e.rangeCount-1).collapsed},i(R,"getRangeAt")?B=function(e,t){try{return e.getRangeAt(t)}catch(e){return null}}:O&&(B=function(e){var t=m(e.anchorNode),n=u.createRange(t);return n.setStartAndEnd(e.anchorNode,e.anchorOffset,e.focusNode,e.focusOffset),n.collapsed!==this.isCollapsed&&n.setStartAndEnd(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset),n}),V.prototype=u.selectionPrototype;var X=[];function q(e,t){for(var n,i,r=X.length;r--;)if(i=(n=X[r]).selection,"deleteAll"==t)z(i);else if(n.win==e)return"delete"==t?(X.splice(r,1),!0):i;return"deleteAll"==t&&(X.length=0),null}function Y(e){if(e&&e instanceof V)return e.refresh(),e;var t=q(e=N(e,"getNativeSelection")),n=r(e),i=_?E(e):null;return t?(t.nativeSelection=n,t.docSelection=i,t.refresh()):(t=new V(n,i,e),X.push({win:e,selection:t})),t}u.getSelection=Y,n.createAliasForDeprecatedMethod(u,"getIframeSelection","getSelection");var $,G=V.prototype;function Z(e,t){for(var n,i=m(t[0].startContainer),r=p(i).createControlRange(),o=0,s=t.length;o<s;++o){n=U(t[o]);try{r.add(n)}catch(e){throw c.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}r.select(),Q(e)}if(!S&&O&&n.areHostMethods(R,["removeAllRanges","addRange"])){G.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),H(this)};function J(e,t){P(e.nativeSelection,t),e.refresh()}G.addRange=k?function(e,t){if(M&&_&&this.docSelection.type==g)K(this,e);else if(v(t)&&x)J(this,e);else{var n,i=D?this.rangeCount:(this.removeAllRanges(),0),r=j(e).cloneRange();try{this.nativeSelection.addRange(r)}catch(e){}this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==i+1?(!u.config.checkSelectionRanges||(n=B(this.nativeSelection,this.rangeCount-1))&&!C(n,e)&&(e=new s(n)),this._ranges[this.rangeCount-1]=e,L(this,e,te(this.nativeSelection)),this.isCollapsed=o(this)):this.refresh()}}:function(e,t){v(t)&&x?J(this,e):(this.nativeSelection.addRange(j(e)),this.refresh())},G.setRanges=function(e){if(M&&_&&1<e.length)Z(this,e);else{this.removeAllRanges();for(var t=0,n=e.length;t<n;++t)this.addRange(e[t])}}}else{if(!(i(R,"empty")&&i(b,"select")&&M&&S))return c.fail("No means of selecting a Range or TextRange was found"),!1;G.removeAllRanges=function(){try{var e,t;this.docSelection.empty(),"None"!=this.docSelection.type&&(this.anchorNode?e=m(this.anchorNode):this.docSelection.type!=g||(t=this.docSelection.createRange()).length&&(e=m(t.item(0))),e&&(p(e).createTextRange().select(),this.docSelection.empty()))}catch(e){}H(this)},G.addRange=function(e){this.docSelection.type==g?K(this,e):(u.WrappedTextRange.rangeToTextRange(e).select(),this._ranges[0]=e,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,L(this,e,!1))},G.setRanges=function(e){this.removeAllRanges();var t=e.length;1<t?Z(this,e):t&&this.addRange(e[0])}}if(G.getRangeAt=function(e){if(e<0||e>=this.rangeCount)throw new l("INDEX_SIZE_ERR");return this._ranges[e].cloneRange()},S)$=function(e){var t;u.isSelectionValid(e.win)?t=e.docSelection.createRange():(t=p(e.win.document).createTextRange()).collapse(!0),e.docSelection.type==g?Q(e):W(t)?F(e,t):H(e)};else if(i(R,"getRangeAt")&&typeof R.rangeCount==t)$=function(e){if(M&&_&&e.docSelection.type==g)Q(e);else if(e._ranges.length=e.rangeCount=e.nativeSelection.rangeCount,e.rangeCount){for(var t=0,n=e.rangeCount;t<n;++t)e._ranges[t]=new u.WrappedRange(e.nativeSelection.getRangeAt(t));L(e,e._ranges[e.rangeCount-1],te(e.nativeSelection)),e.isCollapsed=o(e)}else H(e)};else{if(!O||typeof R.isCollapsed!=e||typeof b.collapsed!=e||!f.implementsDomRange)return c.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;$=function(e){var t,n,i,r=e.nativeSelection;r.anchorNode?(t=B(r,0),e._ranges=[t],e.rangeCount=1,i=(n=e).nativeSelection,n.anchorNode=i.anchorNode,n.anchorOffset=i.anchorOffset,n.focusNode=i.focusNode,n.focusOffset=i.focusOffset,e.isCollapsed=o(e)):H(e)}}G.refresh=function(e){var t=e?this._ranges.slice(0):null,n=this.anchorNode,i=this.anchorOffset;if($(this),e){var r=t.length;if(r!=this._ranges.length)return!0;if(this.anchorNode!=n||this.anchorOffset!=i)return!0;for(;r--;)if(!C(t[r],this._ranges[r]))return!0;return!1}};function ee(e,t){var n=e.getAllRanges();e.removeAllRanges();for(var i=0,r=n.length;i<r;++i)C(t,n[i])||e.addRange(n[i]);e.rangeCount||H(e)}var te;function ne(e,t){if(e.win.document!=m(t))throw new l("WRONG_DOCUMENT_ERR")}function ie(i){return function(e,t){var n;this.rangeCount?(n=this.getRangeAt(0))["set"+(i?"Start":"End")](e,t):(n=u.createRange(this.win.document)).setStartAndEnd(e,t),this.setSingleRange(n,this.isBackward())}}function re(e){var t=[],n=new d(e.anchorNode,e.anchorOffset),i=new d(e.focusNode,e.focusOffset),r="function"==typeof e.getName?e.getName():"Selection";if(void 0!==e.rangeCount)for(var o=0,s=e.rangeCount;o<s;++o)t[o]=a.inspect(e.getRangeAt(o));return"["+r+"(Ranges: "+t.join(", ")+")(anchor: "+n.inspect()+", focus: "+i.inspect()+"]"}G.removeRange=M&&_?function(e){if(this.docSelection.type==g){for(var t=this.docSelection.createRange(),n=U(e),i=m(t.item(0)),r=p(i).createControlRange(),o=!1,s=0,a=t.length;s<a;++s)t.item(s)!==n||o?r.add(t.item(s)):o=!0;r.select(),Q(this)}else ee(this,e)}:function(e){ee(this,e)},!S&&O&&f.implementsDomRange?(te=y,G.isBackward=function(){return te(this)}):te=G.isBackward=function(){return!1},G.isBackwards=G.isBackward,G.toString=function(){for(var e=[],t=0,n=this.rangeCount;t<n;++t)e[t]=""+this._ranges[t];return e.join("")},G.collapse=function(e,t){ne(this,e);var n=u.createRange(e);n.collapseToPoint(e,t),this.setSingleRange(n),this.isCollapsed=!0},G.collapseToStart=function(){if(!this.rangeCount)throw new l("INVALID_STATE_ERR");var e=this._ranges[0];this.collapse(e.startContainer,e.startOffset)},G.collapseToEnd=function(){if(!this.rangeCount)throw new l("INVALID_STATE_ERR");var e=this._ranges[this.rangeCount-1];this.collapse(e.endContainer,e.endOffset)},G.selectAllChildren=function(e){ne(this,e);var t=u.createRange(e);t.selectNodeContents(e),this.setSingleRange(t)},G.deleteFromDocument=function(){if(M&&_&&this.docSelection.type==g){for(var e,t=this.docSelection.createRange();t.length;)e=t.item(0),t.remove(e),h.removeNode(e);this.refresh()}else if(this.rangeCount){var n=this.getAllRanges();if(n.length){this.removeAllRanges();for(var i=0,r=n.length;i<r;++i)n[i].deleteContents();this.addRange(n[r-1])}}},G.eachRange=function(e,t){for(var n=0,i=this._ranges.length;n<i;++n)if(e(this.getRangeAt(n)))return t},G.getAllRanges=function(){var t=[];return this.eachRange(function(e){t.push(e)}),t},G.setSingleRange=function(e,t){this.removeAllRanges(),this.addRange(e,t)},G.callMethodOnEachRange=function(t,n){var i=[];return this.eachRange(function(e){i.push(e[t].apply(e,n||[]))}),i},G.setStart=ie(!0),G.setEnd=ie(!1),u.rangePrototype.select=function(e){Y(this.getDocument()).setSingleRange(this,e)},G.changeEachRange=function(t){var n=[],e=this.isBackward();this.eachRange(function(e){t(e),n.push(e)}),this.removeAllRanges(),e&&1==n.length?this.addRange(n[0],"backward"):this.setRanges(n)},G.containsNode=function(t,n){return this.eachRange(function(e){return e.containsNode(t,n)},!0)||!1},G.getBookmark=function(e){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[e])}},G.moveToBookmark=function(e){for(var t,n,i=[],r=0;t=e.rangeBookmarks[r++];)(n=u.createRange(this.win)).moveToBookmark(t),i.push(n);e.backward?this.setSingleRange(i[0],"backward"):this.setRanges(i)},G.saveRanges=function(){return{backward:this.isBackward(),ranges:this.callMethodOnEachRange("cloneRange")}},G.restoreRanges=function(e){this.removeAllRanges();for(var t,n=0;t=e.ranges[n];++n)this.addRange(t,e.backward&&0==n)},G.toHtml=function(){var t=[];return this.eachRange(function(e){t.push(a.toHtml(e))}),t.join("")},f.implementsTextRange&&(G.getNativeTextRange=function(){var e;if(e=this.docSelection){var t=e.createRange();if(W(t))return t;throw c.createError("getNativeTextRange: selection is a control selection")}if(0<this.rangeCount)return u.WrappedTextRange.rangeToTextRange(this.getRangeAt(0));throw c.createError("getNativeTextRange: selection contains no range")}),G.getName=function(){return"WrappedSelection"},G.inspect=function(){return re(this)},G.detach=function(){q(this.win,"delete"),z(this)},V.detachAll=function(){q(null,"deleteAll")},V.inspect=re,V.isDirectionBackward=v,u.Selection=V,u.selectionPrototype=G,u.addShimListener(function(e){void 0===e.getSelection&&(e.getSelection=function(){return Y(e)}),e=null})});function I(e){B||(B=!0,!y.initialized&&y.config.autoInitialize&&w())}var B=!1;return N&&("complete"==document.readyState?I():(d(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",I,!1),C(window,"load",I))),y},this),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),"indexOf"in Array.prototype||(Array.prototype.indexOf=function(e,t){void 0===t&&(t=0),t<0&&(t+=this.length),t<0&&(t=0);for(var n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1}),"lastIndexOf"in Array.prototype||(Array.prototype.lastIndexOf=function(e,t){for(void 0===t&&(t=this.length-1),t<0&&(t+=this.length),t>this.length-1&&(t=this.length-1),t++;0<t--;)if(t in this&&this[t]===e)return t;return-1}),"map"in Array.prototype||(Array.prototype.map=function(e,t){for(var n=new Array(this.length),i=0,r=this.length;i<r;i++)i in this&&(n[i]=e.call(t,this[i],i,this));return n}),"filter"in Array.prototype||(Array.prototype.filter=function(e,t){for(var n,i=[],r=0,o=this.length;r<o;r++)r in this&&e.call(t,n=this[r],r,this)&&i.push(n);return i}),function(){var t={changeIdAttribute:"data-cid",userIdAttribute:"data-userid",userNameAttribute:"data-username",timeAttribute:"data-time",attrValuePrefix:"",blockEl:"p",blockEls:["p","ol","ul","li","h1","h2","h3","h4","h5","h6","blockquote"],stylePrefix:"cts",currentUser:{id:null,name:null},changeTypes:{insertType:{tag:"span",alias:"ins",action:"Inserted"},deleteType:{tag:"span",alias:"del",action:"Deleted"}},handleEvents:!1,contentEditable:!0,isTracking:!0,noTrack:".ice-no-track",avoid:".ice-avoid",mergeBlocks:!0},e=function(e){if(this._changes={},!(e=e||{}).element)throw Error("`options.element` must be defined for ice construction.");ice.dom.extend(!0,this,t,e),this.pluginsManager=new ice.IcePluginManager(this),e.plugins&&this.pluginsManager.usePlugins("ice-init",e.plugins)};e.prototype={_userStyles:{},_styles:{},_uniqueStyleIndex:0,_browserType:null,_batchChangeid:null,_uniqueIDIndex:1,_delBookmark:"tempdel",isPlaceHoldingDeletes:!1,startTracking:function(){var t;return this.element.setAttribute("contentEditable",this.contentEditable),this.handleEvents&&(t=this,ice.dom.bind(t.element,"keyup.ice keydown.ice keypress.ice mousedown.ice mouseup.ice",function(e){return t.handleEvent(e)})),this.initializeEnvironment(),this.initializeEditor(),this.findTrackTags(),this.initializeRange(),this.pluginsManager.fireEnabled(this.element),this},stopTracking:function(){return this.element.setAttribute("contentEditable",!this.contentEditable),this.handleEvents&&ice.dom.unbind(this.element,"keyup.ice keydown.ice keypress.ice mousedown.ice mouseup.ice"),this.pluginsManager.fireDisabled(this.element),this},initializeEnvironment:function(){this.env||(this.env={}),this.env.element=this.element,this.env.document=this.element.ownerDocument,this.env.window=this.env.document.defaultView||this.env.document.parentWindow||window,this.env.frame=this.env.window.frameElement,this.env.selection=this.selection=new ice.Selection(this.env),this.env.document.createElement(this.changeTypes.insertType.tag),this.env.document.createElement(this.changeTypes.deleteType.tag)},initializeRange:function(){var e=this.selection.createRange();e.setStart(ice.dom.find(this.element,this.blockEls.join(", "))[0],0),e.collapse(!0),this.selection.addRange(e),this.env.frame?this.env.frame.contentWindow.focus():this.element.focus()},initializeEditor:function(){var e=this.env.document.createElement("div");this.element.childNodes.length?(e.innerHTML=this.element.innerHTML,ice.dom.removeWhitespace(e),""===e.innerHTML&&e.appendChild(ice.dom.create("<"+this.blockEl+" ><br/></"+this.blockEl+">"))):e.appendChild(ice.dom.create("<"+this.blockEl+" ><br/></"+this.blockEl+">")),this.element.innerHTML!=e.innerHTML&&(this.element.innerHTML=e.innerHTML)},findTrackTags:function(){var l=this,d=[];for(var e in this.changeTypes)d.push(this._getIceNodeClass(e));ice.dom.each(ice.dom.find(this.element,"."+d.join(", .")),function(e,t){for(var n=0,i="",r=t.className.split(" "),e=0;e<r.length;e++){var o=new RegExp(l.stylePrefix+"-(\\d+)").exec(r[e]);o&&(n=o[1]);var s=new RegExp("("+d.join("|")+")").exec(r[e]);s&&(i=l._getChangeTypeFromAlias(s[1]))}var a=ice.dom.attr(t,l.userIdAttribute);l.setUserStyle(a,Number(n));var c=ice.dom.attr(t,l.changeIdAttribute);l._changes[c]={type:i,userid:a,username:ice.dom.attr(t,l.userNameAttribute),time:ice.dom.attr(t,l.timeAttribute)}})},enableChangeTracking:function(){this.isTracking=!0,this.pluginsManager.fireEnabled(this.element)},disableChangeTracking:function(){this.isTracking=!1,this.pluginsManager.fireDisabled(this.element)},setCurrentUser:function(e){this.currentUser=e},handleEvent:function(e){if(this.isTracking)if("mouseup"==e.type){var t=this;setTimeout(function(){t.mouseUp(e)},200)}else{if("mousedown"==e.type)return this.mouseDown(e);var n;if("keypress"==e.type)return(n=this.keyPress(e))||e.preventDefault(),n;if("keydown"==e.type)return(n=this.keyDown(e))||e.preventDefault(),n;"keyup"==e.type&&this.pluginsManager.fireCaretUpdated()}},visible:function(e){e.nodeType===ice.dom.TEXT_NODE&&(e=e.parentNode);var t=e.getBoundingClientRect();return 0<t.top&&0<t.left},createIceNode:function(e,t){var n=this.env.document.createElement(this.changeTypes[e].tag);return ice.dom.addClass(n,this._getIceNodeClass(e)),n.appendChild(t||this.env.document.createTextNode("")),this.addChange(this.changeTypes[e].alias,[n]),this.pluginsManager.fireNodeCreated(n,{action:this.changeTypes[e].action}),n},insert:function(e,t){var n,i=!e;e=e||"\ufeff",t?this.selection.addRange(t):t=this.getCurrentRange(),"string"==typeof e&&(e=document.createTextNode(e)),t.collapsed||(this.deleteContents(),(t=this.getCurrentRange()).startContainer===t.endContainer&&this.element===t.startContainer&&(ice.dom.empty(this.element),n=t.getLastSelectableChild(this.element),t.setStartAfter(n),t.collapse(!0))),this._moveRangeToValidTrackingPos(t);var r=this.startBatchChange();return this._insertNode(e,t,i),this.pluginsManager.fireNodeInserted(e,t),this.endBatchChange(r),i},placeholdDeletes:function(){var n=this;this.isPlaceholdingDeletes&&this.revertDeletePlaceholders(),this.isPlaceholdingDeletes=!0,this._deletes=[];var e="."+this._getIceNodeClass("deleteType");return ice.dom.each(ice.dom.find(this.element,e),function(e,t){n._deletes.push(ice.dom.cloneNode(t)),ice.dom.replaceWith(t,"<"+n._delBookmark+' data-allocation="'+(n._deletes.length-1)+'"/>')}),!0},revertDeletePlaceholders:function(){var n=this;return!!this.isPlaceholdingDeletes&&(ice.dom.each(this._deletes,function(e,t){ice.dom.find(n.element,n._delBookmark+"[data-allocation="+e+"]").replaceWith(t)}),!(this.isPlaceholdingDeletes=!1))},deleteContents:function(e,t){var n=!0,i=ice.dom.browser();t?this.selection.addRange(t):t=this.getCurrentRange();var r=this.startBatchChange(this.changeTypes.deleteType.alias);if(!1===t.collapsed)this._currentUserIceNode(t.startContainer.parentNode)?this._deleteSelection(t):(this._deleteSelection(t),"mozilla"===i.type?(t.startContainer.parentNode.previousSibling?(t.setEnd(t.startContainer.parentNode.previousSibling,0),t.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(t.endContainer))):t.setEndAfter(t.startContainer.parentNode),t.collapse(!1)):this.visible(t.endContainer)||(t.setEnd(t.endContainer,t.endOffset-1),t.collapse(!1)));else if(e)if("mozilla"===i.type)n=this._deleteRight(t),this.visible(t.endContainer)||(t.endContainer.parentNode.nextSibling?t.setEndBefore(t.endContainer.parentNode.nextSibling):t.setEndAfter(t.endContainer),t.collapse(!1));else{if(t.endOffset===ice.dom.getNodeCharacterLength(t.endContainer)){var o=t.startContainer.nextSibling;if(ice.dom.is(o,"."+this._getIceNodeClass("deleteType")))for(;o;){if(!ice.dom.is(o,"."+this._getIceNodeClass("deleteType"))){t.setStart(o,0),t.collapse(!0);break}o=o.nextSibling}}n=this._deleteRight(t),this.visible(t.endContainer)||ice.dom.is(t.endContainer.parentNode,"."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"))&&(t.setStartAfter(t.endContainer.parentNode),t.collapse(!0))}else if("mozilla"===i.type)n=this._deleteLeft(t),this.visible(t.startContainer)||(t.startContainer.parentNode.previousSibling?t.setEnd(t.startContainer.parentNode.previousSibling,0):t.setEnd(t.startContainer.parentNode,0),t.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(t.endContainer)),t.collapse(!1));else{if(!this.visible(t.startContainer)&&t.endOffset===ice.dom.getNodeCharacterLength(t.endContainer)){var s=t.startContainer.previousSibling;if(ice.dom.is(s,"."+this._getIceNodeClass("deleteType")))for(;s;){if(!ice.dom.is(s,"."+this._getIceNodeClass("deleteType"))){t.setEndBefore(s.nextSibling,0),t.collapse(!1);break}s=s.prevSibling}}n=this._deleteLeft(t)}return this.selection.addRange(t),this.endBatchChange(r),n},getChanges:function(){return this._changes},getChangeUserids:function(){var e=[],t=Object.keys(this._changes);for(var n in t)e.push(this._changes[t[n]].userid);return e.sort().filter(function(e,t,n){return t==n.indexOf(e)?1:0})},getElementContent:function(){return this.element.innerHTML},getCleanContent:function(e,t,n){var i="",r=this;ice.dom.each(this.changeTypes,function(e,t){"deleteType"!=e&&(0<t&&(i+=","),i+="."+r._getIceNodeClass(e))}),e=e?"string"==typeof e?ice.dom.create("<div>"+e+"</div>"):ice.dom.cloneNode(e,!1)[0]:ice.dom.cloneNode(this.element,!1)[0],e=n?n.call(this,e):e;var o=ice.dom.find(e,i);ice.dom.each(o,function(e,t){ice.dom.replaceWith(this,ice.dom.contents(this))});var s=ice.dom.find(e,"."+this._getIceNodeClass("deleteType"));return ice.dom.remove(s),(e=t?t.call(this,e):e).innerHTML},acceptAll:function(){this.element.innerHTML=this.getCleanContent()},rejectAll:function(){var e="."+this._getIceNodeClass("insertType"),t="."+this._getIceNodeClass("deleteType");ice.dom.remove(ice.dom.find(this.element,e)),ice.dom.each(ice.dom.find(this.element,t),function(e,t){ice.dom.replaceWith(t,ice.dom.contents(t))})},acceptChange:function(e){this.acceptRejectChange(e,!0)},rejectChange:function(e){this.acceptRejectChange(e,!1)},acceptRejectChange:function(e,t){var n,i,r,o,s,a,c,l=ice.dom;if(!e){var d=this.getCurrentRange();if(!d.collapsed)return;e=d.startContainer}r=(n=o="."+this._getIceNodeClass("deleteType"))+","+(i=s="."+this._getIceNodeClass("insertType")),a=l.getNode(e,r),c=l.find(this.element,"["+this.changeIdAttribute+"="+l.attr(a,this.changeIdAttribute)+"]"),t||(o=i,s=n),ice.dom.is(a,s)?l.each(c,function(e,t){l.replaceWith(t,ice.dom.contents(t))}):l.is(a,o)&&l.remove(c)},isInsideChange:function(e){var t="."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType");if(!e){if(range=this.getCurrentRange(),!range.collapsed)return!1;e=range.startContainer}return!!ice.dom.getNode(e,t)},addChangeType:function(e,t,n,i){var r={tag:t,alias:n};i&&(r.action=i),this.changeTypes[e]=r},getIceNode:function(e,t){var n="."+this._getIceNodeClass(t);return ice.dom.getNode(e,n)},_moveRangeToValidTrackingPos:function(e){for(var t=!1,n=this._getVoidElement(e.endContainer);n;){try{e.moveEnd(ice.dom.CHARACTER_UNIT,1),e.moveEnd(ice.dom.CHARACTER_UNIT,-1)}catch(e){t=!0}if(t||ice.dom.onBlockBoundary(e.endContainer,e.startContainer,this.blockEls)){e.setStartAfter(n),e.collapse(!0);break}(n=this._getVoidElement(e.endContainer))?(e.setEnd(e.endContainer,0),e.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(e.endContainer)),e.collapse()):(e.setStart(e.endContainer,0),e.collapse(!0))}},_getNoTrackElement:function(e){var t=this._getNoTrackSelector();return ice.dom.is(e,t)?e:ice.dom.parents(e,t)[0]||null},_getNoTrackSelector:function(){return this.noTrack},_getVoidElement:function(e){var t=this._getVoidElSelector();return ice.dom.is(e,t)?e:ice.dom.parents(e,t)[0]||null},_getVoidElSelector:function(){return"."+this._getIceNodeClass("deleteType")+","+this.avoid},_currentUserIceNode:function(e){return ice.dom.attr(e,this.userIdAttribute)==this.currentUser.id},_getChangeTypeFromAlias:function(e){var t,n=null;for(t in this.changeTypes)this.changeTypes.hasOwnProperty(t)&&this.changeTypes[t].alias==e&&(n=t);return n},_getIceNodeClass:function(e){return this.attrValuePrefix+this.changeTypes[e].alias},getUserStyle:function(e){return this._userStyles[e]?this._userStyles[e]:this.setUserStyle(e,this.getNewStyleId())},setUserStyle:function(e,t){var n=this.stylePrefix+"-"+t;return this._styles[t]||(this._styles[t]=!0),this._userStyles[e]=n},getNewStyleId:function(){var e=++this._uniqueStyleIndex;return this._styles[e]?this.getNewStyleId():(this._styles[e]=!0,e)},addChange:function(e,t){var n=this._batchChangeid||this.getNewChangeId();this._changes[n]||(this._changes[n]={type:this._getChangeTypeFromAlias(e),time:(new Date).getTime(),userid:this.currentUser.id,username:this.currentUser.name});var i=this;return ice.dom.foreach(t,function(e){i.addNodeToChange(n,t[e])}),n},addNodeToChange:function(e,t){null!==this._batchChangeid&&(e=this._batchChangeid);var n=this.getChange(e);t.getAttribute(this.changeIdAttribute)||t.setAttribute(this.changeIdAttribute,e),t.getAttribute(this.userIdAttribute)||t.setAttribute(this.userIdAttribute,n.userid),t.getAttribute(this.userNameAttribute)||t.setAttribute(this.userNameAttribute,n.username),t.getAttribute(this.timeAttribute)||t.setAttribute(this.timeAttribute,n.time),ice.dom.hasClass(t,this._getIceNodeClass(n.type))||ice.dom.addClass(t,this._getIceNodeClass(n.type));var i=this.getUserStyle(n.userid);ice.dom.hasClass(t,i)||ice.dom.addClass(t,i)},getChange:function(e){var t=null;return this._changes[e]&&(t=this._changes[e]),t},getNewChangeId:function(){var e=++this._uniqueIDIndex;return this._changes[e]&&(e=this.getNewChangeId()),e},startBatchChange:function(){return this._batchChangeid=this.getNewChangeId(),this._batchChangeid},endBatchChange:function(e){e===this._batchChangeid&&(this._batchChangeid=null)},getCurrentRange:function(){return this.selection.getRangeAt(0)},_insertNode:function(e,t,n){ice.dom.isBlockElement(t.startContainer)||ice.dom.canContainTextElement(ice.dom.getBlockParent(t.startContainer,this.element))||!t.startContainer.previousSibling||t.setStart(t.startContainer.previousSibling,0);t.startContainer;var i=ice.dom.isBlockElement(t.startContainer)&&t.startContainer||ice.dom.getBlockParent(t.startContainer,this.element)||null;if(i===this.element){var r=document.createElement(this.blockEl);return i.appendChild(r),t.setStart(r,0),t.collapse(),this._insertNode(e,t,n)}ice.dom.hasNoTextOrStubContent(i)&&(ice.dom.empty(i),ice.dom.append(i,"<br>"),t.setStart(i,0));var o=this.getIceNode(t.startContainer,"insertType"),s=this._currentUserIceNode(o);n&&s||(s||(e=this.createIceNode("insertType",e)),t.insertNode(e),t.setEnd(e,1),n?t.setStart(e,0):t.collapse(),this.selection.addRange(t))},_handleVoidEl:function(e,t){var n=this._getVoidElement(e);return!(!n||this.getIceNode(n,"deleteType"))&&(t.collapse(!0),!0)},_deleteSelection:function(e){for(var t=new ice.Bookmark(this.env,e),n=ice.dom.getElementsBetween(t.start,t.end),i=ice.dom.parents(e.startContainer,this.blockEls.join(", "))[0],r=ice.dom.parents(e.endContainer,this.blockEls.join(", "))[0],o=new Array,s=0;s<n.length;s++){var a=n[s];if(!ice.dom.isBlockElement(a)||(o.push(a),ice.dom.canContainTextElement(a))){if((a.nodeType!==ice.dom.TEXT_NODE||0!==ice.dom.getNodeTextContent(a).length)&&!this._getVoidElement(a)){if(a.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.BREAK_ELEMENT==ice.dom.getTagName(a))continue;if(ice.dom.isStubElement(a)){this._addNodeTracking(a,!1,!0);continue}for(ice.dom.hasNoTextOrStubContent(a)&&ice.dom.remove(a),j=0;j<a.childNodes.length;j++){var c=a.childNodes[j];n.push(c)}continue}var l=ice.dom.getBlockParent(a);this._addNodeTracking(a,!1,!0,!0),ice.dom.hasNoTextOrStubContent(l)&&ice.dom.remove(l)}}else for(var d=0;d<a.childNodes.length;d++)n.push(a.childNodes[d])}if(this.mergeBlocks&&i!==r){for(;o.length;)ice.dom.mergeContainers(o.shift(),i);ice.dom.removeBRFromChild(r),ice.dom.removeBRFromChild(i),ice.dom.mergeContainers(r,i)}t.selectBookmark(),e.collapse(!0)},_deleteRight:function(e){var t,n,i=ice.dom.isBlockElement(e.startContainer)&&e.startContainer||ice.dom.getBlockParent(e.startContainer,this.element)||null,r=!!i&&ice.dom.hasNoTextOrStubContent(i),o=i&&ice.dom.getNextContentNode(i,this.element),s=!!o&&ice.dom.hasNoTextOrStubContent(o),a=e.endContainer,c=e.endOffset,l=e.commonAncestorContainer;if(r)return!1;if(l.nodeType!==ice.dom.TEXT_NODE){if(0===c&&ice.dom.isBlockElement(l)&&!ice.dom.canContainTextElement(l)){var d=l.firstElementChild;if(d)return e.setStart(d,0),e.collapse(),this._deleteRight(e)}if(l.childNodes.length>c){var u=document.createTextNode(" ");return l.insertBefore(u,l.childNodes[c]),e.setStart(u,1),e.collapse(!0),n=this._deleteRight(e),ice.dom.remove(u),n}return t=ice.dom.getNextContentNode(l,this.element),e.setEnd(t,0),e.collapse(),this._deleteRight(e)}if(e.moveEnd(ice.dom.CHARACTER_UNIT,1),e.moveEnd(ice.dom.CHARACTER_UNIT,-1),c===a.data.length&&!ice.dom.hasNoTextOrStubContent(a)){if(!(t=ice.dom.getNextNode(a,this.element)))return e.selectNodeContents(a),e.collapse(),!1;if(ice.dom.BREAK_ELEMENT==ice.dom.getTagName(t)&&(t=ice.dom.getNextNode(t,this.element)),t.nodeType===ice.dom.TEXT_NODE&&(t=t.parentNode),!t.isContentEditable){n=this._addNodeTracking(t,!1,!1);var h=document.createTextNode("");return t.parentNode.insertBefore(h,t.nextSibling),e.selectNode(h),e.collapse(!0),n}if(this._handleVoidEl(t,e))return!0;if(ice.dom.isChildOf(t,i)&&ice.dom.isStubElement(t))return this._addNodeTracking(t,e,!1)}if(this._handleVoidEl(t,e))return!0;if(this._getNoTrackElement(e.endContainer.parentElement))return e.deleteContents(),!1;if(ice.dom.isOnBlockBoundary(e.startContainer,e.endContainer,this.element)){if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(t,this.element),this.blockEl)){o!==ice.dom.getBlockParent(e.endContainer,this.element)&&e.setEnd(o,0);for(var f=ice.dom.getElementsBetween(e.startContainer,e.endContainer),g=0;g<f.length;g++)ice.dom.remove(f[g]);var m=e.startContainer,p=e.endContainer;return ice.dom.remove(ice.dom.find(m,"br")),ice.dom.remove(ice.dom.find(p,"br")),ice.dom.mergeBlockWithSibling(e,ice.dom.getBlockParent(e.endContainer,this.element)||i)}return s?ice.dom.remove(o):e.setStart(o,0),e.collapse(!0),!0}var C=e.endContainer.splitText(e.endOffset);C.splitText(1);return this._addNodeTracking(C,e,!1)},_deleteLeft:function(e){var t,n,i=ice.dom.isBlockElement(e.startContainer)&&e.startContainer||ice.dom.getBlockParent(e.startContainer,this.element)||null,r=!!i&&ice.dom.hasNoTextOrStubContent(i),o=i&&ice.dom.getPrevContentNode(i,this.element),s=!!o&&ice.dom.hasNoTextOrStubContent(o),a=e.startContainer,c=e.startOffset,l=e.commonAncestorContainer;if(r)return!1;if(0===c||l.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.isBlockElement(l)&&!ice.dom.canContainTextElement(l))if(0===c){var d=l.firstElementChild;if(d)return e.setStart(d,0),e.collapse(),this._deleteLeft(e)}else{var u=l.lastElementChild;if(u&&(t=e.getLastSelectableChild(u)))return e.setStart(t,t.data.length),e.collapse(),this._deleteLeft(e)}if(!(n=0===c?ice.dom.getPrevContentNode(a,this.element):l.childNodes[c-1]))return!1;if(ice.dom.is(n,"."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"))&&0<n.childNodes.length&&n.lastChild&&(n=n.lastChild),n.nodeType===ice.dom.TEXT_NODE&&(n=n.parentNode),!n.isContentEditable){var h=this._addNodeTracking(n,!1,!0),f=document.createTextNode("");return n.parentNode.insertBefore(f,n),e.selectNode(f),e.collapse(!0),h}if(this._handleVoidEl(n,e))return!0;if(ice.dom.isStubElement(n)&&ice.dom.isChildOf(n,i)||!n.isContentEditable)return this._addNodeTracking(n,e,!0);if(ice.dom.isStubElement(n))return ice.dom.remove(n),e.collapse(!0),!1;if(n!==i&&!ice.dom.isChildOf(n,i)){if(ice.dom.canContainTextElement(n)||(n=n.lastElementChild),n.lastChild&&n.lastChild.nodeType!==ice.dom.TEXT_NODE&&ice.dom.isStubElement(n.lastChild)&&"BR"!==n.lastChild.tagName)return e.setStartAfter(n.lastChild),e.collapse(!0),!0;if((t=e.getLastSelectableChild(n))&&!ice.dom.isOnBlockBoundary(e.startContainer,t,this.element))return e.selectNodeContents(t),e.collapse(),!0}}if(1===c&&!ice.dom.isBlockElement(l)&&1<e.startContainer.childNodes.length&&e.startContainer.childNodes[0].nodeType===ice.dom.TEXT_NODE&&0===e.startContainer.childNodes[0].data.length)return e.setStart(e.startContainer,0),this._deleteLeft(e);if(e.moveStart(ice.dom.CHARACTER_UNIT,-1),e.moveStart(ice.dom.CHARACTER_UNIT,1),this._getNoTrackElement(e.startContainer.parentElement))return e.deleteContents(),!1;if(ice.dom.isOnBlockBoundary(e.startContainer,e.endContainer,this.element)){if(s)return ice.dom.remove(o),e.collapse(),!0;if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(n,this.element),this.blockEl)){o!==ice.dom.getBlockParent(e.startContainer,this.element)&&e.setStart(o,o.childNodes.length);for(var g=ice.dom.getElementsBetween(e.startContainer,e.endContainer),m=0;m<g.length;m++)ice.dom.remove(g[m]);var p=e.startContainer,C=e.endContainer;return ice.dom.remove(ice.dom.find(p,"br")),ice.dom.remove(ice.dom.find(C,"br")),ice.dom.mergeBlockWithSibling(e,ice.dom.getBlockParent(e.endContainer,this.element)||i)}return o&&o.lastChild&&ice.dom.isStubElement(o.lastChild)?(e.setStartAfter(o.lastChild),e.collapse(!0),!0):((t=e.getLastSelectableChild(o))?(e.setStart(t,t.data.length),e.collapse(!0)):o&&(e.setStart(o,o.childNodes.length),e.collapse(!0)),!0)}var v=e.startContainer.splitText(e.startOffset-1);v.splitText(1);return this._addNodeTracking(v,e,!0)},_addNodeTracking:function(e,t,n){var i=this.getIceNode(e,"insertType");if(i&&this._currentUserIceNode(i)){t&&n&&t.selectNode(e),e.parentNode.removeChild(e);var r,o=ice.dom.cloneNode(i);return ice.dom.remove(ice.dom.find(o,".iceBookmark")),null!==i&&ice.dom.hasNoTextOrStubContent(o[0])&&(r=this.env.document.createTextNode(""),ice.dom.insertBefore(i,r),t&&(t.setStart(r,0),t.collapse(!0)),ice.dom.replaceWith(i,ice.dom.contents(i))),!0}if(t&&this.getIceNode(e,"deleteType")){e.normalize();var s=!1;if(n){for(var a,c=ice.dom.getPrevContentNode(e,this.element);!s;)(u=this.getIceNode(c,"deleteType"))?c=ice.dom.getPrevContentNode(c,this.element):s=!0;return c&&((a=t.getLastSelectableChild(c))&&(c=a),t.setStart(c,ice.dom.getNodeCharacterLength(c)),t.collapse(!0)),!0}for(var l=ice.dom.getNextContentNode(e,this.element);!s;)(u=this.getIceNode(l,"deleteType"))?l=ice.dom.getNextContentNode(l,this.element):s=!0;return l&&(t.selectNodeContents(l),t.collapse(!0)),!0}e.previousSibling&&e.previousSibling.nodeType===ice.dom.TEXT_NODE&&0===e.previousSibling.length&&e.parentNode.removeChild(e.previousSibling),e.nextSibling&&e.nextSibling.nodeType===ice.dom.TEXT_NODE&&0===e.nextSibling.length&&e.parentNode.removeChild(e.nextSibling);var d,u,h=this.getIceNode(e.previousSibling,"deleteType"),f=this.getIceNode(e.nextSibling,"deleteType");return h&&this._currentUserIceNode(h)?((u=h).appendChild(e),f&&this._currentUserIceNode(f)&&(d=ice.dom.extractContent(f),ice.dom.append(u,d),f.parentNode.removeChild(f))):f&&this._currentUserIceNode(f)?(u=f).insertBefore(e,u.firstChild):(u=this.createIceNode("deleteType"),e.parentNode.insertBefore(u,e),u.appendChild(e)),t&&(ice.dom.isStubElement(e)?t.selectNode(e):t.selectNodeContents(e),n?t.collapse(!0):t.collapse(),e.normalize()),!0},_handleAncillaryKey:function(e){var t=e.keyCode?e.keyCode:e.which,n=ice.dom.browser(),i=!0,r=(e.shiftKey,this.getCurrentRange());switch(t){case ice.dom.DOM_VK_DELETE:i=this.deleteContents(),this.pluginsManager.fireKeyPressed(e);break;case 46:i=this.deleteContents(!0),this.pluginsManager.fireKeyPressed(e);break;case ice.dom.DOM_VK_DOWN:case ice.dom.DOM_VK_UP:case ice.dom.DOM_VK_LEFT:this.pluginsManager.fireCaretPositioned(),"mozilla"===n.type&&(this.visible(r.startContainer)||(r.startContainer.parentNode.previousSibling?(r.setEnd(r.startContainer.parentNode.previousSibling,0),r.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(r.endContainer))):r.setEnd(r.startContainer.parentNode.nextSibling,0),r.collapse(!1))),i=!1;break;case ice.dom.DOM_VK_RIGHT:this.pluginsManager.fireCaretPositioned(),"mozilla"===n.type&&(this.visible(r.startContainer)||r.startContainer.parentNode.nextSibling&&(r.setStart(r.startContainer.parentNode.nextSibling,0),r.collapse(!0))),i=!1;break;case 32:i=!0;r=this.getCurrentRange();this._moveRangeToValidTrackingPos(r,r.startContainer),this.insert(" ",r);break;default:i=!1}return!0!==i||(ice.dom.preventDefault(e),!1)},keyDown:function(e){if(!this.pluginsManager.fireKeyDown(e))return ice.dom.preventDefault(e),!1;var t=!1;if(!1===this._handleSpecialKey(e))return!0!==ice.dom.isBrowser("msie")&&(this._preventKeyPress=!0),!1;if(!(!0!==e.ctrlKey&&!0!==e.metaKey||!0!==ice.dom.isBrowser("msie")&&!0!==ice.dom.isBrowser("chrome")||this.pluginsManager.fireKeyPressed(e)))return!1;switch(e.keyCode){case 27:break;default:!0!==/Firefox/.test(navigator.userAgent)&&(t=!this._handleAncillaryKey(e))}return!t||(ice.dom.preventDefault(e),!1)},keyPress:function(e){if(!0!==this._preventKeyPress){if(!this.pluginsManager.fireKeyPress(e))return!1;var t=null;null==e.which?t=String.fromCharCode(e.keyCode):0<e.which&&(t=String.fromCharCode(e.which));var n=this.getCurrentRange(),i=ice.dom.parents(n.startContainer,"br")[0]||null;if(i&&(n.moveToNextEl(i),i.parentNode.removeChild(i)),null!==t&&!0!==e.ctrlKey&&!0!==e.metaKey)switch(e.keyCode?e.keyCode:e.which){case ice.dom.DOM_VK_DELETE:return this._handleAncillaryKey(e);case ice.dom.DOM_VK_ENTER:return this._handleEnter();case 32:return this._handleAncillaryKey(e);default:return this._moveRangeToValidTrackingPos(n,n.startContainer),this.insert()}return this._handleAncillaryKey(e)}this._preventKeyPress=!1},_handleEnter:function(){return this.getCurrentRange().collapsed||this.deleteContents(),!0},_handleSpecialKey:function(e){var t=e.which;null===t&&(t=e.keyCode);var n,i,r,o,s=!1;switch(t){case 65:!0!==e.ctrlKey&&!0!==e.metaKey||(s=!0,n=this.getCurrentRange(),!0===ice.dom.isBrowser("msie")?(i=this.env.document.createTextNode(""),r=this.env.document.createTextNode(""),this.element.firstChild?ice.dom.insertBefore(this.element.firstChild,i):this.element.appendChild(i),this.element.appendChild(r),n.setStart(i,0),n.setEnd(r,0)):(n.setStart(n.getFirstSelectableChild(this.element),0),o=n.getLastSelectableChild(this.element),n.setEnd(o,o.length)),this.selection.addRange(n))}return!0!==s||(ice.dom.preventDefault(e),!1)},mouseUp:function(e,t){if(!this.pluginsManager.fireClicked(e))return!1;this.pluginsManager.fireSelectionChanged(this.getCurrentRange())},mouseDown:function(e,t){if(!this.pluginsManager.fireMouseDown(e))return!1;this.pluginsManager.fireCaretUpdated()}},this.ice=this.ice||{},this.ice.InlineChangeEditor=e}.call(this),function(){var i=null,h={DOM_VK_DELETE:8,DOM_VK_LEFT:37,DOM_VK_UP:38,DOM_VK_RIGHT:39,DOM_VK_DOWN:40,DOM_VK_ENTER:13,ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12,CHARACTER_UNIT:"character",WORD_UNIT:"word",BREAK_ELEMENT:"br",CONTENT_STUB_ELEMENTS:["img","hr","iframe","param","link","meta","input","frame","col","base","area"],BLOCK_ELEMENTS:["p","div","pre","ul","ol","li","table","tbody","td","th","fieldset","form","blockquote","dl","dt","dd","dir","center","address","h1","h2","h3","h4","h5","h6"],TEXT_CONTAINER_ELEMENTS:["p","div","pre","li","td","th","blockquote","dt","dd","center","address","h1","h2","h3","h4","h5","h6"]};h.STUB_ELEMENTS=h.CONTENT_STUB_ELEMENTS.slice(),h.STUB_ELEMENTS.push(h.BREAK_ELEMENT),h.getKeyChar=function(e){return String.fromCharCode(e.which)},h.getClass=function(e,t,n){return t=t||document.body,e="."+e.split(" ").join("."),n&&(e=n+e),jQuery.makeArray(jQuery(t).find(e))},h.getId=function(e,t){return t=t||document,element=t.getElementById(e),element},h.getTag=function(e,t){return t=t||document,jQuery.makeArray(jQuery(t).find(e))},h.getElementWidth=function(e){return e.offsetWidth},h.getElementHeight=function(e){return e.offsetHeight},h.getElementDimensions=function(e){return{width:h.getElementWidth(e),height:h.getElementHeight(e)}},h.trim=function(e){return jQuery.trim(e)},h.empty=function(e){if(e)return jQuery(e).empty()},h.remove=function(e){if(e)return jQuery(e).remove()},h.prepend=function(e,t){jQuery(e).prepend(t)},h.append=function(e,t){jQuery(e).append(t)},h.insertBefore=function(e,t){jQuery(e).before(t)},h.insertAfter=function(e,t){jQuery(e).after(t)},h.getHtml=function(e){return jQuery(e).html()},h.setHtml=function(e,t){e&&jQuery(e).html(t)},h.removeWhitespace=function(e){jQuery(e).contents().filter(function(){return this.nodeType!=ice.dom.TEXT_NODE&&"UL"==this.nodeName||"OL"==this.nodeName?(h.removeWhitespace(this),!1):this.nodeType==ice.dom.TEXT_NODE&&!/\S/.test(this.nodeValue)}).remove()},h.contents=function(e){return jQuery.makeArray(jQuery(e).contents())},h.extractContent=function(e){for(var t,n=document.createDocumentFragment();t=e.firstChild;)n.appendChild(t);return n},h.getNode=function(e,t){return h.is(e,t)?e:h.parents(e,t)[0]||null},h.getParents=function(e,t,n){for(var i=jQuery(e).parents(t),r=i.length,o=[],s=0;s<r&&i[s]!==n;s++)o.push(i[s]);return o},h.hasBlockChildren=function(e){for(var t=e.childNodes.length,n=0;n<t;n++)if(e.childNodes[n].nodeType===h.ELEMENT_NODE&&!0===h.isBlockElement(e.childNodes[n]))return!0;return!1},h.removeTag=function(e,t){return jQuery(e).find(t).replaceWith(function(){return jQuery(this).contents()}),e},h.stripEnclosingTags=function(e,t){var n=jQuery(e);return n.find("*").not(t).replaceWith(function(){var e,t=jQuery();try{t=(e=jQuery(this)).contents()}catch(e){}return 0===t.length&&e.remove(),t}),n[0]},h.getSiblings=function(e,t,n,i){if(!0===n)return"prev"===t?jQuery(e).prevAll():jQuery(e).nextAll();var r=[];if("prev"===t)for(;e.previousSibling&&(e=e.previousSibling)!==i;)r.push(e);else for(;e.nextSibling&&(e=e.nextSibling)!==i;)r.push(e);return r},h.getNodeTextContent=function(e){return jQuery(e).text()},h.getNodeStubContent=function(e){return jQuery(e).find(h.CONTENT_STUB_ELEMENTS.join(", "))},h.hasNoTextOrStubContent=function(e){return!(0<h.getNodeTextContent(e).length)&&!(0<jQuery(e).find(h.CONTENT_STUB_ELEMENTS.join(", ")).length)},h.getNodeCharacterLength=function(e){return h.getNodeTextContent(e).length+jQuery(e).find(h.STUB_ELEMENTS.join(", ")).length},h.setNodeTextContent=function(e,t){return jQuery(e).text(t)},h.getTagName=function(e){return e.tagName&&e.tagName.toLowerCase()||null},h.getIframeDocument=function(e){var t=null;return e.contentDocument?t=e.contentDocument:e.contentWindow?t=e.contentWindow.document:e.document&&(t=e.document),t},h.isBlockElement=function(e){return-1!=h.BLOCK_ELEMENTS.lastIndexOf(e.nodeName.toLowerCase())},h.isStubElement=function(e){return-1!=h.STUB_ELEMENTS.lastIndexOf(e.nodeName.toLowerCase())},h.removeBRFromChild=function(e){if(e&&e.hasChildNodes())for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];n&&ice.dom.BREAK_ELEMENT==ice.dom.getTagName(n)&&n.parentNode.removeChild(n)}},h.isChildOf=function(e,t){try{for(;e&&e.parentNode;){if(e.parentNode===t)return!0;e=e.parentNode}}catch(e){}return!1},h.isChildOfTagName=function(e,t){try{for(;e&&e.parentNode;){if(e.parentNode&&e.parentNode.tagName&&e.parentNode.tagName.toLowerCase()===t)return e.parentNode;e=e.parentNode}}catch(e){}return!1},h.isChildOfTagNames=function(e,t){try{for(;e&&e.parentNode;){if(e.parentNode&&e.parentNode.tagName){tagName=e.parentNode.tagName.toLowerCase();for(var n=0;n<t.length;n++)if(tagName===t[n])return e.parentNode}e=e.parentNode}}catch(e){}return null},h.isChildOfClassName=function(e,t){try{for(;e&&e.parentNode;){if(jQuery(e.parentNode).hasClass(t))return e.parentNode;e=e.parentNode}}catch(e){}return null},h.cloneNode=function(e,t){return void 0===t&&(t=!0),jQuery(e).clone(t)},h.bind=function(e,t,n){return jQuery(e).bind(t,n)},h.unbind=function(e,t,n){return jQuery(e).unbind(t,n)},h.attr=function(e,t,n){return n?jQuery(e).attr(t,n):jQuery(e).attr(t)},h.replaceWith=function(e,t){return jQuery(e).replaceWith(t)},h.removeAttr=function(e,t){jQuery(e).removeAttr(t)},h.getElementsBetween=function(e,t){var n=[];if(e===t)return n;if(!0===h.isChildOf(t,e)){for(var i=e.childNodes.length,r=0;r<i&&e.childNodes[r]!==t;r++){if(!0===h.isChildOf(t,e.childNodes[r]))return h.arrayMerge(n,h.getElementsBetween(e.childNodes[r],t));n.push(e.childNodes[r])}return n}for(var o=e.nextSibling;o;){if(!0===h.isChildOf(t,o))return n=h.arrayMerge(n,h.getElementsBetween(o,t));if(o===t)return n;n.push(o),o=o.nextSibling}for(var s=h.getParents(e),a=h.getParents(t),c=h.arrayDiff(s,a,!0),l=c.length,d=0;d<l-1;d++)n=h.arrayMerge(n,h.getSiblings(c[d],"next"));var u=c[c.length-1];return n=h.arrayMerge(n,h.getElementsBetween(u,t))},h.getCommonAncestor=function(e,t){for(var n=e;n;){if(!0===h.isChildOf(t,n))return n;n=n.parentNode}return null},h.getNextNode=function(e,t){if(e)for(;e.parentNode;){if(e===t)return null;if(e.nextSibling){if(e.nextSibling.nodeType!==h.TEXT_NODE||0!==e.nextSibling.length)return h.getFirstChild(e.nextSibling);e=e.nextSibling}else e=e.parentNode}return null},h.getNextContentNode=function(e,t){if(e)for(;e.parentNode;){if(e===t)return null;if(e.nextSibling&&h.canContainTextElement(h.getBlockParent(e))){if(e.nextSibling.nodeType!==h.TEXT_NODE||0!==e.nextSibling.length)return e.nextSibling;e=e.nextSibling}else{if(e.nextElementSibling)return e.nextElementSibling;e=e.parentNode}}return null},h.getPrevNode=function(e,t){if(e)for(;e.parentNode;){if(e===t)return null;if(e.previousSibling){if(e.previousSibling.nodeType!==h.TEXT_NODE||0!==e.previousSibling.length)return h.getLastChild(e.previousSibling);e=e.previousSibling}else e=e.parentNode}return null},h.getPrevContentNode=function(e,t){if(e)for(;e.parentNode;){if(e===t)return null;if(e.previousSibling&&h.canContainTextElement(h.getBlockParent(e))){if(e.previousSibling.nodeType!==h.TEXT_NODE||0!==e.previousSibling.length)return e.previousSibling;e=e.previousSibling}else{if(e.previousElementSibling)return e.previousElementSibling;e=e.parentNode}}return null},h.canContainTextElement=function(e){return!(!e||!e.nodeName)&&-1!=h.TEXT_CONTAINER_ELEMENTS.lastIndexOf(e.nodeName.toLowerCase())},h.getFirstChild=function(e){return e.firstChild?e.firstChild.nodeType===h.ELEMENT_NODE?h.getFirstChild(e.firstChild):e.firstChild:e},h.getLastChild=function(e){return e.lastChild?e.lastChild.nodeType===h.ELEMENT_NODE?h.getLastChild(e.lastChild):e.lastChild:e},h.removeEmptyNodes=function(e,t){for(var n=jQuery(e).find(":empty"),i=n.length;0<i;)i--,!1===h.isStubElement(n[i])&&(t&&!1===t.call(this,n[i])||h.remove(n[i]))},h.create=function(e){return jQuery(e)[0]},h.find=function(e,t){return jQuery(e).find(t)},h.children=function(e,t){return jQuery(e).children(t)},h.parent=function(e,t){return jQuery(e).parent(t)[0]},h.parents=function(e,t){return jQuery(e).parents(t)},h.is=function(e,t){return jQuery(e).is(t)},h.extend=function(e,t,n,i){return jQuery.extend.apply(this,arguments)},h.walk=function(e,t,n){e&&(n=n||0,!1!==t.call(this,e,n)&&(e.childNodes&&0<e.childNodes.length?h.walk(e.firstChild,t,n+1):e.nextSibling?h.walk(e.nextSibling,t,n):e.parentNode&&e.parentNode.nextSibling&&h.walk(e.parentNode.nextSibling,t,n-1)))},h.revWalk=function(e,t){e&&!1!==t.call(this,e)&&(e.childNodes&&0<e.childNodes.length?h.walk(e.lastChild,t):e.previousSibling?h.walk(e.previousSibling,t):e.parentNode&&e.parentNode.previousSibling&&h.walk(e.parentNode.previousSibling,t))},h.setStyle=function(e,t,n){e&&jQuery(e).css(t,n)},h.getStyle=function(e,t){return jQuery(e).css(t)},h.hasClass=function(e,t){return jQuery(e).hasClass(t)},h.addClass=function(e,t){jQuery(e).addClass(t)},h.removeClass=function(e,t){jQuery(e).removeClass(t)},h.preventDefault=function(e){e.preventDefault(),h.stopPropagation(e)},h.stopPropagation=function(e){e.stopPropagation()},h.noInclusionInherits=function(e,t){(t instanceof String||"string"==typeof t)&&(t=window[t]),(e instanceof String||"string"==typeof e)&&(e=window[e]);function n(){}if(!0===h.isset(t))for(value in t.prototype)e.prototype[value]?n.prototype[value]=t.prototype[value]:e.prototype[value]=t.prototype[value];e.prototype&&(n.prototype.constructor=t,e.prototype.super=new n)},h.each=function(e,n){jQuery.each(e,function(e,t){n.call(this,e,t)})},h.foreach=function(e,t){if(e instanceof Array||e instanceof NodeList||void 0!==e.length&&void 0!==e.item)for(var n=e.length,i=0;i<n;i++){if(!1===t.call(this,i,e[i]))break}else for(var r in e){if(!0===e.hasOwnProperty(r))if(!1===t.call(this,r))break}},h.isBlank=function(e){return!(e&&!/^\s*$/.test(e))},h.isFn=function(e){return"function"==typeof e},h.isObj=function(e){return null!==e&&"object"==typeof e},h.isset=function(e){return null!=e},h.isArray=function(e){return jQuery.isArray(e)},h.isNumeric=function(e){return null!==e.match(/^\d+$/)},h.getUniqueId=function(){return((new Date).getTime()+""+Math.ceil(1e6*Math.random())).substr(5,18).replace(/,/,"")},h.inArray=function(e,t){for(var n=t.length,i=0;i<n;i++)if(e===t[i])return!0;return!1},h.arrayDiff=function(e,t,n){for(var i=e.length,r=[],o=0;o<i;o++)!1===h.inArray(e[o],t)&&r.push(e[o]);if(!0!==n){i=t.length;for(o=0;o<i;o++)!1===h.inArray(t[o],e)&&r.push(t[o])}return r},h.arrayMerge=function(e,t){for(var n=t.length,i=0;i<n;i++)e.push(t[i]);return e},h.stripTags=function(e,t){if("string"==typeof t){var n=jQuery("<div>"+e+"</div>");return n.find("*").not(t).remove(),n.html()}for(var i,r=new RegExp(/<\/?(\w+)((\s+\w+(\s*=\s*(?:".*?"|'.*?'|[^'">\s]+))?)+\s*|\s*)\/?>/gim),o=e;null!=(i=r.exec(e));)!1!==h.isset(t)&&!0===h.inArray(i[1],t)||(o=o.replace(i[0],""));return o},h.browser=function(){return i||(e=navigator.userAgent.toLowerCase(),t=function(e){e=e.toLowerCase();var t=/(chrome)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[];return{browser:t[1]||"",version:t[2]||"0"}}(e),n={type:"unknown",version:0,msie:!1},t.browser&&(n[t.browser]=!0,n.version=t.version||0,n.type=t.browser),n.chrome?n.webkit=!0:n.webkit&&(n.safari=!0),n.webkit&&(n.type="webkit"),n.firefox=1==/firefox/.test(e),n.msie||(n.msie=!!/trident/.test(e)),i=n),$.extend({},i);var e,t,n},h.getBrowserType=function(){if(null===this._browserType){for(var e=["msie","firefox","chrome","safari"],t=e.length,n=0;n<t;n++){if(!0===new RegExp(e[n],"i").test(navigator.userAgent))return this._browserType=e[n],this._browserType}this._browserType="other"}return this._browserType},h.getWebkitType=function(){return"webkit"!==h.browser().type?(console.log("Not a webkit!"),!1):0<Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")?"safari":"chrome"},h.isBrowser=function(e){return h.browser().type===e},h.getBlockParent=function(e,t){if(!0===h.isBlockElement(e))return e;if(e)for(;e.parentNode;){if((e=e.parentNode)===t)return null;if(!0===h.isBlockElement(e))return e}return null},h.findNodeParent=function(e,t,n){if(e)for(;e.parentNode;){if(e===n)return null;if(!0===h.is(e,t))return e;e=e.parentNode}return null},h.onBlockBoundary=function(e,t,n){return!(!e||!t)&&(h.isChildOfTagNames(e,n)||h.is(e,n.join(", "))&&e||null)!==(h.isChildOfTagNames(t,n)||h.is(t,n.join(", "))&&t||null)},h.isOnBlockBoundary=function(e,t,n){return!(!e||!t)&&(h.getBlockParent(e,n)||h.isBlockElement(e,n)&&e||null)!==(h.getBlockParent(t,n)||h.isBlockElement(t,n)&&t||null)},h.mergeContainers=function(e,t){if(!e||!t)return!1;if(e.nodeType===h.TEXT_NODE||h.isStubElement(e))t.appendChild(e);else if(e.nodeType===h.ELEMENT_NODE){for(;e.firstChild;)t.appendChild(e.firstChild);h.remove(e)}return!0},h.mergeBlockWithSibling=function(e,t,n){var i=n?jQuery(t).next().get(0):jQuery(t).prev().get(0);return n?h.mergeContainers(i,t):h.mergeContainers(t,i),e.collapse(!0),!0},h.date=function(e,t,n){if(null!==t||!n||(t=h.tsIso8601ToTimestamp(n))){for(var i=new Date(t),r=e.split(""),o=r.length,s="",a=0;a<o;a++){var c="",l=r[a];switch(l){case"D":case"l":c=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][i.getDay()];"D"===l&&(c=c.substring(0,3));break;case"F":case"m":(c=i.getMonth()+1)<10&&(c="0"+c);break;case"M":months=["January","February","March","April","May","June","July","August","September","October","November","December"],c=months[i.getMonth()],"M"===l&&(c=c.substring(0,3));break;case"d":c=i.getDate();break;case"S":c=h.getOrdinalSuffix(i.getDate());break;case"Y":c=i.getFullYear();break;case"y":c=(c=i.getFullYear()).toString().substring(2);break;case"H":c=i.getHours();break;case"h":0===(c=i.getHours())?c=12:12<c&&(c-=12);break;case"i":c=h.addNumberPadding(i.getMinutes());break;case"a":c="am",12<=i.getHours()&&(c="pm");break;default:c=l}s+=c}return s}},h.getOrdinalSuffix=function(e){var t="",n=e%100;if(4<=n&&n<=20)t="th";else switch(e%10){case 1:t="st";break;case 2:t="nd";break;case 3:t="rd";break;default:t="th"}return t},h.addNumberPadding=function(e){return e<10&&(e="0"+e),e},h.tsIso8601ToTimestamp=function(e){var t=e.match(new RegExp(/(\d\d\d\d)(?:-?(\d\d)(?:-?(\d\d)(?:[T ](\d\d)(?::?(\d\d)(?::?(\d\d)(?:\.(\d+))?)?)?(?:Z|(?:([-+])(\d\d)(?::?(\d\d))?)?)?)?)?)?/));if(t){var n=new Date;n.setDate(t[3]),n.setFullYear(t[1]),n.setMonth(t[2]-1),n.setHours(t[4]),n.setMinutes(t[5]),n.setSeconds(t[6]);var i=60*t[9];return"+"===t[8]&&(i*=-1),i-=n.getTimezoneOffset(),n.getTime()+60*i*1e3}return null},this.dom=h}.call(this.ice),function(){var e=function(e,t,n){this.env=e,this.element=e.element,this.selection=this.env.selection,n||this.removeBookmarks(this.element);var i,r=t||this.selection.getRangeAt(0),o=(t=r.cloneRange()).startContainer,s=(t.endContainer,t.startOffset);t.endOffset;t.collapse(!1);var a=this.env.document.createElement("span");a.style.display="none",ice.dom.setHtml(a,"&nbsp;"),ice.dom.addClass(a,"iceBookmark iceBookmark_end"),a.setAttribute("iceBookmark","end"),t.insertNode(a),ice.dom.isChildOf(a,this.element)||this.element.appendChild(a),t.setStart(o,s),t.collapse(!0);var c=this.env.document.createElement("span");c.style.display="none",ice.dom.addClass(c,"iceBookmark iceBookmark_start"),ice.dom.setHtml(c,"&nbsp;"),c.setAttribute("iceBookmark","start");try{t.insertNode(c),c.previousSibling===a&&(i=c,c=a,a=i)}catch(e){ice.dom.insertBefore(a,c)}!1===ice.dom.isChildOf(c,this.element)&&(this.element.firstChild?ice.dom.insertBefore(this.element.firstChild,c):this.element.appendChild(c)),a.previousSibling||(i=this.env.document.createTextNode(""),ice.dom.insertBefore(a,i)),c.nextSibling||(i=this.env.document.createTextNode(""),ice.dom.insertAfter(c,i)),r.setStart(c.nextSibling,0),r.setEnd(a.previousSibling,a.previousSibling.length||0),this.start=c,this.end=a};e.prototype={selectBookmark:function(){var e,t=this.selection.getRangeAt(0),n=null,i=null,r=0,o=null;this.start.nextSibling===this.end||0===ice.dom.getElementsBetween(this.start,this.end).length?this.end.nextSibling?n=ice.dom.getFirstChild(this.end.nextSibling):this.start.previousSibling?(n=ice.dom.getFirstChild(this.start.previousSibling)).nodeType===ice.dom.TEXT_NODE&&(r=n.length):(this.end.parentNode.appendChild(this.env.document.createTextNode("")),n=ice.dom.getFirstChild(this.end.nextSibling)):(this.start.nextSibling?n=ice.dom.getFirstChild(this.start.nextSibling):(this.start.previousSibling||(e=this.env.document.createTextNode(""),ice.dom.insertBefore(this.start,e)),r=(n=ice.dom.getLastChild(this.start.previousSibling)).length),this.end.previousSibling?i=ice.dom.getLastChild(this.end.previousSibling):(i=ice.dom.getFirstChild(this.end.nextSibling||this.end),o=0)),ice.dom.remove([this.start,this.end]),null===i?(t.setEnd(n,r),t.collapse(!1)):(t.setStart(n,r),null===o&&(o=i.length||0),t.setEnd(i,o));try{this.selection.addRange(t)}catch(e){}},getBookmark:function(e,t){return ice.dom.getClass("iceBookmark_"+t,e)[0]},removeBookmarks:function(e){ice.dom.remove(ice.dom.getClass("iceBookmark",e,"span"))}},this.Bookmark=e}.call(this.ice),function(){var e=function(e){this._selection=null,this.env=e,this._initializeRangeLibrary(),this._getSelection()};e.prototype={_getSelection:function(){return this._selection?this._selection.refresh():this.env.frame?this._selection=rangy.getSelection(this.env.frame):this._selection=rangy.getSelection(),this._selection},createRange:function(){return rangy.createRange(this.env.document)},getRangeAt:function(e){this._selection.refresh();try{return this._selection.getRangeAt(e)}catch(e){return this._selection=null,this._getSelection().getRangeAt(0)}},addRange:function(e){this._selection||(this._selection=this._getSelection()),this._selection.setSingleRange(e),this._selection.ranges=[e]},_initializeRangeLibrary:function(){var n=this;rangy.init(),rangy.config.checkSelectionRanges=!1;function i(e,t,n,i){if(0!==n)switch(t){case ice.dom.CHARACTER_UNIT:0<n?e.moveCharRight(i,n):e.moveCharLeft(i,-1*n);break;case ice.dom.WORD_UNIT:}}rangy.rangePrototype.moveStart=function(e,t){i(this,e,t,!0)},rangy.rangePrototype.moveEnd=function(e,t){i(this,e,t,!1)},rangy.rangePrototype.setRange=function(e,t,n){e?this.setStart(t,n):this.setEnd(t,n)},rangy.rangePrototype.moveCharLeft=function(e,t){var n=e?(i=this.startContainer,this.startOffset):(i=this.endContainer,this.endOffset);if(i.nodeType===ice.dom.ELEMENT_NODE)if(i.hasChildNodes()){for(i=i.childNodes[n],i=this.getPreviousTextNode(i);i&&i.nodeType==ice.dom.TEXT_NODE&&""===i.nodeValue;)i=this.getPreviousTextNode(i);n=i.data.length-t}else n=-1*t;else n-=t;if(n<0)for(;n<0;){var i;if(!(i=this.getPreviousTextNode(i,[])))return;i.nodeType!==ice.dom.ELEMENT_NODE&&(n+=i.data.length)}this.setRange(e,i,n)},rangy.rangePrototype.moveCharRight=function(e,t){var n,i=e?(n=this.startContainer,this.startOffset):(n=this.endContainer,this.endOffset);n.nodeType===ice.dom.ELEMENT_NODE?((n=n.childNodes[i]).nodeType!==ice.dom.TEXT_NODE&&(n=this.getNextTextNode(n)),i=t):i+=t;var r=i-n.data.length;if(0<r){for(var o=[];0<r;)if((n=this.getNextContainer(n,o)).nodeType!==ice.dom.ELEMENT_NODE){if(n.data.length>=r)break;0<n.data.length&&(r-=n.data.length)}i=r}this.setRange(e,n,i)},rangy.rangePrototype.getNextContainer=function(e,t){if(!e)return null;for(;e.nextSibling;)if((e=e.nextSibling).nodeType!==ice.dom.TEXT_NODE){var n=this.getFirstSelectableChild(e);if(null!==n)return n}else if(!0===this.isSelectable(e))return e;for(;e&&!e.nextSibling;)e=e.parentNode;if(!e)return null;if(e=e.nextSibling,!0===this.isSelectable(e))return e;t&&!0===ice.dom.isBlockElement(e)&&t.push(e);var i=this.getFirstSelectableChild(e);return null!==i?i:this.getNextContainer(e,t)},rangy.rangePrototype.getPreviousContainer=function(e,t){if(!e)return null;for(;e.previousSibling;)if((e=e.previousSibling).nodeType!==ice.dom.TEXT_NODE){if(!0===ice.dom.isStubElement(e))return e;var n=this.getLastSelectableChild(e);if(null!==n)return n}else if(!0===this.isSelectable(e))return e;for(;e&&!e.previousSibling;)e=e.parentNode;if(!e)return null;if(e=e.previousSibling,!0===this.isSelectable(e))return e;t&&!0===ice.dom.isBlockElement(e)&&t.push(e);var i=this.getLastSelectableChild(e);return null!==i?i:this.getPreviousContainer(e,t)},rangy.rangePrototype.getNextTextNode=function(e){return e.nodeType===ice.dom.ELEMENT_NODE&&0!==e.childNodes.length?this.getFirstSelectableChild(e):(e=this.getNextContainer(e)).nodeType===ice.dom.TEXT_NODE?e:this.getNextTextNode(e)},rangy.rangePrototype.getPreviousTextNode=function(e,t){return(e=this.getPreviousContainer(e,t)).nodeType===ice.dom.TEXT_NODE?e:this.getPreviousTextNode(e,t)},rangy.rangePrototype.getFirstSelectableChild=function(e){if(e){if(e.nodeType===ice.dom.TEXT_NODE)return e;for(var t=e.firstChild;t;){if(!0===this.isSelectable(t))return t;if(t.firstChild){var n=this.getFirstSelectableChild(t);if(null!==n)return n;t=t.nextSibling}else t=t.nextSibling}}return null},rangy.rangePrototype.getLastSelectableChild=function(e){if(e){if(e.nodeType===ice.dom.TEXT_NODE)return e;for(var t=e.lastChild;t;){if(!0===this.isSelectable(t))return t;if(t.lastChild){var n=this.getLastSelectableChild(t);if(null!==n)return n;t=t.previousSibling}else t=t.previousSibling}}return null},rangy.rangePrototype.isSelectable=function(e){return!(!e||e.nodeType!==ice.dom.TEXT_NODE||0===e.data.length)},rangy.rangePrototype.getHTMLContents=function(e){e=e||this.cloneContents();var t=n.env.document.createElement("div");return t.appendChild(e.cloneNode(!0)),t.innerHTML},rangy.rangePrototype.getHTMLContentsObj=function(){return this.cloneContents()}}},this.Selection=e}.call(this.ice),function(){function e(e){this._ice=e}e.prototype={start:function(){},clicked:function(e){return!0},mouseDown:function(e){return!0},keyDown:function(e){return!0},keyPress:function(e){return!0},selectionChanged:function(e){},setEnabled:function(e){},setDisabled:function(e){},caretUpdated:function(){},nodeInserted:function(e,t){},nodeCreated:function(e,t){},caretPositioned:function(){},remove:function(){this._ice.removeKeyPressListener(this)},setSettings:function(e){}},this.IcePlugin=e}.call(this.ice),function(){function e(e){this.plugins={},this.pluginConstructors={},this.keyPressListeners={},this.activePlugin=null,this.pluginSets={},this.activePluginSet=null,this._ice=e}e.prototype={getPluginNames:function(){var e=[];for(var t in this.plugins)e.push(t);return e},addPluginObject:function(e,t){this.plugins[e]=t},addPlugin:function(e,t){if("function"!=typeof t)throw Error("IcePluginException: plugin must be a constructor function");!1===ice.dom.isset(this.pluginConstructors[e])&&(this.pluginConstructors[e]=t)},loadPlugins:function(e,t){if(0===e.length)t.call(this);else{var n=e.shift();if("object"==typeof n&&(n=n.name),!0!==ice.dom.isset(ice._plugin[n]))throw new Error("plugin was not included in the page: "+n);this.addPlugin(n,ice._plugin[n]),this.loadPlugins(e,t)}},_enableSet:function(e){this.activePluginSet=e;for(var t=this.pluginSets[e].length,n=0;n<t;n++){var i,r=this.pluginSets[e][n],o="",o="object"==typeof r?r.name:r,s=this.pluginConstructors[o];s&&(i=new s(this._ice),this.plugins[o]=i,!0===ice.dom.isset(r.settings)&&i.setSettings(r.settings),i.start())}},setActivePlugin:function(e){this.activePlugin=e},getActivePlugin:function(){return this.activePlugin},_getPluginName:function(e){var t=e.toString(),n="function ".length;return t.substr(n,t.indexOf("(")-n)},removePlugin:function(e){this.plugins[e]&&this.plugins[e].remove()},getPlugin:function(e){return this.plugins[e]},usePlugins:function(e,t,n){var i=this;!0===ice.dom.isset(t)?this.pluginSets[e]=t:this.pluginSets[e]=[];var r=this.pluginSets[e].concat([]);this.loadPlugins(r,function(){i._enableSet(e),n&&n.call(this)})},disablePlugin:function(e){this.plugins[e].disable()},isPluginElement:function(e){for(var t in this.plugins)if(this.plugins[t].isPluginElement&&!0===this.plugins[t].isPluginElement(e))return!0;return!1},fireKeyPressed:function(e){if(!1===this._fireKeyPressFns(e,"all_keys"))return!1;var t,n=[];switch(!0!==e.ctrlKey&&!0!==e.metaKey||n.push("ctrl"),!0===e.shiftKey&&n.push("shift"),!0===e.altKey&&n.push("alt"),e.keyCode){case 13:n.push("enter");break;case ice.dom.DOM_VK_LEFT:n.push("left");break;case ice.dom.DOM_VK_RIGHT:n.push("right");break;case ice.dom.DOM_VK_UP:n.push("up");break;case ice.dom.DOM_VK_DOWN:n.push("down");break;case 9:n.push("tab");break;case ice.dom.DOM_VK_DELETE:n.push("delete");break;default:e.keyCode?t=e.keyCode:e.which&&(t=e.which),t&&n.push(String.fromCharCode(t).toLowerCase())}var i=n.sort().join("+");return this._fireKeyPressFns(e,i)},_fireKeyPressFns:function(e,t){if(this.keyPressListeners[t])for(var n=this.keyPressListeners[t].length,i=0;i<n;i++){var r=this.keyPressListeners[t][i],o=r.fn,s=r.plugin,a=r.data;if(o)if(!0===ice.dom.isFn(o)){if(!0===o.call(s,e,a))return ice.dom.preventDefault(e),!1}else if(s[o]&&!0===s[o].call(s,e,a))return ice.dom.preventDefault(e),!1}return!0},fireSelectionChanged:function(e){for(var t in this.plugins)this.plugins[t].selectionChanged(e)},fireNodeInserted:function(e,t){for(var n in this.plugins)if(!1===this.plugins[n].nodeInserted(e,t))return!1},fireNodeCreated:function(e,t){for(var n in this.plugins)if(!1===this.plugins[n].nodeCreated(e,t))return!1},fireCaretPositioned:function(){for(var e in this.plugins)this.plugins[e].caretPositioned()},fireClicked:function(e){var t=!0;for(var n in this.plugins)!1===this.plugins[n].clicked(e)&&(t=!1);return t},fireMouseDown:function(e){var t=!0;for(var n in this.plugins)!1===this.plugins[n].mouseDown(e)&&(t=!1);return t},fireKeyDown:function(e){var t=!0;for(var n in this.plugins)!1===this.plugins[n].keyDown(e)&&(t=!1);return t},fireKeyPress:function(e){var t=!0;for(var n in this.plugins)!1===this.plugins[n].keyPress(e)&&(t=!1);return t},fireEnabled:function(e){for(var t in this.plugins)this.plugins[t].setEnabled(e)},fireDisabled:function(e){for(var t in this.plugins)this.plugins[t].setDisabled(e)},fireCaretUpdated:function(){for(var e in this.plugins)this.plugins[e].caretUpdated&&this.plugins[e].caretUpdated()}},this._plugin={},this.IcePluginManager=e}.call(this.ice),function(){var e=function(e){this._ice=e};e.prototype={nodeCreated:function(e,t){e.setAttribute("title",(t.action||"Modified")+" by "+e.getAttribute(this._ice.userNameAttribute)+" - "+ice.dom.date("m/d/Y h:ia",parseInt(e.getAttribute(this._ice.timeAttribute))))}},ice.dom.noInclusionInherits(e,ice.IcePlugin),this._plugin.IceAddTitlePlugin=e}.call(this.ice),function(){var e=function(e){this._ice=e,this._tmpNode=null,this._tmpNodeTagName="icepaste",this._pasteId="icepastediv";var t=this;this.pasteType="formattedClean",this.preserve="p",this.beforePasteClean=function(e){return e},this.afterPasteClean=function(e){return e},e.element.oncopy=function(){return t.handleCopy.apply(t)}};e.prototype={setSettings:function(e){e=e||{},ice.dom.extend(this,e),this.preserve+=","+this._tmpNodeTagName,this.setupPreserved()},keyDown:function(e){if(!0===e.metaKey||!0===e.ctrlKey)return 86==e.keyCode?this.handlePaste():88==e.keyCode&&this.handleCut(),!0},handleCopy:function(e){},handlePaste:function(e){var t,n=this._ice.getCurrentRange();switch(n.collapsed||(this._ice.isTracking?(this._ice.deleteContents(),n=n.cloneRange()):(n.deleteContents(),n.collapse(!0))),this._ice.isTracking&&this._ice._moveRangeToValidTrackingPos(n),n.startContainer==this._ice.element&&((t=ice.dom.find(this._ice.element,this._ice.blockEl)[0])||(t=ice.dom.create("<"+this._ice.blockEl+" ><br/></"+this._ice.blockEl+">"),this._ice.element.appendChild(t)),n.setStart(t,0),n.collapse(!0),this._ice.env.selection.addRange(n)),this._tmpNode=this._ice.env.document.createElement(this._tmpNodeTagName),n.insertNode(this._tmpNode),this.pasteType){case"formatted":this.setupPaste();break;case"formattedClean":this.setupPaste(!0)}return!0},setupPaste:function(t){var e=this.createDiv(this._pasteId),n=this,i=this._ice.getCurrentRange();return i.selectNodeContents(e),this._ice.selection.addRange(i),e.onpaste=function(e){setTimeout(function(){n.handlePasteValue(t)},0),e.stopPropagation()},e.focus(),!0},handlePasteValue:function(e){var t=this._ice.env.document,n=t.getElementById(this._pasteId),i=ice.dom.getHtml(n),r=ice.dom.children("<div>"+i+"</div>",this._ice.blockEl);1===r.length&&ice.dom.getNodeTextContent("<div>"+i+"</div>")===ice.dom.getNodeTextContent(r)&&(i=ice.dom.getHtml(i)),i=this.beforePasteClean.call(this,i),e&&(i=this._ice.getCleanContent(i),i=this.stripPaste(i)),i=this.afterPasteClean.call(this,i),i=ice.dom.trim(i);var o=this._ice.getCurrentRange();o.setStartAfter(this._tmpNode),o.collapse(!0);var s,a=null,c=null,l=null,d=o.createContextualFragment(i),u=this._ice.startBatchChange();if(ice.dom.hasBlockChildren(d)){var h=ice.dom.isChildOfTagName(this._tmpNode,this._ice.blockEl);o.setEndAfter(h.lastChild),this._ice.selection.addRange(o);var f=o.extractContents(),g=t.createElement(this._ice.blockEl);g.appendChild(f),ice.dom.insertAfter(h,g),o.setStart(g,0),o.collapse(!0),this._ice.selection.addRange(o);for(var m,p=o.startContainer;d.firstChild;){3!==d.firstChild.nodeType||jQuery.trim(d.firstChild.nodeValue)?ice.dom.isBlockElement(d.firstChild)?(""!==d.firstChild.textContent&&(m=a=null,this._ice.isTracking?(m=this._ice.createIceNode("insertType"),this._ice.addChange("insertType",[m]),l=t.createElement(d.firstChild.tagName),m.innerHTML=d.firstChild.innerHTML,l.appendChild(m)):(m=l=t.createElement(d.firstChild.tagName),l.innerHTML=d.firstChild.innerHTML),c=m,ice.dom.insertBefore(p,l)),d.removeChild(d.firstChild)):(a||(l=t.createElement(this._ice.blockEl),ice.dom.insertBefore(p,l),this._ice.isTracking?(a=this._ice.createIceNode("insertType"),this._ice.addChange("insertType",[a]),l.appendChild(a)):a=l),(c=a).appendChild(d.removeChild(d.firstChild))):d.removeChild(d.firstChild)}g.textContent||g.parentNode.removeChild(g)}else if(this._ice.isTracking)l=this._ice.createIceNode("insertType",d),this._ice.addChange("insertType",[l]),o.insertNode(l),c=l;else for(;s=d.firstChild;)o.insertNode(s),o.setStartAfter(s),o.collapse(!0),c=s;this._ice.endBatchChange(u),n.parentNode.removeChild(n),this._cleanup(c)},createDiv:function(e){var t=this._ice.env.document,n=t.getElementById(e);n&&ice.dom.remove(n);var i=t.createElement("div");return i.id=e,i.setAttribute("contentEditable",!0),ice.dom.setStyle(i,"width","1px"),ice.dom.setStyle(i,"height","1px"),ice.dom.setStyle(i,"overflow","hidden"),ice.dom.setStyle(i,"position","fixed"),ice.dom.setStyle(i,"top","10px"),ice.dom.setStyle(i,"left","10px"),i.appendChild(t.createElement("br")),t.body.appendChild(i),i},handleCut:function(){var e,t=this,n=this._ice.getCurrentRange();n.collapsed||(this.cutElement=this.createDiv("icecut"),this.cutElement.innerHTML=n.getHTMLContents().replace(/ </g,"&nbsp;<").replace(/> /g,">&nbsp;"),this._ice.isTracking?this._ice.deleteContents():n.deleteContents(),(e=this._ice.env.document.createRange()).setStart(this.cutElement.firstChild,0),e.setEndAfter(this.cutElement.lastChild),setTimeout(function(){t.cutElement.focus(),setTimeout(function(){ice.dom.remove(t.cutElement),n.setStart(n.startContainer,n.startOffset),n.collapse(!1),t._ice.env.selection.addRange(n)},100)},0),t._ice.env.selection.addRange(e))},stripPaste:function(e){return e=this._cleanWordPaste(e),e=this.cleanPreserved(e)},setupPreserved:function(){var r=this;this._tags="",this._attributesMap=[],ice.dom.each(this.preserve.split(","),function(e,t){t.match(/(\w+)(\[(.+)\])?/);var n=RegExp.$1,i=RegExp.$3;r._tags&&(r._tags+=","),r._tags+=n.toLowerCase(),r._attributesMap[n]=i.split("|")})},cleanPreserved:function(e){var o=this,t=this._ice.env.document.createElement("div");return t.innerHTML=e,t=ice.dom.stripEnclosingTags(t,this._tags),ice.dom.each(ice.dom.find(t,this._tags),function(e,t){if(ice.dom.hasClass(t,"skip-clean"))return!0;var n=t.tagName.toLowerCase(),i=o._attributesMap[n];if(i[0]&&"*"===i[0])return!0;if(t.hasAttributes())for(var r=t.attributes,e=r.length-1;0<=e;e--)ice.dom.inArray(r[e].name,i)||t.removeAttribute(r[e].name)}),t.innerHTML},_cleanWordPaste:function(e){return e=(e=(e=(e=(e=e.replace(/<(meta|link)[^>]+>/g,"")).replace(/<!--(.|\s)*?-->/g,"")).replace(/<style>[\s\S]*?<\/style>/g,"")).replace(/<\/?\w+:[^>]*>/gi,"")).replace(/<\\?\?xml[^>]*>/gi,""),e=(e=this._cleanPaste(e)).replace(/<(\w[^>]*) (lang)=([^ |>]*)([^>]*)/gi,"<$1$4")},_cleanPaste:function(e){return e=(e=(e=(e=e.replace(/<b(\s+|>)/g,"<strong$1")).replace(/<\/b(\s+|>)/g,"</strong$1")).replace(/<i(\s+|>)/g,"<em$1")).replace(/<\/i(\s+|>)/g,"</em$1")},_cleanup:function(e){try{this._ice.env.frame?this._ice.env.frame.contentWindow.focus():this._ice.element.focus(),e=e&&e.lastChild||e||this._tmpNode;var t=this._ice.getCurrentRange();t.setStartAfter(e),t.collapse(!0),this._ice.selection.addRange(t),this._tmpNode.parentNode.removeChild(this._tmpNode),this._tmpNode=null;for(var n=this._ice.env.document.getElementsByClassName(this._ice.changeTypes.insertType.alias),i=0;i<n.length;i++)n[i].textContent||n[i].parentNode&&n[i].parentNode.removeChild(n[i])}catch(e){window.console&&console.error(e)}}},ice.dom.noInclusionInherits(e,ice.IcePlugin),this._plugin.IceCopyPastePlugin=e}.call(this.ice),function(){function e(e){this._ice=e}var t=this.ice;e.prototype={convert:function(e){var n=this;try{n._ice.placeholdDeletes(),t.dom.each(e.getElementsByTagName(this._ice.blockEl),function(e,t){n._convertBlock(t)})}catch(e){window.console&&console.error(e)}finally{n._ice.revertDeletePlaceholders()}},_convertBlock:function(e){var n,i,r,o,s,a,c,l,d,u,h,f,g,m,p,C;t.dom.getNodeTextContent(e)<2||(o=String.fromCharCode(8216),s=String.fromCharCode(8217),a=String.fromCharCode(8220),c=String.fromCharCode(8221),l=function(e){return/\d/.test(e)},d=function(e){return/\w/.test(e)},u=function(e){return e===String.fromCharCode(160)||e===String.fromCharCode(32)},h=function(e){return u(e)||"("===e},f=function(e){return u(e)||null==e||";"===e||")"===e||"."==e||"!"===e||","===e||"?"===e||":"===e},g=function(e){return!u(e)},m=function(e){return"'"===e||e===o||e===s},p=t.dom.getHtml(e).match(/(<("[^"]*"|'[^']*'|[^'">])*>|&.*;|.)/g),C=function(e,t,n){var o=e.length,s=n<0?-1:1;return function e(t,n,i){if(n<0||o<=n)return null;var r=t[n+s];return r&&1==r.length&&!(i+=-1*s)?r:e(t,n+s,i)}(e,t,n)},t.dom.each(p,function(e,t){if("&nbsp;"==t&&(t=p[e]=" "),1==t.length){switch(n=C(p,e,-1),i=t,r=C(p,e,1),i){case o:case s:i="'";case"'":(null==n||u(n))&&l(r)&&l(C(p,e,2))&&f(C(p,e,3))?i=s:null==n||h(n)&&g(r)?i=o:(null==r||g(n)&&f(r)||d(n)&&d(r))&&(i=s);break;case a:case c:i='"';case'"':f(r)&&u(n)&&m(C(p,e,-2))?i=c:null==n||h(n)&&g(r)?i=a:null==r||g(n)&&f(r)?i=c:(null==n||u(n))&&u(r)&&m(C(p,e,1))&&(i=a)}null!=i&&(p[e]=i)}}),t.dom.setHtml(e,p.join("")))}},t.dom.noInclusionInherits(e,t.IcePlugin),this.ice._plugin.IceSmartQuotesPlugin=e}.call(this),function(){function e(e){this._ice=e}e.prototype={keyDown:function(e){if(ice.dom.isBrowser("mozilla")){var t=parseInt(ice.dom.browser().version);if(14<t&&173===e.keyCode||t<=14&&109===e.keyCode)return this.convertEmdash(e)}else if(189===e.keyCode)return this.convertEmdash(e);return!0},convertEmdash:function(e){var t=this._ice.getCurrentRange();if(t.collapsed){try{if(t.moveStart(ice.dom.CHARACTER_UNIT,-1),ice.dom.getParents(t.startContainer,this._ice.blockEl)[0]===ice.dom.getParents(t.endContainer,this._ice.blockEl)[0]&&!this._ice.getIceNode(t.startContainer,"deleteType")&&(c=t.toHtml(),"-"===c)){t.extractContents(),t.collapse();var n=this._ice.env.document.createTextNode("—");return this._ice.isTracking?this._ice._insertNode(n,t):(t.insertNode(n),t.setStart(n,1),t.collapse(!0)),!(this._ice._preventKeyPress=!0)}}catch(e){}t.collapse()}return!0}},ice.dom.noInclusionInherits(e,ice.IcePlugin),this._plugin.IceEmdashPlugin=e}.call(this.ice);