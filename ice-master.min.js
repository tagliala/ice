//
// ice - Master
// The MIT License
// Copyright (c) 2012 The New York Times, CMS Group, Matthew DeLambo <delambo@gmail.com>
//

window.rangy=function(){var i="object",r="function",n="undefined",a=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer","START_TO_START","START_TO_END","END_TO_START","END_TO_END"],c=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],t=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],o=["collapse","compareEndPoints","duplicate","getBookmark","moveToBookmark","moveToElementText","parentElement","pasteHTML","select","setEndPoint","getBoundingClientRect"];function l(e,t){var n=typeof e[t];return n==r||!(n!=i||!e[t])||"unknown"==n}function d(e,t){return!(typeof e[t]!=i||!e[t])}function e(e,t){return typeof e[t]!=n}function s(i){return function(e,t){for(var n=t.length;n--;)if(!i(e,t[n]))return!1;return!0}}var h=s(l),u=s(d),f=s(e);function g(e){return e&&h(e,o)&&f(e,t)}var m={version:"1.2.3",initialized:!1,supported:!0,util:{isHostMethod:l,isHostObject:d,isHostProperty:e,areHostMethods:h,areHostObjects:u,areHostProperties:f,isTextRange:g},features:{},modules:{},config:{alertOnWarn:!1,preferTextRange:!1}};function p(e){window.alert("Rangy not supported in your browser. Reason: "+e),m.initialized=!0,m.supported=!1}m.fail=p,m.warn=function(e){var t="Rangy warning: "+e;m.config.alertOnWarn?window.alert(t):typeof window.console!=n&&typeof window.console.log!=n&&window.console.log(t)},!{}.hasOwnProperty?p("hasOwnProperty not supported"):m.util.extend=function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};var C=[],v=[];function N(){if(!m.initialized){var e,t=!1,n=!1;l(document,"createRange")&&(e=document.createRange(),h(e,c)&&f(e,a)&&(t=!0),e.detach());var i=d(document,"body")?document.body:document.getElementsByTagName("body")[0];i&&l(i,"createTextRange")&&g(e=i.createTextRange())&&(n=!0),t||n||p("Neither Range nor TextRange are implemented"),m.initialized=!0,m.features={implementsDomRange:t,implementsTextRange:n};for(var r=v.concat(C),o=0,s=r.length;o<s;++o)try{r[o](m)}catch(e){d(window,"console")&&l(window.console,"log")&&window.console.log("Init listener threw an exception. Continuing.",e)}}}m.init=N,m.addInitListener=function(e){m.initialized?e(m):C.push(e)};var E=[];function y(e){this.name=e,this.initialized=!1,this.supported=!1}m.addCreateMissingNativeApiListener=function(e){E.push(e)},m.createMissingNativeApi=function(e){e=e||window,N();for(var t=0,n=E.length;t<n;++t)E[t](e)},y.prototype.fail=function(e){throw this.initialized=!0,this.supported=!1,new Error("Module '"+this.name+"' failed to load: "+e)},y.prototype.warn=function(e){m.warn("Module "+this.name+": "+e)},y.prototype.createError=function(e){return new Error("Error in Rangy "+this.name+" module: "+e)},m.createModule=function(e,t){var n=new y(e);m.modules[e]=n,v.push(function(e){t(e,n),n.initialized=!0,n.supported=!0})};function T(e){_||(_=!0,m.initialized||N())}var _=!(m.requireModules=function(e){for(var t,n,i=0,r=e.length;i<r;++i){if(n=e[i],!((t=m.modules[n])&&t instanceof y))throw new Error("Module '"+n+"' not found");if(!t.supported)throw new Error("Module '"+n+"' not supported")}});if(typeof window!=n){if(typeof document!=n)return l(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",T,!1),l(window,"addEventListener")?window.addEventListener("load",T,!1):l(window,"attachEvent")?window.attachEvent("onload",T):p("Window does not have required addEventListener or attachEvent method"),m;p("No document found")}else p("No window found")}(),rangy.createModule("DomUtil",function(e,t){var n="undefined",i=e.util;i.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||t.fail("document missing a Node creation method"),i.isHostMethod(document,"getElementsByTagName")||t.fail("document missing getElementsByTagName method");var r=document.createElement("div");i.areHostMethods(r,["insertBefore","appendChild","cloneNode"])||t.fail("Incomplete Element implementation"),i.isHostProperty(r,"innerHTML")||t.fail("Element is missing innerHTML property");var o=document.createTextNode("test");i.areHostMethods(o,["splitText","deleteData","insertData","appendData","cloneNode"])||t.fail("Incomplete Text Node implementation");var s=function(e,t){for(var n=e.length;n--;)if(e[n]===t)return!0;return!1};function l(e){for(var t=0;e=e.previousSibling;)t++;return t}function d(e,t){for(var n=[],i=e;i;i=i.parentNode)n.push(i);for(i=t;i;i=i.parentNode)if(s(n,i))return i;return null}function h(e,t,n){for(var i,r=n?e:e.parentNode;r;){if((i=r.parentNode)===t)return r;r=i}return null}function a(e){var t=e.nodeType;return 3==t||4==t||8==t}function c(e,t){var n=t.nextSibling,i=t.parentNode;return n?i.insertBefore(e,n):i.appendChild(e),e}function u(e){if(9==e.nodeType)return e;if(typeof e.ownerDocument!=n)return e.ownerDocument;if(typeof e.document!=n)return e.document;if(e.parentNode)return u(e.parentNode);throw new Error("getDocument: no document found for node")}function f(e){if(!e)return"[No node]";if(a(e))return'"'+e.data+'"';if(1!=e.nodeType)return e.nodeName;var t=e.id?' id="'+e.id+'"':"";return"<"+e.nodeName+t+">["+e.childNodes.length+"]"}function g(e){this.root=e,this._next=e}function m(e,t){this.node=e,this.offset=t}function p(e){this.code=this[e],this.codeName=e,this.message="DOMException: "+this.codeName}g.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var e,t,n=this._current=this._next;if(this._current)if(e=n.firstChild)this._next=e;else{for(t=null;n!==this.root&&!(t=n.nextSibling);)n=n.parentNode;this._next=t}return this._current},detach:function(){this._current=this._next=this.root=null}},m.prototype={equals:function(e){return this.node===e.node&this.offset==e.offset},inspect:function(){return"[DomPosition("+f(this.node)+":"+this.offset+")]"}},(p.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11}).toString=function(){return this.message},e.dom={arrayContains:s,isHtmlNamespace:function(e){var t;return typeof e.namespaceURI==n||null===(t=e.namespaceURI)||"http://www.w3.org/1999/xhtml"==t},parentElement:function(e){var t=e.parentNode;return 1==t.nodeType?t:null},getNodeIndex:l,getNodeLength:function(e){var t;return a(e)?e.length:(t=e.childNodes)?t.length:0},getCommonAncestor:d,isAncestorOf:function(e,t,n){for(var i=n?t:t.parentNode;i;){if(i===e)return!0;i=i.parentNode}return!1},getClosestAncestorIn:h,isCharacterDataNode:a,insertAfter:c,splitDataNode:function(e,t){var n=e.cloneNode(!1);return n.deleteData(0,t),e.deleteData(t,e.length-t),c(n,e),n},getDocument:u,getWindow:function(e){var t=u(e);if(typeof t.defaultView!=n)return t.defaultView;if(typeof t.parentWindow!=n)return t.parentWindow;throw new Error("Cannot get a window object for node")},getIframeWindow:function(e){if(typeof e.contentWindow!=n)return e.contentWindow;if(typeof e.contentDocument!=n)return e.contentDocument.defaultView;throw new Error("getIframeWindow: No Window object found for iframe element")},getIframeDocument:function(e){if(typeof e.contentDocument!=n)return e.contentDocument;if(typeof e.contentWindow!=n)return e.contentWindow.document;throw new Error("getIframeWindow: No Document object found for iframe element")},getBody:function(e){return i.isHostObject(e,"body")?e.body:e.getElementsByTagName("body")[0]},getRootContainer:function(e){for(var t;t=e.parentNode;)e=t;return e},comparePoints:function(e,t,n,i){var r,o,s,a,c;if(e==n)return t===i?0:t<i?-1:1;if(r=h(n,e,!0))return t<=l(r)?-1:1;if(r=h(e,n,!0))return l(r)<i?-1:1;if((s=e===(o=d(e,n))?o:h(e,o,!0))===(a=n===o?o:h(n,o,!0)))throw new Error("comparePoints got to case 4 and childA and childB are the same!");for(c=o.firstChild;c;){if(c===s)return-1;if(c===a)return 1;c=c.nextSibling}throw new Error("Should not be here!")},inspectNode:f,fragmentFromNodeChildren:function(e){for(var t,n=u(e).createDocumentFragment();t=e.firstChild;)n.appendChild(t);return n},createIterator:function(e){return new g(e)},DomPosition:m},e.DOMException=p}),rangy.createModule("DomRange",function(i,e){i.requireModules(["DomUtil"]);var d=i.dom,t=d.DomPosition,s=i.DOMException;function a(e,t){return 3!=e.nodeType&&(d.isAncestorOf(e,t.startContainer,!0)||d.isAncestorOf(e,t.endContainer,!0))}function c(e){return d.getDocument(e.startContainer)}function l(e,t,n){var i=e._listeners[t];if(i)for(var r=0,o=i.length;r<o;++r)i[r].call(e,{target:e,args:n})}function h(e){return new t(e.parentNode,d.getNodeIndex(e))}function u(e){return new t(e.parentNode,d.getNodeIndex(e)+1)}function n(e,t,n){var i=11==e.nodeType?e.firstChild:e;return d.isCharacterDataNode(t)?n==t.length?d.insertAfter(e,t):t.parentNode.insertBefore(e,0==n?t:d.splitDataNode(t,n)):n>=t.childNodes.length?t.appendChild(e):t.insertBefore(e,t.childNodes[n]),i}function f(e,t,n){var i,r,o,s;for(n=n||{stop:!1};o=e.next();)if(e.isPartiallySelectedSubtree()){if(!1===t(o))return void(n.stop=!0);if(f(s=e.getSubtreeIterator(),t,n),s.detach(!0),n.stop)return}else for(i=d.createIterator(o);r=i.next();)if(!1===t(r))return void(n.stop=!0)}function g(e){for(var t;e.next();)e.isPartiallySelectedSubtree()?(g(t=e.getSubtreeIterator()),t.detach(!0)):e.remove()}function m(e){for(var t,n,i=c(e.range).createDocumentFragment();t=e.next();){if(e.isPartiallySelectedSubtree()?(t=t.cloneNode(!1),n=e.getSubtreeIterator(),t.appendChild(m(n)),n.detach(!0)):e.remove(),10==t.nodeType)throw new s("HIERARCHY_REQUEST_ERR");i.appendChild(t)}return i}function r(e,t,n){var i,r=!(!t||!t.length),o=!!n;r&&(i=new RegExp("^("+t.join("|")+")$"));var s=[];return f(new p(e,!1),function(e){r&&!i.test(e.nodeType)||o&&!n(e)||s.push(e)}),s}function o(e){return"["+(void 0===e.getName?"Range":e.getName())+"("+d.inspectNode(e.startContainer)+":"+e.startOffset+", "+d.inspectNode(e.endContainer)+":"+e.endOffset+")]"}function p(e,t){var n;this.range=e,this.clonePartiallySelectedTextNodes=t,e.collapsed||(this.sc=e.startContainer,this.so=e.startOffset,this.ec=e.endContainer,this.eo=e.endOffset,n=e.commonAncestorContainer,this.sc===this.ec&&d.isCharacterDataNode(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==n||d.isCharacterDataNode(this.sc)?d.getClosestAncestorIn(this.sc,n,!0):this.sc.childNodes[this.so],this._last=this.ec!==n||d.isCharacterDataNode(this.ec)?d.getClosestAncestorIn(this.ec,n,!0):this.ec.childNodes[this.eo-1]))}function C(e){this.code=this[e],this.codeName=e,this.message="RangeException: "+this.codeName}function v(e,t,n){this.nodes=r(e,t,n),this._next=this.nodes[0],this._position=0}p.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var e=this._current=this._next;return e&&(this._next=e!==this._last?e.nextSibling:null,d.isCharacterDataNode(e)&&this.clonePartiallySelectedTextNodes&&(e===this.ec&&(e=e.cloneNode(!0)).deleteData(this.eo,e.length-this.eo),this._current===this.sc&&(e=e.cloneNode(!0)).deleteData(0,this.so))),e},remove:function(){var e,t,n=this._current;!d.isCharacterDataNode(n)||n!==this.sc&&n!==this.ec?n.parentNode&&n.parentNode.removeChild(n):(e=n===this.sc?this.so:0)!=(t=n===this.ec?this.eo:n.length)&&n.deleteData(e,t-e)},isPartiallySelectedSubtree:function(){return a(this._current,this.range)},getSubtreeIterator:function(){var e,t,n,i,r,o;return this.isSingleCharacterDataNode?(e=this.range.cloneRange()).collapse():(e=new ie(c(this.range)),i=0,r=n=t=this._current,o=d.getNodeLength(t),d.isAncestorOf(t,this.sc,!0)&&(n=this.sc,i=this.so),d.isAncestorOf(t,this.ec,!0)&&(r=this.ec,o=this.eo),ne(e,n,i,r,o)),new p(e,this.clonePartiallySelectedTextNodes)},detach:function(e){e&&this.range.detach(),this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}},(C.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2}).toString=function(){return this.message},v.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){return this._current=this._next,this._next=this.nodes[++this._position],this._current},detach:function(){this._current=this._next=this.nodes=null}};var N=[1,3,4,5,7,8,10],E=[2,9,11],y=[1,3,4,5,7,8,10,11],T=[1,3,4,5,7,8];function _(r){return function(e,t){for(var n,i=t?e:e.parentNode;i;){if(n=i.nodeType,d.arrayContains(r,n))return i;i=i.parentNode}return null}}var S=d.getRootContainer,R=_([9,11]),b=_([5,6,10,12]),w=_([6,10,12]);function O(e,t){if(w(e,t))throw new C("INVALID_NODE_TYPE_ERR")}function D(e){if(!e.startContainer)throw new s("INVALID_STATE_ERR")}function x(e,t){if(!d.arrayContains(t,e.nodeType))throw new C("INVALID_NODE_TYPE_ERR")}function k(e,t){if(t<0||t>(d.isCharacterDataNode(e)?e.length:e.childNodes.length))throw new s("INDEX_SIZE_ERR")}function A(e,t){if(R(e,!0)!==R(t,!0))throw new s("WRONG_DOCUMENT_ERR")}function P(e){if(b(e,!0))throw new s("NO_MODIFICATION_ALLOWED_ERR")}function I(e,t){if(!e)throw new s(t)}function B(e){return!d.arrayContains(E,e.nodeType)&&!R(e,!0)}function M(e,t){return t<=(d.isCharacterDataNode(e)?e.length:e.childNodes.length)}function L(e){return!!e.startContainer&&!!e.endContainer&&!B(e.startContainer)&&!B(e.endContainer)&&M(e.startContainer,e.startOffset)&&M(e.endContainer,e.endOffset)}function H(e){if(D(e),!L(e))throw new Error("Range error: Range is no longer valid after DOM mutation ("+e.inspect()+")")}var j=document.createElement("style"),U=!1;try{j.innerHTML="<b>x</b>",U=3==j.firstChild.nodeType}catch(e){}i.features.htmlParsingConforms=U;var Q=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],W=0,F=1,K=2,V=3,X=0,z=1,q=2,Y=3;function $(){}function G(e){e.START_TO_START=W,e.START_TO_END=F,e.END_TO_END=K,e.END_TO_START=V,e.NODE_BEFORE=X,e.NODE_AFTER=z,e.NODE_BEFORE_AND_AFTER=q,e.NODE_INSIDE=Y}function Z(e){G(e),G(e.prototype)}function J(s,a){return function(){H(this);var e,t=this.startContainer,n=this.startOffset,i=this.commonAncestorContainer,r=new p(this,!0);t!==i&&(t=(e=u(d.getClosestAncestorIn(t,i,!0))).node,n=e.offset),f(r,P),r.reset();var o=s(r);return r.detach(),a(this,t,n,t,n),o}}function ee(e,l,t){function n(n,i){return function(e){D(this),x(e,N),x(S(e),E);var t=(n?h:u)(e);(i?r:o)(this,t.node,t.offset)}}function r(e,t,n){var i=e.endContainer,r=e.endOffset;t===e.startContainer&&n===e.startOffset||(S(t)==S(i)&&1!=d.comparePoints(t,n,i,r)||(i=t,r=n),l(e,t,n,i,r))}function o(e,t,n){var i=e.startContainer,r=e.startOffset;t===e.endContainer&&n===e.endOffset||(S(t)==S(i)&&-1!=d.comparePoints(t,n,i,r)||(i=t,r=n),l(e,i,r,t,n))}e.prototype=new $,i.util.extend(e.prototype,{setStart:function(e,t){D(this),O(e,!0),k(e,t),r(this,e,t)},setEnd:function(e,t){D(this),O(e,!0),k(e,t),o(this,e,t)},setStartBefore:n(!0,!0),setStartAfter:n(!1,!0),setEndBefore:n(!0,!1),setEndAfter:n(!1,!1),collapse:function(e){H(this),e?l(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):l(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(e){D(this),O(e,!0),l(this,e,0,e,d.getNodeLength(e))},selectNode:function(e){D(this),O(e,!1),x(e,N);var t=h(e),n=u(e);l(this,t.node,t.offset,n.node,n.offset)},extractContents:J(m,l),deleteContents:J(g,l),canSurroundContents:function(){H(this),P(this.startContainer),P(this.endContainer);var e=new p(this,!0),t=e._first&&a(e._first,this)||e._last&&a(e._last,this);return e.detach(),!t},detach:function(){t(this)},splitBoundaries:function(){H(this);var e=this.startContainer,t=this.startOffset,n=this.endContainer,i=this.endOffset,r=e===n;d.isCharacterDataNode(n)&&0<i&&i<n.length&&d.splitDataNode(n,i),d.isCharacterDataNode(e)&&0<t&&t<e.length&&(e=d.splitDataNode(e,t),r?(i-=t,n=e):n==e.parentNode&&i>=d.getNodeIndex(e)&&i++,t=0),l(this,e,t,n,i)},normalizeBoundaries:function(){H(this);function e(e){var t=e.nextSibling;t&&t.nodeType==e.nodeType&&(a=(s=e).length,e.appendData(t.data),t.parentNode.removeChild(t))}function t(e){var t,n,i=e.previousSibling;i&&i.nodeType==e.nodeType&&(t=(r=e).length,o=i.length,e.insertData(0,i.data),i.parentNode.removeChild(i),r==s?(a+=o,s=r):s==e.parentNode&&(n=d.getNodeIndex(e),a==n?(s=e,a=t):n<a&&a--))}var n,i,r=this.startContainer,o=this.startOffset,s=this.endContainer,a=this.endOffset,c=!0;d.isCharacterDataNode(s)?s.length==a&&e(s):(0<a&&((n=s.childNodes[a-1])&&d.isCharacterDataNode(n)&&e(n)),c=!this.collapsed),c?d.isCharacterDataNode(r)?0==o&&t(r):o<r.childNodes.length&&((i=r.childNodes[o])&&d.isCharacterDataNode(i)&&t(i)):(r=s,o=a),l(this,r,o,s,a)},collapseToPoint:function(e,t){var n,i,r;D(this),O(e,!0),k(e,t),r=t,(i=e)===(n=this).startContainer&&r===n.startOffset&&i===n.endContainer&&r===n.endOffset||l(n,i,r,i,r)}}),Z(e)}function te(e){e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset,e.commonAncestorContainer=e.collapsed?e.startContainer:d.getCommonAncestor(e.startContainer,e.endContainer)}function ne(e,t,n,i,r){var o=e.startContainer!==t||e.startOffset!==n,s=e.endContainer!==i||e.endOffset!==r;e.startContainer=t,e.startOffset=n,e.endContainer=i,e.endOffset=r,te(e),l(e,"boundarychange",{startMoved:o,endMoved:s})}function ie(e){this.startContainer=e,this.startOffset=0,this.endContainer=e,this.endOffset=0,this._listeners={boundarychange:[],detach:[]},te(this)}$.prototype={attachListener:function(e,t){this._listeners[e].push(t)},compareBoundaryPoints:function(e,t){H(this),A(this.startContainer,t.startContainer);var n=e==V||e==W?"start":"end",i=e==F||e==W?"start":"end",r=this[n+"Container"],o=this[n+"Offset"],s=t[i+"Container"],a=t[i+"Offset"];return d.comparePoints(r,o,s,a)},insertNode:function(e){if(H(this),x(e,y),P(this.startContainer),d.isAncestorOf(e,this.startContainer,!0))throw new s("HIERARCHY_REQUEST_ERR");var t=n(e,this.startContainer,this.startOffset);this.setStartBefore(t)},cloneContents:function(){var e;if(H(this),this.collapsed)return c(this).createDocumentFragment();if(this.startContainer===this.endContainer&&d.isCharacterDataNode(this.startContainer))return(n=this.startContainer.cloneNode(!0)).data=n.data.slice(this.startOffset,this.endOffset),(e=c(this).createDocumentFragment()).appendChild(n),e;var t=new p(this,!0),n=function e(t){for(var n,i,r,o=c(t.range).createDocumentFragment();i=t.next();){if(n=t.isPartiallySelectedSubtree(),i=i.cloneNode(!n),n&&(r=t.getSubtreeIterator(),i.appendChild(e(r)),r.detach(!0)),10==i.nodeType)throw new s("HIERARCHY_REQUEST_ERR");o.appendChild(i)}return o}(t);return t.detach(),n},canSurroundContents:function(){H(this),P(this.startContainer),P(this.endContainer);var e=new p(this,!0),t=e._first&&a(e._first,this)||e._last&&a(e._last,this);return e.detach(),!t},surroundContents:function(e){if(x(e,T),!this.canSurroundContents())throw new C("BAD_BOUNDARYPOINTS_ERR");var t=this.extractContents();if(e.hasChildNodes())for(;e.lastChild;)e.removeChild(e.lastChild);n(e,this.startContainer,this.startOffset),e.appendChild(t),this.selectNode(e)},cloneRange:function(){H(this);for(var e,t=new ie(c(this)),n=Q.length;n--;)t[e=Q[n]]=this[e];return t},toString:function(){H(this);var e=this.startContainer;if(e===this.endContainer&&d.isCharacterDataNode(e))return 3==e.nodeType||4==e.nodeType?e.data.slice(this.startOffset,this.endOffset):"";var t=[],n=new p(this,!0);return f(n,function(e){3!=e.nodeType&&4!=e.nodeType||t.push(e.data)}),n.detach(),t.join("")},compareNode:function(e){H(this);var t=e.parentNode,n=d.getNodeIndex(e);if(!t)throw new s("NOT_FOUND_ERR");var i=this.comparePoint(t,n),r=this.comparePoint(t,n+1);return i<0?0<r?q:X:0<r?z:Y},comparePoint:function(e,t){return H(this),I(e,"HIERARCHY_REQUEST_ERR"),A(e,this.startContainer),d.comparePoints(e,t,this.startContainer,this.startOffset)<0?-1:0<d.comparePoints(e,t,this.endContainer,this.endOffset)?1:0},createContextualFragment:U?function(e){var t=this.startContainer,n=d.getDocument(t);if(!t)throw new s("INVALID_STATE_ERR");var i=null;return 1==t.nodeType?i=t:d.isCharacterDataNode(t)&&(i=d.parentElement(t)),(i=null===i||"HTML"==i.nodeName&&d.isHtmlNamespace(d.getDocument(i).documentElement)&&d.isHtmlNamespace(i)?n.createElement("body"):i.cloneNode(!1)).innerHTML=e,d.fragmentFromNodeChildren(i)}:function(e){D(this);var t=c(this).createElement("body");return t.innerHTML=e,d.fragmentFromNodeChildren(t)},toHtml:function(){H(this);var e=c(this).createElement("div");return e.appendChild(this.cloneContents()),e.innerHTML},intersectsNode:function(e,t){if(H(this),I(e,"NOT_FOUND_ERR"),d.getDocument(e)!==c(this))return!1;var n=e.parentNode,i=d.getNodeIndex(e);I(n,"NOT_FOUND_ERR");var r=d.comparePoints(n,i,this.endContainer,this.endOffset),o=d.comparePoints(n,i+1,this.startContainer,this.startOffset);return t?r<=0&&0<=o:r<0&&0<o},isPointInRange:function(e,t){return H(this),I(e,"HIERARCHY_REQUEST_ERR"),A(e,this.startContainer),0<=d.comparePoints(e,t,this.startContainer,this.startOffset)&&d.comparePoints(e,t,this.endContainer,this.endOffset)<=0},intersectsRange:function(e,t){if(H(this),c(e)!=c(this))throw new s("WRONG_DOCUMENT_ERR");var n=d.comparePoints(this.startContainer,this.startOffset,e.endContainer,e.endOffset),i=d.comparePoints(this.endContainer,this.endOffset,e.startContainer,e.startOffset);return t?n<=0&&0<=i:n<0&&0<i},intersection:function(e){if(this.intersectsRange(e)){var t=d.comparePoints(this.startContainer,this.startOffset,e.startContainer,e.startOffset),n=d.comparePoints(this.endContainer,this.endOffset,e.endContainer,e.endOffset),i=this.cloneRange();return-1==t&&i.setStart(e.startContainer,e.startOffset),1==n&&i.setEnd(e.endContainer,e.endOffset),i}return null},union:function(e){if(this.intersectsRange(e,!0)){var t=this.cloneRange();return-1==d.comparePoints(e.startContainer,e.startOffset,this.startContainer,this.startOffset)&&t.setStart(e.startContainer,e.startOffset),1==d.comparePoints(e.endContainer,e.endOffset,this.endContainer,this.endOffset)&&t.setEnd(e.endContainer,e.endOffset),t}throw new C("Ranges do not intersect")},containsNode:function(e,t){return t?this.intersectsNode(e,!1):this.compareNode(e)==Y},containsNodeContents:function(e){return 0<=this.comparePoint(e,0)&&this.comparePoint(e,d.getNodeLength(e))<=0},containsRange:function(e){return this.intersection(e).equals(e)},containsNodeText:function(e){var t=this.cloneRange();t.selectNode(e);var n=t.getNodes([3]);if(0<n.length){t.setStart(n[0],0);var i=n.pop();t.setEnd(i,i.length);var r=this.containsRange(t);return t.detach(),r}return this.containsNodeContents(e)},createNodeIterator:function(e,t){return H(this),new v(this,e,t)},getNodes:function(e,t){return H(this),r(this,e,t)},getDocument:function(){return c(this)},collapseBefore:function(e){D(this),this.setEndBefore(e),this.collapse(!1)},collapseAfter:function(e){D(this),this.setStartAfter(e),this.collapse(!0)},getName:function(){return"DomRange"},equals:function(e){return ie.rangesEqual(this,e)},isValid:function(){return L(this)},inspect:function(){return o(this)}},ee(ie,ne,function(e){D(e),e.startContainer=e.startOffset=e.endContainer=e.endOffset=null,e.collapsed=e.commonAncestorContainer=null,l(e,"detach",null),e._listeners=null}),i.rangePrototype=$.prototype,ie.rangeProperties=Q,ie.RangeIterator=p,ie.copyComparisonConstants=Z,ie.createPrototypeRange=ee,ie.inspect=o,ie.getRangeDocument=c,ie.rangesEqual=function(e,t){return e.startContainer===t.startContainer&&e.startOffset===t.startOffset&&e.endContainer===t.endContainer&&e.endOffset===t.endOffset},i.DomRange=ie,i.RangeException=C}),rangy.createModule("WrappedRange",function(a,e){var c;a.requireModules(["DomUtil","DomRange"]);var t,p=a.dom,C=p.DomPosition,l=a.DomRange;function r(e,t,n,i){var r=e.duplicate();r.collapse(n);var o=r.parentElement();if(p.isAncestorOf(t,o,!0)||(o=t),!o.canHaveHTML)return new C(o.parentNode,p.getNodeIndex(o));for(var s,a,c,l,d,h=p.getDocument(o).createElement("span"),u=n?"StartToStart":"StartToEnd";o.insertBefore(h,h.previousSibling),r.moveToElementText(h),0<(s=r.compareEndPoints(u,e))&&h.previousSibling;);if(d=h.nextSibling,-1==s&&d&&p.isCharacterDataNode(d)){if(r.setEndPoint(n?"EndToStart":"EndToEnd",e),/[\r\n]/.test(d.data))for(var f=r.duplicate(),g=f.text.replace(/\r\n/g,"\r").length,m=f.moveStart("character",g);-1==(s=f.compareEndPoints("StartToEnd",f));)m++,f.moveStart("character",1);else m=r.text.length;l=new C(d,m)}else a=(i||!n)&&h.previousSibling,l=(c=(i||n)&&h.nextSibling)&&p.isCharacterDataNode(c)?new C(c,0):a&&p.isCharacterDataNode(a)?new C(a,a.length):new C(o,p.getNodeIndex(h));return h.parentNode.removeChild(h),l}function o(e,t){var n,i,r=e.offset,o=p.getDocument(e.node),s=o.body.createTextRange(),a=p.isCharacterDataNode(e.node),c=a?(n=e.node).parentNode:(n=r<(i=e.node.childNodes).length?i[r]:null,e.node),l=o.createElement("span");return l.innerHTML="&#feff;",n?c.insertBefore(l,n):c.appendChild(l),s.moveToElementText(l),s.collapse(!t),c.removeChild(l),a&&s[t?"moveStart":"moveEnd"]("character",r),s}!a.features.implementsDomRange||a.features.implementsTextRange&&a.config.preferTextRange?a.features.implementsTextRange&&((c=function(e){this.textRange=e,this.refresh()}).prototype=new l(document),c.prototype.refresh=function(){var e,t,n=function(e){var t=e.parentElement(),n=e.duplicate();n.collapse(!0);var i=n.parentElement();(n=e.duplicate()).collapse(!1);var r=n.parentElement(),o=i==r?i:p.getCommonAncestor(i,r);return o==t?o:p.getCommonAncestor(t,o)}(this.textRange),i=0==(t=this.textRange).compareEndPoints("StartToEnd",t)?e=r(this.textRange,n,!0,!0):(e=r(this.textRange,n,!0,!1),r(this.textRange,n,!1,!1));this.setStart(e.node,e.offset),this.setEnd(i.node,i.offset)},l.copyComparisonConstants(c),void 0===(t=function(){return this}()).Range&&(t.Range=c),a.createNativeRange=function(e){return(e=e||document).body.createTextRange()}):(function(){var t,n,i=l.rangeProperties;function r(e){for(var t,n=i.length;n--;)e[t=i[n]]=e.nativeRange[t]}c=function(e){if(!e)throw new Error("Range must be specified");this.nativeRange=e,r(this)},l.createPrototypeRange(c,function(e,t,n,i,r){var o=e.startContainer!==t||e.startOffset!=n,s=e.endContainer!==i||e.endOffset!=r;(o||s)&&(e.setEnd(i,r),e.setStart(t,n))},function(e){e.nativeRange.detach(),e.detached=!0;for(var t=i.length;t--;)e[i[t]]=null}),(t=c.prototype).selectNode=function(e){this.nativeRange.selectNode(e),r(this)},t.deleteContents=function(){this.nativeRange.deleteContents(),r(this)},t.extractContents=function(){var e=this.nativeRange.extractContents();return r(this),e},t.cloneContents=function(){return this.nativeRange.cloneContents()},t.surroundContents=function(e){this.nativeRange.surroundContents(e),r(this)},t.collapse=function(e){this.nativeRange.collapse(e),r(this)},t.cloneRange=function(){return new c(this.nativeRange.cloneRange())},t.refresh=function(){r(this)},t.toString=function(){return this.nativeRange.toString()};var e=document.createTextNode("test");p.getBody(document).appendChild(e);var o=document.createRange();o.setStart(e,0),o.setEnd(e,0);try{o.setStart(e,1),t.setStart=function(e,t){this.nativeRange.setStart(e,t),r(this)},t.setEnd=function(e,t){this.nativeRange.setEnd(e,t),r(this)},n=function(t){return function(e){this.nativeRange[t](e),r(this)}}}catch(e){t.setStart=function(t,n){try{this.nativeRange.setStart(t,n)}catch(e){this.nativeRange.setEnd(t,n),this.nativeRange.setStart(t,n)}r(this)},t.setEnd=function(t,n){try{this.nativeRange.setEnd(t,n)}catch(e){this.nativeRange.setStart(t,n),this.nativeRange.setEnd(t,n)}r(this)},n=function(n,i){return function(t){try{this.nativeRange[n](t)}catch(e){this.nativeRange[i](t),this.nativeRange[n](t)}r(this)}}}t.setStartBefore=n("setStartBefore","setEndBefore"),t.setStartAfter=n("setStartAfter","setEndAfter"),t.setEndBefore=n("setEndBefore","setStartBefore"),t.setEndAfter=n("setEndAfter","setStartAfter"),o.selectNodeContents(e),o.startContainer==e&&o.endContainer==e&&0==o.startOffset&&o.endOffset==e.length?t.selectNodeContents=function(e){this.nativeRange.selectNodeContents(e),r(this)}:t.selectNodeContents=function(e){this.setStart(e,0),this.setEnd(e,l.getEndOffset(e))},o.selectNodeContents(e),o.setEnd(e,3);var s=document.createRange();s.selectNodeContents(e),s.setEnd(e,4),s.setStart(e,2),-1==o.compareBoundaryPoints(o.START_TO_END,s)&1==o.compareBoundaryPoints(o.END_TO_START,s)?t.compareBoundaryPoints=function(e,t){return e==(t=t.nativeRange||t).START_TO_END?e=t.END_TO_START:e==t.END_TO_START&&(e=t.START_TO_END),this.nativeRange.compareBoundaryPoints(e,t)}:t.compareBoundaryPoints=function(e,t){return this.nativeRange.compareBoundaryPoints(e,t.nativeRange||t)},a.util.isHostMethod(o,"createContextualFragment")&&(t.createContextualFragment=function(e){return this.nativeRange.createContextualFragment(e)}),p.getBody(document).removeChild(e),o.detach(),s.detach()}(),a.createNativeRange=function(e){return(e=e||document).createRange()}),a.features.implementsTextRange&&(c.rangeToTextRange=function(e){if(e.collapsed)return o(new C(e.startContainer,e.startOffset),!0);var t=o(new C(e.startContainer,e.startOffset),!0),n=o(new C(e.endContainer,e.endOffset),!1),i=p.getDocument(e.startContainer).body.createTextRange();return i.setEndPoint("StartToStart",t),i.setEndPoint("EndToEnd",n),i}),c.prototype.getName=function(){return"WrappedRange"},a.WrappedRange=c,a.createRange=function(e){return e=e||document,new c(a.createNativeRange(e))},a.createRangyRange=function(e){return e=e||document,new l(e)},a.createIframeRange=function(e){return a.createRange(p.getIframeDocument(e))},a.createIframeRangyRange=function(e){return a.createRangyRange(p.getIframeDocument(e))},a.addCreateMissingNativeApiListener(function(e){var t=e.document;void 0===t.createRange&&(t.createRange=function(){return a.createRange(this)}),t=e=null})}),rangy.createModule("WrappedSelection",function(o,e){o.requireModules(["DomUtil","DomRange","WrappedRange"]),o.config.checkSelectionRanges=!0;var r,s,t="boolean",a="_rangySelection",c=o.dom,n=o.util,l=o.DomRange,d=o.WrappedRange,i=o.DOMException,h=c.DomPosition,u="Control";function f(e){return(e||window).document.selection}var g=o.util.isHostMethod(window,"getSelection"),m=o.util.isHostObject(document,"selection"),p=m&&(!g||o.config.preferTextRange);p?(r=f,o.isSelectionValid=function(e){var t=(e||window).document,n=t.selection;return"None"!=n.type||c.getDocument(n.createRange().parentElement())==t}):g?(r=function(e){return(e||window).getSelection()},o.isSelectionValid=function(){return!0}):e.fail("Neither document.selection or window.getSelection() detected.");var C=(o.getNativeSelection=r)(),v=o.createNativeRange(document),N=c.getBody(document),E=n.areHostObjects(C,n.areHostProperties(C,["anchorOffset","focusOffset"]));o.features.selectionHasAnchorAndFocus=E;var y=n.isHostMethod(C,"extend");o.features.selectionHasExtend=y;var T="number"==typeof C.rangeCount;o.features.selectionHasRangeCount=T;var _=!1,S=!0;n.areHostMethods(C,["addRange","getRangeAt","removeAllRanges"])&&"number"==typeof C.rangeCount&&o.features.implementsDomRange&&function(){var e=document.createElement("iframe");e.frameBorder=0,e.style.position="absolute",e.style.left="-10000px",N.appendChild(e);var t=c.getIframeDocument(e);t.open(),t.write("<html><head></head><body>12</body></html>"),t.close();var n=c.getIframeWindow(e).getSelection(),i=t.documentElement.lastChild.firstChild,r=t.createRange();r.setStart(i,1),r.collapse(!0),n.addRange(r),S=1==n.rangeCount,n.removeAllRanges();var o=r.cloneRange();r.setStart(i,0),o.setEnd(i,2),n.addRange(r),n.addRange(o),_=2==n.rangeCount,r.detach(),o.detach(),N.removeChild(e)}(),o.features.selectionSupportsMultipleRanges=_,o.features.collapsedNonEditableSelectionsSupported=S;var R,b,w=!1;function O(e,t,n){var i=n?"end":"start",r=n?"start":"end";e.anchorNode=t[i+"Container"],e.anchorOffset=t[i+"Offset"],e.focusNode=t[r+"Container"],e.focusOffset=t[r+"Offset"]}function D(e){e.anchorNode=e.focusNode=null,e.anchorOffset=e.focusOffset=0,e.rangeCount=0,e.isCollapsed=!0,e._ranges.length=0}function x(e){var t;return e instanceof l?(t=e._selectionNativeRange)||((t=o.createNativeRange(c.getDocument(e.startContainer))).setEnd(e.endContainer,e.endOffset),t.setStart(e.startContainer,e.startOffset),e._selectionNativeRange=t,e.attachListener("detach",function(){this._selectionNativeRange=null})):e instanceof d?t=e.nativeRange:o.features.implementsDomRange&&e instanceof c.getWindow(e.startContainer).Range&&(t=e),t}function k(e){var t=e.getNodes();if(!function(e){if(e.length&&1==e[0].nodeType){for(var t=1,n=e.length;t<n;++t)if(!c.isAncestorOf(e[0],e[t]))return;return 1}}(t))throw new Error("getSingleElementFromRange: range "+e.inspect()+" did not consist of a single element");return t[0]}function A(e){return e&&void 0!==e.text}function P(e,t){var n=new d(t);e._ranges=[n],O(e,n,!1),e.rangeCount=1,e.isCollapsed=n.collapsed}function I(e){if(e._ranges.length=0,"None"==e.docSelection.type)D(e);else{var t=e.docSelection.createRange();if(A(t))P(e,t);else{e.rangeCount=t.length;for(var n,i=c.getDocument(t.item(0)),r=0;r<e.rangeCount;++r)(n=o.createRange(i)).selectNode(t.item(r)),e._ranges.push(n);e.isCollapsed=1==e.rangeCount&&e._ranges[0].collapsed,O(e,e._ranges[e.rangeCount-1],!1)}}}function B(e,t){for(var n=e.docSelection.createRange(),i=k(t),r=c.getDocument(n.item(0)),o=c.getBody(r).createControlRange(),s=0,a=n.length;s<a;++s)o.add(n.item(s));try{o.add(i)}catch(e){throw new Error("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}o.select(),I(e)}function M(e,t,n){this.nativeSelection=e,this.docSelection=t,this._ranges=[],this.win=n,this.refresh()}N&&n.isHostMethod(N,"createControlRange")&&(R=N.createControlRange(),n.areHostProperties(R,["item","add"])&&(w=!0)),o.features.implementsControlRange=w,s=E?function(e){return e.anchorNode===e.focusNode&&e.anchorOffset===e.focusOffset}:function(e){return!!e.rangeCount&&e.getRangeAt(e.rangeCount-1).collapsed},n.isHostMethod(C,"getRangeAt")?b=function(e,t){try{return e.getRangeAt(t)}catch(e){return null}}:E&&(b=function(e){var t=c.getDocument(e.anchorNode),n=o.createRange(t);return n.setStart(e.anchorNode,e.anchorOffset),n.setEnd(e.focusNode,e.focusOffset),n.collapsed!==this.isCollapsed&&(n.setStart(e.focusNode,e.focusOffset),n.setEnd(e.anchorNode,e.anchorOffset)),n}),o.getSelection=function(e){var t=(e=e||window)[a],n=r(e),i=m?f(e):null;return t?(t.nativeSelection=n,t.docSelection=i,t.refresh(e)):(t=new M(n,i,e),e[a]=t),t},o.getIframeSelection=function(e){return o.getSelection(c.getIframeWindow(e))};var L,H=M.prototype;function j(e,t){for(var n,i=c.getDocument(t[0].startContainer),r=c.getBody(i).createControlRange(),o=0;o<rangeCount;++o){n=k(t[o]);try{r.add(n)}catch(e){throw new Error("setRanges(): Element within the one of the specified Ranges could not be added to control selection (does it have layout?)")}}r.select(),I(e)}if(!p&&E&&n.areHostMethods(C,["removeAllRanges","addRange"])){H.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),D(this)};function U(e,t){var n=l.getRangeDocument(t),i=o.createRange(n);i.collapseToPoint(t.endContainer,t.endOffset),e.nativeSelection.addRange(x(i)),e.nativeSelection.extend(t.startContainer,t.startOffset),e.refresh()}H.addRange=T?function(e,t){var n,i;w&&m&&this.docSelection.type==u?B(this,e):t&&y?U(this,e):(i=_?this.rangeCount:(this.removeAllRanges(),0),this.nativeSelection.addRange(x(e)),this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==i+1?(!o.config.checkSelectionRanges||(n=b(this.nativeSelection,this.rangeCount-1))&&!l.rangesEqual(n,e)&&(e=new d(n)),this._ranges[this.rangeCount-1]=e,O(this,e,W(this.nativeSelection)),this.isCollapsed=s(this)):this.refresh())}:function(e,t){t&&y?U(this,e):(this.nativeSelection.addRange(x(e)),this.refresh())},H.setRanges=function(e){if(w&&1<e.length)j(this,e);else{this.removeAllRanges();for(var t=0,n=e.length;t<n;++t)this.addRange(e[t])}}}else{if(!(n.isHostMethod(C,"empty")&&n.isHostMethod(v,"select")&&w&&p))return e.fail("No means of selecting a Range or TextRange was found"),!1;H.removeAllRanges=function(){try{var e,t;this.docSelection.empty(),"None"!=this.docSelection.type&&(this.anchorNode?e=c.getDocument(this.anchorNode):this.docSelection.type!=u||(t=this.docSelection.createRange()).length&&(e=c.getDocument(t.item(0)).body.createTextRange()),e&&(e.body.createTextRange().select(),this.docSelection.empty()))}catch(e){}D(this)},H.addRange=function(e){this.docSelection.type==u?B(this,e):(d.rangeToTextRange(e).select(),this._ranges[0]=e,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,O(this,e,!1))},H.setRanges=function(e){this.removeAllRanges();var t=e.length;1<t?j(this,e):t&&this.addRange(e[0])}}if(H.getRangeAt=function(e){if(e<0||e>=this.rangeCount)throw new i("INDEX_SIZE_ERR");return this._ranges[e]},p)L=function(e){var t;o.isSelectionValid(e.win)?t=e.docSelection.createRange():(t=c.getBody(e.win.document).createTextRange()).collapse(!0),e.docSelection.type==u?I(e):A(t)?P(e,t):D(e)};else if(n.isHostMethod(C,"getRangeAt")&&"number"==typeof C.rangeCount)L=function(e){if(w&&m&&e.docSelection.type==u)I(e);else if(e._ranges.length=e.rangeCount=e.nativeSelection.rangeCount,e.rangeCount){for(var t=0,n=e.rangeCount;t<n;++t)e._ranges[t]=new o.WrappedRange(e.nativeSelection.getRangeAt(t));O(e,e._ranges[e.rangeCount-1],W(e.nativeSelection)),e.isCollapsed=s(e)}else D(e)};else{if(!E||typeof C.isCollapsed!=t||typeof v.collapsed!=t||!o.features.implementsDomRange)return e.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;L=function(e){var t,n,i,r=e.nativeSelection;r.anchorNode?(t=b(r,0),e._ranges=[t],e.rangeCount=1,i=(n=e).nativeSelection,n.anchorNode=i.anchorNode,n.anchorOffset=i.anchorOffset,n.focusNode=i.focusNode,n.focusOffset=i.focusOffset,e.isCollapsed=s(e)):D(e)}}H.refresh=function(e){var t=e?this._ranges.slice(0):null;if(L(this),e){var n=t.length;if(n!=this._ranges.length)return!1;for(;n--;)if(!l.rangesEqual(t[n],this._ranges[n]))return!1;return!0}};function Q(e,t){var n=e.getAllRanges(),i=!1;e.removeAllRanges();for(var r=0,o=n.length;r<o;++r)i||t!==n[r]?e.addRange(n[r]):i=!0;e.rangeCount||D(e)}var W;function F(e,t){if(e.anchorNode&&c.getDocument(e.anchorNode)!==c.getDocument(t))throw new i("WRONG_DOCUMENT_ERR")}function K(e){var t=[],n=new h(e.anchorNode,e.anchorOffset),i=new h(e.focusNode,e.focusOffset),r="function"==typeof e.getName?e.getName():"Selection";if(void 0!==e.rangeCount)for(var o=0,s=e.rangeCount;o<s;++o)t[o]=l.inspect(e.getRangeAt(o));return"["+r+"(Ranges: "+t.join(", ")+")(anchor: "+n.inspect()+", focus: "+i.inspect()+"]"}H.removeRange=w?function(e){if(this.docSelection.type==u){for(var t=this.docSelection.createRange(),n=k(e),i=c.getDocument(t.item(0)),r=c.getBody(i).createControlRange(),o=!1,s=0,a=t.length;s<a;++s)t.item(s)!==n||o?r.add(t.item(s)):o=!0;r.select(),I(this)}else Q(this,e)}:function(e){Q(this,e)},!p&&E&&o.features.implementsDomRange?(W=function(e){var t=!1;return e.anchorNode&&(t=1==c.comparePoints(e.anchorNode,e.anchorOffset,e.focusNode,e.focusOffset)),t},H.isBackwards=function(){return W(this)}):W=H.isBackwards=function(){return!1},H.toString=function(){for(var e=[],t=0,n=this.rangeCount;t<n;++t)e[t]=""+this._ranges[t];return e.join("")},H.collapse=function(e,t){F(this,e);var n=o.createRange(c.getDocument(e));n.collapseToPoint(e,t),this.removeAllRanges(),this.addRange(n),this.isCollapsed=!0},H.collapseToStart=function(){if(!this.rangeCount)throw new i("INVALID_STATE_ERR");var e=this._ranges[0];this.collapse(e.startContainer,e.startOffset)},H.collapseToEnd=function(){if(!this.rangeCount)throw new i("INVALID_STATE_ERR");var e=this._ranges[this.rangeCount-1];this.collapse(e.endContainer,e.endOffset)},H.selectAllChildren=function(e){F(this,e);var t=o.createRange(c.getDocument(e));t.selectNodeContents(e),this.removeAllRanges(),this.addRange(t)},H.deleteFromDocument=function(){if(w&&m&&this.docSelection.type==u){for(var e,t=this.docSelection.createRange();t.length;)e=t.item(0),t.remove(e),e.parentNode.removeChild(e);this.refresh()}else if(this.rangeCount){var n=this.getAllRanges();this.removeAllRanges();for(var i=0,r=n.length;i<r;++i)n[i].deleteContents();this.addRange(n[r-1])}},H.getAllRanges=function(){return this._ranges.slice(0)},H.setSingleRange=function(e){this.setRanges([e])},H.containsNode=function(e,t){for(var n=0,i=this._ranges.length;n<i;++n)if(this._ranges[n].containsNode(e,t))return!0;return!1},H.toHtml=function(){var e="";if(this.rangeCount){for(var t=l.getRangeDocument(this._ranges[0]).createElement("div"),n=0,i=this._ranges.length;n<i;++n)t.appendChild(this._ranges[n].cloneContents());e=t.innerHTML}return e},H.getName=function(){return"WrappedSelection"},H.inspect=function(){return K(this)},H.detach=function(){this.win[a]=null,this.win=this.anchorNode=this.focusNode=null},M.inspect=K,o.Selection=M,o.selectionPrototype=H,o.addCreateMissingNativeApiListener(function(e){void 0===e.getSelection&&(e.getSelection=function(){return o.getSelection(this)}),e=null})}),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),"indexOf"in Array.prototype||(Array.prototype.indexOf=function(e,t){void 0===t&&(t=0),t<0&&(t+=this.length),t<0&&(t=0);for(var n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1}),"lastIndexOf"in Array.prototype||(Array.prototype.lastIndexOf=function(e,t){for(void 0===t&&(t=this.length-1),t<0&&(t+=this.length),t>this.length-1&&(t=this.length-1),t++;0<t--;)if(t in this&&this[t]===e)return t;return-1}),"map"in Array.prototype||(Array.prototype.map=function(e,t){for(var n=new Array(this.length),i=0,r=this.length;i<r;i++)i in this&&(n[i]=e.call(t,this[i],i,this));return n}),"filter"in Array.prototype||(Array.prototype.filter=function(e,t){for(var n,i=[],r=0,o=this.length;r<o;r++)r in this&&e.call(t,n=this[r],r,this)&&i.push(n);return i}),function(){var t={changeIdAttribute:"data-cid",userIdAttribute:"data-userid",userNameAttribute:"data-username",timeAttribute:"data-time",attrValuePrefix:"",blockEl:"p",blockEls:["p","ol","ul","li","h1","h2","h3","h4","h5","h6","blockquote"],stylePrefix:"cts",currentUser:{id:null,name:null},changeTypes:{insertType:{tag:"span",alias:"ins",action:"Inserted"},deleteType:{tag:"span",alias:"del",action:"Deleted"}},handleEvents:!1,contentEditable:!0,isTracking:!0,noTrack:".ice-no-track",avoid:".ice-avoid",mergeBlocks:!0},e=function(e){if(this._changes={},!(e=e||{}).element)throw Error("`options.element` must be defined for ice construction.");ice.dom.extend(!0,this,t,e),this.pluginsManager=new ice.IcePluginManager(this),e.plugins&&this.pluginsManager.usePlugins("ice-init",e.plugins)};e.prototype={_userStyles:{},_styles:{},_uniqueStyleIndex:0,_browserType:null,_batchChangeid:null,_uniqueIDIndex:1,_delBookmark:"tempdel",isPlaceHoldingDeletes:!1,startTracking:function(){var t;return this.element.setAttribute("contentEditable",this.contentEditable),this.handleEvents&&(t=this,ice.dom.bind(t.element,"keyup.ice keydown.ice keypress.ice mousedown.ice mouseup.ice",function(e){return t.handleEvent(e)})),this.initializeEnvironment(),this.initializeEditor(),this.findTrackTags(),this.initializeRange(),this.pluginsManager.fireEnabled(this.element),this},stopTracking:function(){return this.element.setAttribute("contentEditable",!this.contentEditable),this.handleEvents&&ice.dom.unbind(this.element,"keyup.ice keydown.ice keypress.ice mousedown.ice mouseup.ice"),this.pluginsManager.fireDisabled(this.element),this},initializeEnvironment:function(){this.env||(this.env={}),this.env.element=this.element,this.env.document=this.element.ownerDocument,this.env.window=this.env.document.defaultView||this.env.document.parentWindow||window,this.env.frame=this.env.window.frameElement,this.env.selection=this.selection=new ice.Selection(this.env),this.env.document.createElement(this.changeTypes.insertType.tag),this.env.document.createElement(this.changeTypes.deleteType.tag)},initializeRange:function(){var e=this.selection.createRange();e.setStart(ice.dom.find(this.element,this.blockEls.join(", "))[0],0),e.collapse(!0),this.selection.addRange(e),this.env.frame?this.env.frame.contentWindow.focus():this.element.focus()},initializeEditor:function(){var e=this.env.document.createElement("div");this.element.childNodes.length?(e.innerHTML=this.element.innerHTML,ice.dom.removeWhitespace(e),""===e.innerHTML&&e.appendChild(ice.dom.create("<"+this.blockEl+" ><br/></"+this.blockEl+">"))):e.appendChild(ice.dom.create("<"+this.blockEl+" ><br/></"+this.blockEl+">")),this.element.innerHTML!=e.innerHTML&&(this.element.innerHTML=e.innerHTML)},findTrackTags:function(){var l=this,d=[];for(var e in this.changeTypes)d.push(this._getIceNodeClass(e));ice.dom.each(ice.dom.find(this.element,"."+d.join(", .")),function(e,t){for(var n=0,i="",r=t.className.split(" "),e=0;e<r.length;e++){var o=new RegExp(l.stylePrefix+"-(\\d+)").exec(r[e]);o&&(n=o[1]);var s=new RegExp("("+d.join("|")+")").exec(r[e]);s&&(i=l._getChangeTypeFromAlias(s[1]))}var a=ice.dom.attr(t,l.userIdAttribute);l.setUserStyle(a,Number(n));var c=ice.dom.attr(t,l.changeIdAttribute);l._changes[c]={type:i,userid:a,username:ice.dom.attr(t,l.userNameAttribute),time:ice.dom.attr(t,l.timeAttribute)}})},enableChangeTracking:function(){this.isTracking=!0,this.pluginsManager.fireEnabled(this.element)},disableChangeTracking:function(){this.isTracking=!1,this.pluginsManager.fireDisabled(this.element)},setCurrentUser:function(e){this.currentUser=e},handleEvent:function(e){if(this.isTracking)if("mouseup"==e.type){var t=this;setTimeout(function(){t.mouseUp(e)},200)}else{if("mousedown"==e.type)return this.mouseDown(e);var n;if("keypress"==e.type)return(n=this.keyPress(e))||e.preventDefault(),n;if("keydown"==e.type)return(n=this.keyDown(e))||e.preventDefault(),n;"keyup"==e.type&&this.pluginsManager.fireCaretUpdated()}},visible:function(e){e.nodeType===ice.dom.TEXT_NODE&&(e=e.parentNode);var t=e.getBoundingClientRect();return 0<t.top&&0<t.left},createIceNode:function(e,t){var n=this.env.document.createElement(this.changeTypes[e].tag);return ice.dom.addClass(n,this._getIceNodeClass(e)),n.appendChild(t||this.env.document.createTextNode("")),this.addChange(this.changeTypes[e].alias,[n]),this.pluginsManager.fireNodeCreated(n,{action:this.changeTypes[e].action}),n},insert:function(e,t){var n,i=!e;e=e||"\ufeff",t?this.selection.addRange(t):t=this.getCurrentRange(),"string"==typeof e&&(e=document.createTextNode(e)),t.collapsed||(this.deleteContents(),(t=this.getCurrentRange()).startContainer===t.endContainer&&this.element===t.startContainer&&(ice.dom.empty(this.element),n=t.getLastSelectableChild(this.element),t.setStartAfter(n),t.collapse(!0))),this._moveRangeToValidTrackingPos(t);var r=this.startBatchChange();return this._insertNode(e,t,i),this.pluginsManager.fireNodeInserted(e,t),this.endBatchChange(r),i},placeholdDeletes:function(){var n=this;this.isPlaceholdingDeletes&&this.revertDeletePlaceholders(),this.isPlaceholdingDeletes=!0,this._deletes=[];var e="."+this._getIceNodeClass("deleteType");return ice.dom.each(ice.dom.find(this.element,e),function(e,t){n._deletes.push(ice.dom.cloneNode(t)),ice.dom.replaceWith(t,"<"+n._delBookmark+' data-allocation="'+(n._deletes.length-1)+'"/>')}),!0},revertDeletePlaceholders:function(){var n=this;return!!this.isPlaceholdingDeletes&&(ice.dom.each(this._deletes,function(e,t){ice.dom.find(n.element,n._delBookmark+"[data-allocation="+e+"]").replaceWith(t)}),!(this.isPlaceholdingDeletes=!1))},deleteContents:function(e,t){var n=!0,i=ice.dom.browser();t?this.selection.addRange(t):t=this.getCurrentRange();var r=this.startBatchChange(this.changeTypes.deleteType.alias);if(!1===t.collapsed)this._currentUserIceNode(t.startContainer.parentNode)?this._deleteSelection(t):(this._deleteSelection(t),"mozilla"===i.type?(t.startContainer.parentNode.previousSibling?(t.setEnd(t.startContainer.parentNode.previousSibling,0),t.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(t.endContainer))):t.setEndAfter(t.startContainer.parentNode),t.collapse(!1)):this.visible(t.endContainer)||(t.setEnd(t.endContainer,t.endOffset-1),t.collapse(!1)));else if(e)if("mozilla"===i.type)n=this._deleteRight(t),this.visible(t.endContainer)||(t.endContainer.parentNode.nextSibling?t.setEndBefore(t.endContainer.parentNode.nextSibling):t.setEndAfter(t.endContainer),t.collapse(!1));else{if(t.endOffset===ice.dom.getNodeCharacterLength(t.endContainer)){var o=t.startContainer.nextSibling;if(ice.dom.is(o,"."+this._getIceNodeClass("deleteType")))for(;o;){if(!ice.dom.is(o,"."+this._getIceNodeClass("deleteType"))){t.setStart(o,0),t.collapse(!0);break}o=o.nextSibling}}n=this._deleteRight(t),this.visible(t.endContainer)||ice.dom.is(t.endContainer.parentNode,"."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"))&&(t.setStartAfter(t.endContainer.parentNode),t.collapse(!0))}else if("mozilla"===i.type)n=this._deleteLeft(t),this.visible(t.startContainer)||(t.startContainer.parentNode.previousSibling?t.setEnd(t.startContainer.parentNode.previousSibling,0):t.setEnd(t.startContainer.parentNode,0),t.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(t.endContainer)),t.collapse(!1));else{if(!this.visible(t.startContainer)&&t.endOffset===ice.dom.getNodeCharacterLength(t.endContainer)){var s=t.startContainer.previousSibling;if(ice.dom.is(s,"."+this._getIceNodeClass("deleteType")))for(;s;){if(!ice.dom.is(s,"."+this._getIceNodeClass("deleteType"))){t.setEndBefore(s.nextSibling,0),t.collapse(!1);break}s=s.prevSibling}}n=this._deleteLeft(t)}return this.selection.addRange(t),this.endBatchChange(r),n},getChanges:function(){return this._changes},getChangeUserids:function(){var e=[],t=Object.keys(this._changes);for(var n in t)e.push(this._changes[t[n]].userid);return e.sort().filter(function(e,t,n){return t==n.indexOf(e)?1:0})},getElementContent:function(){return this.element.innerHTML},getCleanContent:function(e,t,n){var i="",r=this;ice.dom.each(this.changeTypes,function(e,t){"deleteType"!=e&&(0<t&&(i+=","),i+="."+r._getIceNodeClass(e))}),e=e?"string"==typeof e?ice.dom.create("<div>"+e+"</div>"):ice.dom.cloneNode(e,!1)[0]:ice.dom.cloneNode(this.element,!1)[0],e=n?n.call(this,e):e;var o=ice.dom.find(e,i);ice.dom.each(o,function(e,t){ice.dom.replaceWith(this,ice.dom.contents(this))});var s=ice.dom.find(e,"."+this._getIceNodeClass("deleteType"));return ice.dom.remove(s),(e=t?t.call(this,e):e).innerHTML},acceptAll:function(){this.element.innerHTML=this.getCleanContent()},rejectAll:function(){var e="."+this._getIceNodeClass("insertType"),t="."+this._getIceNodeClass("deleteType");ice.dom.remove(ice.dom.find(this.element,e)),ice.dom.each(ice.dom.find(this.element,t),function(e,t){ice.dom.replaceWith(t,ice.dom.contents(t))})},acceptChange:function(e){this.acceptRejectChange(e,!0)},rejectChange:function(e){this.acceptRejectChange(e,!1)},acceptRejectChange:function(e,t){var n,i,r,o,s,a,c,l=ice.dom;if(!e){var d=this.getCurrentRange();if(!d.collapsed)return;e=d.startContainer}r=(n=o="."+this._getIceNodeClass("deleteType"))+","+(i=s="."+this._getIceNodeClass("insertType")),a=l.getNode(e,r),c=l.find(this.element,"["+this.changeIdAttribute+"="+l.attr(a,this.changeIdAttribute)+"]"),t||(o=i,s=n),ice.dom.is(a,s)?l.each(c,function(e,t){l.replaceWith(t,ice.dom.contents(t))}):l.is(a,o)&&l.remove(c)},isInsideChange:function(e){var t="."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType");if(!e){if(range=this.getCurrentRange(),!range.collapsed)return!1;e=range.startContainer}return!!ice.dom.getNode(e,t)},addChangeType:function(e,t,n,i){var r={tag:t,alias:n};i&&(r.action=i),this.changeTypes[e]=r},getIceNode:function(e,t){var n="."+this._getIceNodeClass(t);return ice.dom.getNode(e,n)},_moveRangeToValidTrackingPos:function(e){for(var t=!1,n=this._getVoidElement(e.endContainer);n;){try{e.moveEnd(ice.dom.CHARACTER_UNIT,1),e.moveEnd(ice.dom.CHARACTER_UNIT,-1)}catch(e){t=!0}if(t||ice.dom.onBlockBoundary(e.endContainer,e.startContainer,this.blockEls)){e.setStartAfter(n),e.collapse(!0);break}(n=this._getVoidElement(e.endContainer))?(e.setEnd(e.endContainer,0),e.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(e.endContainer)),e.collapse()):(e.setStart(e.endContainer,0),e.collapse(!0))}},_getNoTrackElement:function(e){var t=this._getNoTrackSelector();return ice.dom.is(e,t)?e:ice.dom.parents(e,t)[0]||null},_getNoTrackSelector:function(){return this.noTrack},_getVoidElement:function(e){var t=this._getVoidElSelector();return ice.dom.is(e,t)?e:ice.dom.parents(e,t)[0]||null},_getVoidElSelector:function(){return"."+this._getIceNodeClass("deleteType")+","+this.avoid},_currentUserIceNode:function(e){return ice.dom.attr(e,this.userIdAttribute)==this.currentUser.id},_getChangeTypeFromAlias:function(e){var t,n=null;for(t in this.changeTypes)this.changeTypes.hasOwnProperty(t)&&this.changeTypes[t].alias==e&&(n=t);return n},_getIceNodeClass:function(e){return this.attrValuePrefix+this.changeTypes[e].alias},getUserStyle:function(e){return this._userStyles[e]?this._userStyles[e]:this.setUserStyle(e,this.getNewStyleId())},setUserStyle:function(e,t){var n=this.stylePrefix+"-"+t;return this._styles[t]||(this._styles[t]=!0),this._userStyles[e]=n},getNewStyleId:function(){var e=++this._uniqueStyleIndex;return this._styles[e]?this.getNewStyleId():(this._styles[e]=!0,e)},addChange:function(e,t){var n=this._batchChangeid||this.getNewChangeId();this._changes[n]||(this._changes[n]={type:this._getChangeTypeFromAlias(e),time:(new Date).getTime(),userid:this.currentUser.id,username:this.currentUser.name});var i=this;return ice.dom.foreach(t,function(e){i.addNodeToChange(n,t[e])}),n},addNodeToChange:function(e,t){null!==this._batchChangeid&&(e=this._batchChangeid);var n=this.getChange(e);t.getAttribute(this.changeIdAttribute)||t.setAttribute(this.changeIdAttribute,e),t.getAttribute(this.userIdAttribute)||t.setAttribute(this.userIdAttribute,n.userid),t.getAttribute(this.userNameAttribute)||t.setAttribute(this.userNameAttribute,n.username),t.getAttribute(this.timeAttribute)||t.setAttribute(this.timeAttribute,n.time),ice.dom.hasClass(t,this._getIceNodeClass(n.type))||ice.dom.addClass(t,this._getIceNodeClass(n.type));var i=this.getUserStyle(n.userid);ice.dom.hasClass(t,i)||ice.dom.addClass(t,i)},getChange:function(e){var t=null;return this._changes[e]&&(t=this._changes[e]),t},getNewChangeId:function(){var e=++this._uniqueIDIndex;return this._changes[e]&&(e=this.getNewChangeId()),e},startBatchChange:function(){return this._batchChangeid=this.getNewChangeId(),this._batchChangeid},endBatchChange:function(e){e===this._batchChangeid&&(this._batchChangeid=null)},getCurrentRange:function(){return this.selection.getRangeAt(0)},_insertNode:function(e,t,n){ice.dom.isBlockElement(t.startContainer)||ice.dom.canContainTextElement(ice.dom.getBlockParent(t.startContainer,this.element))||!t.startContainer.previousSibling||t.setStart(t.startContainer.previousSibling,0);t.startContainer;var i=ice.dom.isBlockElement(t.startContainer)&&t.startContainer||ice.dom.getBlockParent(t.startContainer,this.element)||null;if(i===this.element){var r=document.createElement(this.blockEl);return i.appendChild(r),t.setStart(r,0),t.collapse(),this._insertNode(e,t,n)}ice.dom.hasNoTextOrStubContent(i)&&(ice.dom.empty(i),ice.dom.append(i,"<br>"),t.setStart(i,0));var o=this.getIceNode(t.startContainer,"insertType"),s=this._currentUserIceNode(o);n&&s||(s||(e=this.createIceNode("insertType",e)),t.insertNode(e),t.setEnd(e,1),n?t.setStart(e,0):t.collapse(),this.selection.addRange(t))},_handleVoidEl:function(e,t){var n=this._getVoidElement(e);return!(!n||this.getIceNode(n,"deleteType"))&&(t.collapse(!0),!0)},_deleteSelection:function(e){for(var t=new ice.Bookmark(this.env,e),n=ice.dom.getElementsBetween(t.start,t.end),i=ice.dom.parents(e.startContainer,this.blockEls.join(", "))[0],r=ice.dom.parents(e.endContainer,this.blockEls.join(", "))[0],o=new Array,s=0;s<n.length;s++){var a=n[s];if(!ice.dom.isBlockElement(a)||(o.push(a),ice.dom.canContainTextElement(a))){if((a.nodeType!==ice.dom.TEXT_NODE||0!==ice.dom.getNodeTextContent(a).length)&&!this._getVoidElement(a)){if(a.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.BREAK_ELEMENT==ice.dom.getTagName(a))continue;if(ice.dom.isStubElement(a)){this._addNodeTracking(a,!1,!0);continue}for(ice.dom.hasNoTextOrStubContent(a)&&ice.dom.remove(a),j=0;j<a.childNodes.length;j++){var c=a.childNodes[j];n.push(c)}continue}var l=ice.dom.getBlockParent(a);this._addNodeTracking(a,!1,!0,!0),ice.dom.hasNoTextOrStubContent(l)&&ice.dom.remove(l)}}else for(var d=0;d<a.childNodes.length;d++)n.push(a.childNodes[d])}if(this.mergeBlocks&&i!==r){for(;o.length;)ice.dom.mergeContainers(o.shift(),i);ice.dom.removeBRFromChild(r),ice.dom.removeBRFromChild(i),ice.dom.mergeContainers(r,i)}t.selectBookmark(),e.collapse(!0)},_deleteRight:function(e){var t,n,i=ice.dom.isBlockElement(e.startContainer)&&e.startContainer||ice.dom.getBlockParent(e.startContainer,this.element)||null,r=!!i&&ice.dom.hasNoTextOrStubContent(i),o=i&&ice.dom.getNextContentNode(i,this.element),s=!!o&&ice.dom.hasNoTextOrStubContent(o),a=e.endContainer,c=e.endOffset,l=e.commonAncestorContainer;if(r)return!1;if(l.nodeType!==ice.dom.TEXT_NODE){if(0===c&&ice.dom.isBlockElement(l)&&!ice.dom.canContainTextElement(l)){var d=l.firstElementChild;if(d)return e.setStart(d,0),e.collapse(),this._deleteRight(e)}if(l.childNodes.length>c){var h=document.createTextNode(" ");return l.insertBefore(h,l.childNodes[c]),e.setStart(h,1),e.collapse(!0),n=this._deleteRight(e),ice.dom.remove(h),n}return t=ice.dom.getNextContentNode(l,this.element),e.setEnd(t,0),e.collapse(),this._deleteRight(e)}if(e.moveEnd(ice.dom.CHARACTER_UNIT,1),e.moveEnd(ice.dom.CHARACTER_UNIT,-1),c===a.data.length&&!ice.dom.hasNoTextOrStubContent(a)){if(!(t=ice.dom.getNextNode(a,this.element)))return e.selectNodeContents(a),e.collapse(),!1;if(ice.dom.BREAK_ELEMENT==ice.dom.getTagName(t)&&(t=ice.dom.getNextNode(t,this.element)),t.nodeType===ice.dom.TEXT_NODE&&(t=t.parentNode),!t.isContentEditable){n=this._addNodeTracking(t,!1,!1);var u=document.createTextNode("");return t.parentNode.insertBefore(u,t.nextSibling),e.selectNode(u),e.collapse(!0),n}if(this._handleVoidEl(t,e))return!0;if(ice.dom.isChildOf(t,i)&&ice.dom.isStubElement(t))return this._addNodeTracking(t,e,!1)}if(this._handleVoidEl(t,e))return!0;if(this._getNoTrackElement(e.endContainer.parentElement))return e.deleteContents(),!1;if(ice.dom.isOnBlockBoundary(e.startContainer,e.endContainer,this.element)){if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(t,this.element),this.blockEl)){o!==ice.dom.getBlockParent(e.endContainer,this.element)&&e.setEnd(o,0);for(var f=ice.dom.getElementsBetween(e.startContainer,e.endContainer),g=0;g<f.length;g++)ice.dom.remove(f[g]);var m=e.startContainer,p=e.endContainer;return ice.dom.remove(ice.dom.find(m,"br")),ice.dom.remove(ice.dom.find(p,"br")),ice.dom.mergeBlockWithSibling(e,ice.dom.getBlockParent(e.endContainer,this.element)||i)}return s?ice.dom.remove(o):e.setStart(o,0),e.collapse(!0),!0}var C=e.endContainer.splitText(e.endOffset);C.splitText(1);return this._addNodeTracking(C,e,!1)},_deleteLeft:function(e){var t,n,i=ice.dom.isBlockElement(e.startContainer)&&e.startContainer||ice.dom.getBlockParent(e.startContainer,this.element)||null,r=!!i&&ice.dom.hasNoTextOrStubContent(i),o=i&&ice.dom.getPrevContentNode(i,this.element),s=!!o&&ice.dom.hasNoTextOrStubContent(o),a=e.startContainer,c=e.startOffset,l=e.commonAncestorContainer;if(r)return!1;if(0===c||l.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.isBlockElement(l)&&!ice.dom.canContainTextElement(l))if(0===c){var d=l.firstElementChild;if(d)return e.setStart(d,0),e.collapse(),this._deleteLeft(e)}else{var h=l.lastElementChild;if(h&&(t=e.getLastSelectableChild(h)))return e.setStart(t,t.data.length),e.collapse(),this._deleteLeft(e)}if(!(n=0===c?ice.dom.getPrevContentNode(a,this.element):l.childNodes[c-1]))return!1;if(ice.dom.is(n,"."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"))&&0<n.childNodes.length&&n.lastChild&&(n=n.lastChild),n.nodeType===ice.dom.TEXT_NODE&&(n=n.parentNode),!n.isContentEditable){var u=this._addNodeTracking(n,!1,!0),f=document.createTextNode("");return n.parentNode.insertBefore(f,n),e.selectNode(f),e.collapse(!0),u}if(this._handleVoidEl(n,e))return!0;if(ice.dom.isStubElement(n)&&ice.dom.isChildOf(n,i)||!n.isContentEditable)return this._addNodeTracking(n,e,!0);if(ice.dom.isStubElement(n))return ice.dom.remove(n),e.collapse(!0),!1;if(n!==i&&!ice.dom.isChildOf(n,i)){if(ice.dom.canContainTextElement(n)||(n=n.lastElementChild),n.lastChild&&n.lastChild.nodeType!==ice.dom.TEXT_NODE&&ice.dom.isStubElement(n.lastChild)&&"BR"!==n.lastChild.tagName)return e.setStartAfter(n.lastChild),e.collapse(!0),!0;if((t=e.getLastSelectableChild(n))&&!ice.dom.isOnBlockBoundary(e.startContainer,t,this.element))return e.selectNodeContents(t),e.collapse(),!0}}if(1===c&&!ice.dom.isBlockElement(l)&&1<e.startContainer.childNodes.length&&e.startContainer.childNodes[0].nodeType===ice.dom.TEXT_NODE&&0===e.startContainer.childNodes[0].data.length)return e.setStart(e.startContainer,0),this._deleteLeft(e);if(e.moveStart(ice.dom.CHARACTER_UNIT,-1),e.moveStart(ice.dom.CHARACTER_UNIT,1),this._getNoTrackElement(e.startContainer.parentElement))return e.deleteContents(),!1;if(ice.dom.isOnBlockBoundary(e.startContainer,e.endContainer,this.element)){if(s)return ice.dom.remove(o),e.collapse(),!0;if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(n,this.element),this.blockEl)){o!==ice.dom.getBlockParent(e.startContainer,this.element)&&e.setStart(o,o.childNodes.length);for(var g=ice.dom.getElementsBetween(e.startContainer,e.endContainer),m=0;m<g.length;m++)ice.dom.remove(g[m]);var p=e.startContainer,C=e.endContainer;return ice.dom.remove(ice.dom.find(p,"br")),ice.dom.remove(ice.dom.find(C,"br")),ice.dom.mergeBlockWithSibling(e,ice.dom.getBlockParent(e.endContainer,this.element)||i)}return o&&o.lastChild&&ice.dom.isStubElement(o.lastChild)?(e.setStartAfter(o.lastChild),e.collapse(!0),!0):((t=e.getLastSelectableChild(o))?(e.setStart(t,t.data.length),e.collapse(!0)):o&&(e.setStart(o,o.childNodes.length),e.collapse(!0)),!0)}var v=e.startContainer.splitText(e.startOffset-1);v.splitText(1);return this._addNodeTracking(v,e,!0)},_addNodeTracking:function(e,t,n){var i=this.getIceNode(e,"insertType");if(i&&this._currentUserIceNode(i)){t&&n&&t.selectNode(e),e.parentNode.removeChild(e);var r,o=ice.dom.cloneNode(i);return ice.dom.remove(ice.dom.find(o,".iceBookmark")),null!==i&&ice.dom.hasNoTextOrStubContent(o[0])&&(r=this.env.document.createTextNode(""),ice.dom.insertBefore(i,r),t&&(t.setStart(r,0),t.collapse(!0)),ice.dom.replaceWith(i,ice.dom.contents(i))),!0}if(t&&this.getIceNode(e,"deleteType")){e.normalize();var s=!1;if(n){for(var a,c=ice.dom.getPrevContentNode(e,this.element);!s;)(h=this.getIceNode(c,"deleteType"))?c=ice.dom.getPrevContentNode(c,this.element):s=!0;return c&&((a=t.getLastSelectableChild(c))&&(c=a),t.setStart(c,ice.dom.getNodeCharacterLength(c)),t.collapse(!0)),!0}for(var l=ice.dom.getNextContentNode(e,this.element);!s;)(h=this.getIceNode(l,"deleteType"))?l=ice.dom.getNextContentNode(l,this.element):s=!0;return l&&(t.selectNodeContents(l),t.collapse(!0)),!0}e.previousSibling&&e.previousSibling.nodeType===ice.dom.TEXT_NODE&&0===e.previousSibling.length&&e.parentNode.removeChild(e.previousSibling),e.nextSibling&&e.nextSibling.nodeType===ice.dom.TEXT_NODE&&0===e.nextSibling.length&&e.parentNode.removeChild(e.nextSibling);var d,h,u=this.getIceNode(e.previousSibling,"deleteType"),f=this.getIceNode(e.nextSibling,"deleteType");return u&&this._currentUserIceNode(u)?((h=u).appendChild(e),f&&this._currentUserIceNode(f)&&(d=ice.dom.extractContent(f),ice.dom.append(h,d),f.parentNode.removeChild(f))):f&&this._currentUserIceNode(f)?(h=f).insertBefore(e,h.firstChild):(h=this.createIceNode("deleteType"),e.parentNode.insertBefore(h,e),h.appendChild(e)),t&&(ice.dom.isStubElement(e)?t.selectNode(e):t.selectNodeContents(e),n?t.collapse(!0):t.collapse(),e.normalize()),!0},_handleAncillaryKey:function(e){var t=e.keyCode?e.keyCode:e.which,n=ice.dom.browser(),i=!0,r=(e.shiftKey,this.getCurrentRange());switch(t){case ice.dom.DOM_VK_DELETE:i=this.deleteContents(),this.pluginsManager.fireKeyPressed(e);break;case 46:i=this.deleteContents(!0),this.pluginsManager.fireKeyPressed(e);break;case ice.dom.DOM_VK_DOWN:case ice.dom.DOM_VK_UP:case ice.dom.DOM_VK_LEFT:this.pluginsManager.fireCaretPositioned(),"mozilla"===n.type&&(this.visible(r.startContainer)||(r.startContainer.parentNode.previousSibling?(r.setEnd(r.startContainer.parentNode.previousSibling,0),r.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(r.endContainer))):r.setEnd(r.startContainer.parentNode.nextSibling,0),r.collapse(!1))),i=!1;break;case ice.dom.DOM_VK_RIGHT:this.pluginsManager.fireCaretPositioned(),"mozilla"===n.type&&(this.visible(r.startContainer)||r.startContainer.parentNode.nextSibling&&(r.setStart(r.startContainer.parentNode.nextSibling,0),r.collapse(!0))),i=!1;break;case 32:i=!0;r=this.getCurrentRange();this._moveRangeToValidTrackingPos(r,r.startContainer),this.insert(" ",r);break;default:i=!1}return!0!==i||(ice.dom.preventDefault(e),!1)},keyDown:function(e){if(!this.pluginsManager.fireKeyDown(e))return ice.dom.preventDefault(e),!1;var t=!1;if(!1===this._handleSpecialKey(e))return!0!==ice.dom.isBrowser("msie")&&(this._preventKeyPress=!0),!1;if(!(!0!==e.ctrlKey&&!0!==e.metaKey||!0!==ice.dom.isBrowser("msie")&&!0!==ice.dom.isBrowser("chrome")||this.pluginsManager.fireKeyPressed(e)))return!1;switch(e.keyCode){case 27:break;default:!0!==/Firefox/.test(navigator.userAgent)&&(t=!this._handleAncillaryKey(e))}return!t||(ice.dom.preventDefault(e),!1)},keyPress:function(e){if(!0!==this._preventKeyPress){if(!this.pluginsManager.fireKeyPress(e))return!1;var t=null;null==e.which?t=String.fromCharCode(e.keyCode):0<e.which&&(t=String.fromCharCode(e.which));var n=this.getCurrentRange(),i=ice.dom.parents(n.startContainer,"br")[0]||null;if(i&&(n.moveToNextEl(i),i.parentNode.removeChild(i)),null!==t&&!0!==e.ctrlKey&&!0!==e.metaKey)switch(e.keyCode?e.keyCode:e.which){case ice.dom.DOM_VK_DELETE:return this._handleAncillaryKey(e);case ice.dom.DOM_VK_ENTER:return this._handleEnter();case 32:return this._handleAncillaryKey(e);default:return this._moveRangeToValidTrackingPos(n,n.startContainer),this.insert()}return this._handleAncillaryKey(e)}this._preventKeyPress=!1},_handleEnter:function(){return this.getCurrentRange().collapsed||this.deleteContents(),!0},_handleSpecialKey:function(e){var t=e.which;null===t&&(t=e.keyCode);var n,i,r,o,s=!1;switch(t){case 65:!0!==e.ctrlKey&&!0!==e.metaKey||(s=!0,n=this.getCurrentRange(),!0===ice.dom.isBrowser("msie")?(i=this.env.document.createTextNode(""),r=this.env.document.createTextNode(""),this.element.firstChild?ice.dom.insertBefore(this.element.firstChild,i):this.element.appendChild(i),this.element.appendChild(r),n.setStart(i,0),n.setEnd(r,0)):(n.setStart(n.getFirstSelectableChild(this.element),0),o=n.getLastSelectableChild(this.element),n.setEnd(o,o.length)),this.selection.addRange(n))}return!0!==s||(ice.dom.preventDefault(e),!1)},mouseUp:function(e,t){if(!this.pluginsManager.fireClicked(e))return!1;this.pluginsManager.fireSelectionChanged(this.getCurrentRange())},mouseDown:function(e,t){if(!this.pluginsManager.fireMouseDown(e))return!1;this.pluginsManager.fireCaretUpdated()}},this.ice=this.ice||{},this.ice.InlineChangeEditor=e}.call(this),function(){var u={DOM_VK_DELETE:8,DOM_VK_LEFT:37,DOM_VK_UP:38,DOM_VK_RIGHT:39,DOM_VK_DOWN:40,DOM_VK_ENTER:13,ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12,CHARACTER_UNIT:"character",WORD_UNIT:"word",BREAK_ELEMENT:"br",CONTENT_STUB_ELEMENTS:["img","hr","iframe","param","link","meta","input","frame","col","base","area"],BLOCK_ELEMENTS:["p","div","pre","ul","ol","li","table","tbody","td","th","fieldset","form","blockquote","dl","dt","dd","dir","center","address","h1","h2","h3","h4","h5","h6"],TEXT_CONTAINER_ELEMENTS:["p","div","pre","li","td","th","blockquote","dt","dd","center","address","h1","h2","h3","h4","h5","h6"]};u.STUB_ELEMENTS=u.CONTENT_STUB_ELEMENTS.slice(),u.STUB_ELEMENTS.push(u.BREAK_ELEMENT),u.getKeyChar=function(e){return String.fromCharCode(e.which)},u.getClass=function(e,t,n){return t=t||document.body,e="."+e.split(" ").join("."),n&&(e=n+e),jQuery.makeArray(jQuery(t).find(e))},u.getId=function(e,t){return t=t||document,element=t.getElementById(e),element},u.getTag=function(e,t){return t=t||document,jQuery.makeArray(jQuery(t).find(e))},u.getElementWidth=function(e){return e.offsetWidth},u.getElementHeight=function(e){return e.offsetHeight},u.getElementDimensions=function(e){return{width:u.getElementWidth(e),height:u.getElementHeight(e)}},u.trim=function(e){return jQuery.trim(e)},u.empty=function(e){if(e)return jQuery(e).empty()},u.remove=function(e){if(e)return jQuery(e).remove()},u.prepend=function(e,t){jQuery(e).prepend(t)},u.append=function(e,t){jQuery(e).append(t)},u.insertBefore=function(e,t){jQuery(e).before(t)},u.insertAfter=function(e,t){jQuery(e).after(t)},u.getHtml=function(e){return jQuery(e).html()},u.setHtml=function(e,t){e&&jQuery(e).html(t)},u.removeWhitespace=function(e){jQuery(e).contents().filter(function(){return this.nodeType!=ice.dom.TEXT_NODE&&"UL"==this.nodeName||"OL"==this.nodeName?(u.removeWhitespace(this),!1):this.nodeType==ice.dom.TEXT_NODE&&!/\S/.test(this.nodeValue)}).remove()},u.contents=function(e){return jQuery.makeArray(jQuery(e).contents())},u.extractContent=function(e){for(var t,n=document.createDocumentFragment();t=e.firstChild;)n.appendChild(t);return n},u.getNode=function(e,t){return u.is(e,t)?e:u.parents(e,t)[0]||null},u.getParents=function(e,t,n){for(var i=jQuery(e).parents(t),r=i.length,o=[],s=0;s<r&&i[s]!==n;s++)o.push(i[s]);return o},u.hasBlockChildren=function(e){for(var t=e.childNodes.length,n=0;n<t;n++)if(e.childNodes[n].nodeType===u.ELEMENT_NODE&&!0===u.isBlockElement(e.childNodes[n]))return!0;return!1},u.removeTag=function(e,t){return jQuery(e).find(t).replaceWith(function(){return jQuery(this).contents()}),e},u.stripEnclosingTags=function(e,t){var n=jQuery(e);return n.find("*").not(t).replaceWith(function(){var e,t=jQuery();try{t=(e=jQuery(this)).contents()}catch(e){}return 0===t.length&&e.remove(),t}),n[0]},u.getSiblings=function(e,t,n,i){if(!0===n)return"prev"===t?jQuery(e).prevAll():jQuery(e).nextAll();var r=[];if("prev"===t)for(;e.previousSibling&&(e=e.previousSibling)!==i;)r.push(e);else for(;e.nextSibling&&(e=e.nextSibling)!==i;)r.push(e);return r},u.getNodeTextContent=function(e){return jQuery(e).text()},u.getNodeStubContent=function(e){return jQuery(e).find(u.CONTENT_STUB_ELEMENTS.join(", "))},u.hasNoTextOrStubContent=function(e){return!(0<u.getNodeTextContent(e).length)&&!(0<jQuery(e).find(u.CONTENT_STUB_ELEMENTS.join(", ")).length)},u.getNodeCharacterLength=function(e){return u.getNodeTextContent(e).length+jQuery(e).find(u.STUB_ELEMENTS.join(", ")).length},u.setNodeTextContent=function(e,t){return jQuery(e).text(t)},u.getTagName=function(e){return e.tagName&&e.tagName.toLowerCase()||null},u.getIframeDocument=function(e){var t=null;return e.contentDocument?t=e.contentDocument:e.contentWindow?t=e.contentWindow.document:e.document&&(t=e.document),t},u.isBlockElement=function(e){return-1!=u.BLOCK_ELEMENTS.lastIndexOf(e.nodeName.toLowerCase())},u.isStubElement=function(e){return-1!=u.STUB_ELEMENTS.lastIndexOf(e.nodeName.toLowerCase())},u.removeBRFromChild=function(e){if(e&&e.hasChildNodes())for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];n&&ice.dom.BREAK_ELEMENT==ice.dom.getTagName(n)&&n.parentNode.removeChild(n)}},u.isChildOf=function(e,t){try{for(;e&&e.parentNode;){if(e.parentNode===t)return!0;e=e.parentNode}}catch(e){}return!1},u.isChildOfTagName=function(e,t){try{for(;e&&e.parentNode;){if(e.parentNode&&e.parentNode.tagName&&e.parentNode.tagName.toLowerCase()===t)return e.parentNode;e=e.parentNode}}catch(e){}return!1},u.isChildOfTagNames=function(e,t){try{for(;e&&e.parentNode;){if(e.parentNode&&e.parentNode.tagName){tagName=e.parentNode.tagName.toLowerCase();for(var n=0;n<t.length;n++)if(tagName===t[n])return e.parentNode}e=e.parentNode}}catch(e){}return null},u.isChildOfClassName=function(e,t){try{for(;e&&e.parentNode;){if(jQuery(e.parentNode).hasClass(t))return e.parentNode;e=e.parentNode}}catch(e){}return null},u.cloneNode=function(e,t){return void 0===t&&(t=!0),jQuery(e).clone(t)},u.bind=function(e,t,n){return jQuery(e).bind(t,n)},u.unbind=function(e,t,n){return jQuery(e).unbind(t,n)},u.attr=function(e,t,n){return n?jQuery(e).attr(t,n):jQuery(e).attr(t)},u.replaceWith=function(e,t){return jQuery(e).replaceWith(t)},u.removeAttr=function(e,t){jQuery(e).removeAttr(t)},u.getElementsBetween=function(e,t){var n=[];if(e===t)return n;if(!0===u.isChildOf(t,e)){for(var i=e.childNodes.length,r=0;r<i&&e.childNodes[r]!==t;r++){if(!0===u.isChildOf(t,e.childNodes[r]))return u.arrayMerge(n,u.getElementsBetween(e.childNodes[r],t));n.push(e.childNodes[r])}return n}for(var o=e.nextSibling;o;){if(!0===u.isChildOf(t,o))return n=u.arrayMerge(n,u.getElementsBetween(o,t));if(o===t)return n;n.push(o),o=o.nextSibling}for(var s=u.getParents(e),a=u.getParents(t),c=u.arrayDiff(s,a,!0),l=c.length,d=0;d<l-1;d++)n=u.arrayMerge(n,u.getSiblings(c[d],"next"));var h=c[c.length-1];return n=u.arrayMerge(n,u.getElementsBetween(h,t))},u.getCommonAncestor=function(e,t){for(var n=e;n;){if(!0===u.isChildOf(t,n))return n;n=n.parentNode}return null},u.getNextNode=function(e,t){if(e)for(;e.parentNode;){if(e===t)return null;if(e.nextSibling){if(e.nextSibling.nodeType!==u.TEXT_NODE||0!==e.nextSibling.length)return u.getFirstChild(e.nextSibling);e=e.nextSibling}else e=e.parentNode}return null},u.getNextContentNode=function(e,t){if(e)for(;e.parentNode;){if(e===t)return null;if(e.nextSibling&&u.canContainTextElement(u.getBlockParent(e))){if(e.nextSibling.nodeType!==u.TEXT_NODE||0!==e.nextSibling.length)return e.nextSibling;e=e.nextSibling}else{if(e.nextElementSibling)return e.nextElementSibling;e=e.parentNode}}return null},u.getPrevNode=function(e,t){if(e)for(;e.parentNode;){if(e===t)return null;if(e.previousSibling){if(e.previousSibling.nodeType!==u.TEXT_NODE||0!==e.previousSibling.length)return u.getLastChild(e.previousSibling);e=e.previousSibling}else e=e.parentNode}return null},u.getPrevContentNode=function(e,t){if(e)for(;e.parentNode;){if(e===t)return null;if(e.previousSibling&&u.canContainTextElement(u.getBlockParent(e))){if(e.previousSibling.nodeType!==u.TEXT_NODE||0!==e.previousSibling.length)return e.previousSibling;e=e.previousSibling}else{if(e.previousElementSibling)return e.previousElementSibling;e=e.parentNode}}return null},u.canContainTextElement=function(e){return!(!e||!e.nodeName)&&-1!=u.TEXT_CONTAINER_ELEMENTS.lastIndexOf(e.nodeName.toLowerCase())},u.getFirstChild=function(e){return e.firstChild?e.firstChild.nodeType===u.ELEMENT_NODE?u.getFirstChild(e.firstChild):e.firstChild:e},u.getLastChild=function(e){return e.lastChild?e.lastChild.nodeType===u.ELEMENT_NODE?u.getLastChild(e.lastChild):e.lastChild:e},u.removeEmptyNodes=function(e,t){for(var n=jQuery(e).find(":empty"),i=n.length;0<i;)i--,!1===u.isStubElement(n[i])&&(t&&!1===t.call(this,n[i])||u.remove(n[i]))},u.create=function(e){return jQuery(e)[0]},u.find=function(e,t){return jQuery(e).find(t)},u.children=function(e,t){return jQuery(e).children(t)},u.parent=function(e,t){return jQuery(e).parent(t)[0]},u.parents=function(e,t){return jQuery(e).parents(t)},u.is=function(e,t){return jQuery(e).is(t)},u.extend=function(e,t,n,i){return jQuery.extend.apply(this,arguments)},u.walk=function(e,t,n){e&&(n=n||0,!1!==t.call(this,e,n)&&(e.childNodes&&0<e.childNodes.length?u.walk(e.firstChild,t,n+1):e.nextSibling?u.walk(e.nextSibling,t,n):e.parentNode&&e.parentNode.nextSibling&&u.walk(e.parentNode.nextSibling,t,n-1)))},u.revWalk=function(e,t){e&&!1!==t.call(this,e)&&(e.childNodes&&0<e.childNodes.length?u.walk(e.lastChild,t):e.previousSibling?u.walk(e.previousSibling,t):e.parentNode&&e.parentNode.previousSibling&&u.walk(e.parentNode.previousSibling,t))},u.setStyle=function(e,t,n){e&&jQuery(e).css(t,n)},u.getStyle=function(e,t){return jQuery(e).css(t)},u.hasClass=function(e,t){return jQuery(e).hasClass(t)},u.addClass=function(e,t){jQuery(e).addClass(t)},u.removeClass=function(e,t){jQuery(e).removeClass(t)},u.preventDefault=function(e){e.preventDefault(),u.stopPropagation(e)},u.stopPropagation=function(e){e.stopPropagation()},u.noInclusionInherits=function(e,t){(t instanceof String||"string"==typeof t)&&(t=window[t]),(e instanceof String||"string"==typeof e)&&(e=window[e]);function n(){}if(!0===u.isset(t))for(value in t.prototype)e.prototype[value]?n.prototype[value]=t.prototype[value]:e.prototype[value]=t.prototype[value];e.prototype&&(n.prototype.constructor=t,e.prototype.super=new n)},u.each=function(e,n){jQuery.each(e,function(e,t){n.call(this,e,t)})},u.foreach=function(e,t){if(e instanceof Array||e instanceof NodeList||void 0!==e.length&&void 0!==e.item)for(var n=e.length,i=0;i<n;i++){if(!1===t.call(this,i,e[i]))break}else for(var r in e){if(!0===e.hasOwnProperty(r))if(!1===t.call(this,r))break}},u.isBlank=function(e){return!(e&&!/^\s*$/.test(e))},u.isFn=function(e){return"function"==typeof e},u.isObj=function(e){return null!==e&&"object"==typeof e},u.isset=function(e){return null!=e},u.isArray=function(e){return jQuery.isArray(e)},u.isNumeric=function(e){return null!==e.match(/^\d+$/)},u.getUniqueId=function(){return((new Date).getTime()+""+Math.ceil(1e6*Math.random())).substr(5,18).replace(/,/,"")},u.inArray=function(e,t){for(var n=t.length,i=0;i<n;i++)if(e===t[i])return!0;return!1},u.arrayDiff=function(e,t,n){for(var i=e.length,r=[],o=0;o<i;o++)!1===u.inArray(e[o],t)&&r.push(e[o]);if(!0!==n){i=t.length;for(o=0;o<i;o++)!1===u.inArray(t[o],e)&&r.push(t[o])}return r},u.arrayMerge=function(e,t){for(var n=t.length,i=0;i<n;i++)e.push(t[i]);return e},u.stripTags=function(e,t){if("string"==typeof t){var n=jQuery("<div>"+e+"</div>");return n.find("*").not(t).remove(),n.html()}for(var i,r=new RegExp(/<\/?(\w+)((\s+\w+(\s*=\s*(?:".*?"|'.*?'|[^'">\s]+))?)+\s*|\s*)\/?>/gim),o=e;null!=(i=r.exec(e));)!1!==u.isset(t)&&!0===u.inArray(i[1],t)||(o=o.replace(i[0],""));return o},u.browser=function(){var e={};return e.version=jQuery.browser.version,!0===jQuery.browser.mozilla?e.type="mozilla":!0===jQuery.browser.msie?e.type="msie":!0===jQuery.browser.opera?e.type="opera":!0===jQuery.browser.webkit&&(e.type="webkit"),e},u.getBrowserType=function(){if(null===this._browserType){for(var e=["msie","firefox","chrome","safari"],t=e.length,n=0;n<t;n++){if(!0===new RegExp(e[n],"i").test(navigator.userAgent))return this._browserType=e[n],this._browserType}this._browserType="other"}return this._browserType},u.getWebkitType=function(){return"webkit"!==u.browser().type?(console.log("Not a webkit!"),!1):0<Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")?"safari":"chrome"},u.isBrowser=function(e){return u.browser().type===e},u.getBlockParent=function(e,t){if(!0===u.isBlockElement(e))return e;if(e)for(;e.parentNode;){if((e=e.parentNode)===t)return null;if(!0===u.isBlockElement(e))return e}return null},u.findNodeParent=function(e,t,n){if(e)for(;e.parentNode;){if(e===n)return null;if(!0===u.is(e,t))return e;e=e.parentNode}return null},u.onBlockBoundary=function(e,t,n){return!(!e||!t)&&(u.isChildOfTagNames(e,n)||u.is(e,n.join(", "))&&e||null)!==(u.isChildOfTagNames(t,n)||u.is(t,n.join(", "))&&t||null)},u.isOnBlockBoundary=function(e,t,n){return!(!e||!t)&&(u.getBlockParent(e,n)||u.isBlockElement(e,n)&&e||null)!==(u.getBlockParent(t,n)||u.isBlockElement(t,n)&&t||null)},u.mergeContainers=function(e,t){if(!e||!t)return!1;if(e.nodeType===u.TEXT_NODE||u.isStubElement(e))t.appendChild(e);else if(e.nodeType===u.ELEMENT_NODE){for(;e.firstChild;)t.appendChild(e.firstChild);u.remove(e)}return!0},u.mergeBlockWithSibling=function(e,t,n){var i=n?jQuery(t).next().get(0):jQuery(t).prev().get(0);return n?u.mergeContainers(i,t):u.mergeContainers(t,i),e.collapse(!0),!0},u.date=function(e,t,n){if(null!==t||!n||(t=u.tsIso8601ToTimestamp(n))){for(var i=new Date(t),r=e.split(""),o=r.length,s="",a=0;a<o;a++){var c="",l=r[a];switch(l){case"D":case"l":c=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][i.getDay()];"D"===l&&(c=c.substring(0,3));break;case"F":case"m":(c=i.getMonth()+1)<10&&(c="0"+c);break;case"M":months=["January","February","March","April","May","June","July","August","September","October","November","December"],c=months[i.getMonth()],"M"===l&&(c=c.substring(0,3));break;case"d":c=i.getDate();break;case"S":c=u.getOrdinalSuffix(i.getDate());break;case"Y":c=i.getFullYear();break;case"y":c=(c=i.getFullYear()).toString().substring(2);break;case"H":c=i.getHours();break;case"h":0===(c=i.getHours())?c=12:12<c&&(c-=12);break;case"i":c=u.addNumberPadding(i.getMinutes());break;case"a":c="am",12<=i.getHours()&&(c="pm");break;default:c=l}s+=c}return s}},u.getOrdinalSuffix=function(e){var t="",n=e%100;if(4<=n&&n<=20)t="th";else switch(e%10){case 1:t="st";break;case 2:t="nd";break;case 3:t="rd";break;default:t="th"}return t},u.addNumberPadding=function(e){return e<10&&(e="0"+e),e},u.tsIso8601ToTimestamp=function(e){var t=e.match(new RegExp(/(\d\d\d\d)(?:-?(\d\d)(?:-?(\d\d)(?:[T ](\d\d)(?::?(\d\d)(?::?(\d\d)(?:\.(\d+))?)?)?(?:Z|(?:([-+])(\d\d)(?::?(\d\d))?)?)?)?)?)?/));if(t){var n=new Date;n.setDate(t[3]),n.setFullYear(t[1]),n.setMonth(t[2]-1),n.setHours(t[4]),n.setMinutes(t[5]),n.setSeconds(t[6]);var i=60*t[9];return"+"===t[8]&&(i*=-1),i-=n.getTimezoneOffset(),n.getTime()+60*i*1e3}return null},this.dom=u}.call(this.ice),function(){var e=function(e,t,n){this.env=e,this.element=e.element,this.selection=this.env.selection,n||this.removeBookmarks(this.element);var i,r=t||this.selection.getRangeAt(0),o=(t=r.cloneRange()).startContainer,s=(t.endContainer,t.startOffset);t.endOffset;t.collapse(!1);var a=this.env.document.createElement("span");a.style.display="none",ice.dom.setHtml(a,"&nbsp;"),ice.dom.addClass(a,"iceBookmark iceBookmark_end"),a.setAttribute("iceBookmark","end"),t.insertNode(a),ice.dom.isChildOf(a,this.element)||this.element.appendChild(a),t.setStart(o,s),t.collapse(!0);var c=this.env.document.createElement("span");c.style.display="none",ice.dom.addClass(c,"iceBookmark iceBookmark_start"),ice.dom.setHtml(c,"&nbsp;"),c.setAttribute("iceBookmark","start");try{t.insertNode(c),c.previousSibling===a&&(i=c,c=a,a=i)}catch(e){ice.dom.insertBefore(a,c)}!1===ice.dom.isChildOf(c,this.element)&&(this.element.firstChild?ice.dom.insertBefore(this.element.firstChild,c):this.element.appendChild(c)),a.previousSibling||(i=this.env.document.createTextNode(""),ice.dom.insertBefore(a,i)),c.nextSibling||(i=this.env.document.createTextNode(""),ice.dom.insertAfter(c,i)),r.setStart(c.nextSibling,0),r.setEnd(a.previousSibling,a.previousSibling.length||0),this.start=c,this.end=a};e.prototype={selectBookmark:function(){var e,t=this.selection.getRangeAt(0),n=null,i=null,r=0,o=null;this.start.nextSibling===this.end||0===ice.dom.getElementsBetween(this.start,this.end).length?this.end.nextSibling?n=ice.dom.getFirstChild(this.end.nextSibling):this.start.previousSibling?(n=ice.dom.getFirstChild(this.start.previousSibling)).nodeType===ice.dom.TEXT_NODE&&(r=n.length):(this.end.parentNode.appendChild(this.env.document.createTextNode("")),n=ice.dom.getFirstChild(this.end.nextSibling)):(this.start.nextSibling?n=ice.dom.getFirstChild(this.start.nextSibling):(this.start.previousSibling||(e=this.env.document.createTextNode(""),ice.dom.insertBefore(this.start,e)),r=(n=ice.dom.getLastChild(this.start.previousSibling)).length),this.end.previousSibling?i=ice.dom.getLastChild(this.end.previousSibling):(i=ice.dom.getFirstChild(this.end.nextSibling||this.end),o=0)),ice.dom.remove([this.start,this.end]),null===i?(t.setEnd(n,r),t.collapse(!1)):(t.setStart(n,r),null===o&&(o=i.length||0),t.setEnd(i,o));try{this.selection.addRange(t)}catch(e){}},getBookmark:function(e,t){return ice.dom.getClass("iceBookmark_"+t,e)[0]},removeBookmarks:function(e){ice.dom.remove(ice.dom.getClass("iceBookmark",e,"span"))}},this.Bookmark=e}.call(this.ice),function(){var e=function(e){this._selection=null,this.env=e,this._initializeRangeLibrary(),this._getSelection()};e.prototype={_getSelection:function(){return this._selection?this._selection.refresh():this.env.frame?this._selection=rangy.getIframeSelection(this.env.frame):this._selection=rangy.getSelection(),this._selection},createRange:function(){return rangy.createRange(this.env.document)},getRangeAt:function(e){this._selection.refresh();try{return this._selection.getRangeAt(e)}catch(e){return this._selection=null,this._getSelection().getRangeAt(0)}},addRange:function(e){this._selection||(this._selection=this._getSelection()),this._selection.setSingleRange(e),this._selection.ranges=[e]},_initializeRangeLibrary:function(){var n=this;rangy.init(),rangy.config.checkSelectionRanges=!1;function i(e,t,n,i){if(0!==n)switch(t){case ice.dom.CHARACTER_UNIT:0<n?e.moveCharRight(i,n):e.moveCharLeft(i,-1*n);break;case ice.dom.WORD_UNIT:}}rangy.rangePrototype.moveStart=function(e,t){i(this,e,t,!0)},rangy.rangePrototype.moveEnd=function(e,t){i(this,e,t,!1)},rangy.rangePrototype.setRange=function(e,t,n){e?this.setStart(t,n):this.setEnd(t,n)},rangy.rangePrototype.moveCharLeft=function(e,t){var n=e?(i=this.startContainer,this.startOffset):(i=this.endContainer,this.endOffset);if(i.nodeType===ice.dom.ELEMENT_NODE)if(i.hasChildNodes()){for(i=i.childNodes[n],i=this.getPreviousTextNode(i);i&&i.nodeType==ice.dom.TEXT_NODE&&""===i.nodeValue;)i=this.getPreviousTextNode(i);n=i.data.length-t}else n=-1*t;else n-=t;if(n<0)for(;n<0;){var i;if(!(i=this.getPreviousTextNode(i,[])))return;i.nodeType!==ice.dom.ELEMENT_NODE&&(n+=i.data.length)}this.setRange(e,i,n)},rangy.rangePrototype.moveCharRight=function(e,t){var n,i=e?(n=this.startContainer,this.startOffset):(n=this.endContainer,this.endOffset);n.nodeType===ice.dom.ELEMENT_NODE?((n=n.childNodes[i]).nodeType!==ice.dom.TEXT_NODE&&(n=this.getNextTextNode(n)),i=t):i+=t;var r=i-n.data.length;if(0<r){for(var o=[];0<r;)if((n=this.getNextContainer(n,o)).nodeType!==ice.dom.ELEMENT_NODE){if(n.data.length>=r)break;0<n.data.length&&(r-=n.data.length)}i=r}this.setRange(e,n,i)},rangy.rangePrototype.getNextContainer=function(e,t){if(!e)return null;for(;e.nextSibling;)if((e=e.nextSibling).nodeType!==ice.dom.TEXT_NODE){var n=this.getFirstSelectableChild(e);if(null!==n)return n}else if(!0===this.isSelectable(e))return e;for(;e&&!e.nextSibling;)e=e.parentNode;if(!e)return null;if(e=e.nextSibling,!0===this.isSelectable(e))return e;t&&!0===ice.dom.isBlockElement(e)&&t.push(e);var i=this.getFirstSelectableChild(e);return null!==i?i:this.getNextContainer(e,t)},rangy.rangePrototype.getPreviousContainer=function(e,t){if(!e)return null;for(;e.previousSibling;)if((e=e.previousSibling).nodeType!==ice.dom.TEXT_NODE){if(!0===ice.dom.isStubElement(e))return e;var n=this.getLastSelectableChild(e);if(null!==n)return n}else if(!0===this.isSelectable(e))return e;for(;e&&!e.previousSibling;)e=e.parentNode;if(!e)return null;if(e=e.previousSibling,!0===this.isSelectable(e))return e;t&&!0===ice.dom.isBlockElement(e)&&t.push(e);var i=this.getLastSelectableChild(e);return null!==i?i:this.getPreviousContainer(e,t)},rangy.rangePrototype.getNextTextNode=function(e){return e.nodeType===ice.dom.ELEMENT_NODE&&0!==e.childNodes.length?this.getFirstSelectableChild(e):(e=this.getNextContainer(e)).nodeType===ice.dom.TEXT_NODE?e:this.getNextTextNode(e)},rangy.rangePrototype.getPreviousTextNode=function(e,t){return(e=this.getPreviousContainer(e,t)).nodeType===ice.dom.TEXT_NODE?e:this.getPreviousTextNode(e,t)},rangy.rangePrototype.getFirstSelectableChild=function(e){if(e){if(e.nodeType===ice.dom.TEXT_NODE)return e;for(var t=e.firstChild;t;){if(!0===this.isSelectable(t))return t;if(t.firstChild){var n=this.getFirstSelectableChild(t);if(null!==n)return n;t=t.nextSibling}else t=t.nextSibling}}return null},rangy.rangePrototype.getLastSelectableChild=function(e){if(e){if(e.nodeType===ice.dom.TEXT_NODE)return e;for(var t=e.lastChild;t;){if(!0===this.isSelectable(t))return t;if(t.lastChild){var n=this.getLastSelectableChild(t);if(null!==n)return n;t=t.previousSibling}else t=t.previousSibling}}return null},rangy.rangePrototype.isSelectable=function(e){return!(!e||e.nodeType!==ice.dom.TEXT_NODE||0===e.data.length)},rangy.rangePrototype.getHTMLContents=function(e){e=e||this.cloneContents();var t=n.env.document.createElement("div");return t.appendChild(e.cloneNode(!0)),t.innerHTML},rangy.rangePrototype.getHTMLContentsObj=function(){return this.cloneContents()}}},this.Selection=e}.call(this.ice),function(){function e(e){this._ice=e}e.prototype={start:function(){},clicked:function(e){return!0},mouseDown:function(e){return!0},keyDown:function(e){return!0},keyPress:function(e){return!0},selectionChanged:function(e){},setEnabled:function(e){},setDisabled:function(e){},caretUpdated:function(){},nodeInserted:function(e,t){},nodeCreated:function(e,t){},caretPositioned:function(){},remove:function(){this._ice.removeKeyPressListener(this)},setSettings:function(e){}},this.IcePlugin=e}.call(this.ice),function(){function e(e){this.plugins={},this.pluginConstructors={},this.keyPressListeners={},this.activePlugin=null,this.pluginSets={},this.activePluginSet=null,this._ice=e}e.prototype={getPluginNames:function(){var e=[];for(var t in this.plugins)e.push(t);return e},addPluginObject:function(e,t){this.plugins[e]=t},addPlugin:function(e,t){if("function"!=typeof t)throw Error("IcePluginException: plugin must be a constructor function");!1===ice.dom.isset(this.pluginConstructors[e])&&(this.pluginConstructors[e]=t)},loadPlugins:function(e,t){if(0===e.length)t.call(this);else{var n=e.shift();if("object"==typeof n&&(n=n.name),!0!==ice.dom.isset(ice._plugin[n]))throw new Error("plugin was not included in the page: "+n);this.addPlugin(n,ice._plugin[n]),this.loadPlugins(e,t)}},_enableSet:function(e){this.activePluginSet=e;for(var t=this.pluginSets[e].length,n=0;n<t;n++){var i,r=this.pluginSets[e][n],o="",o="object"==typeof r?r.name:r,s=this.pluginConstructors[o];s&&(i=new s(this._ice),this.plugins[o]=i,!0===ice.dom.isset(r.settings)&&i.setSettings(r.settings),i.start())}},setActivePlugin:function(e){this.activePlugin=e},getActivePlugin:function(){return this.activePlugin},_getPluginName:function(e){var t=e.toString(),n="function ".length;return t.substr(n,t.indexOf("(")-n)},removePlugin:function(e){this.plugins[e]&&this.plugins[e].remove()},getPlugin:function(e){return this.plugins[e]},usePlugins:function(e,t,n){var i=this;!0===ice.dom.isset(t)?this.pluginSets[e]=t:this.pluginSets[e]=[];var r=this.pluginSets[e].concat([]);this.loadPlugins(r,function(){i._enableSet(e),n&&n.call(this)})},disablePlugin:function(e){this.plugins[e].disable()},isPluginElement:function(e){for(var t in this.plugins)if(this.plugins[t].isPluginElement&&!0===this.plugins[t].isPluginElement(e))return!0;return!1},fireKeyPressed:function(e){if(!1===this._fireKeyPressFns(e,"all_keys"))return!1;var t,n=[];switch(!0!==e.ctrlKey&&!0!==e.metaKey||n.push("ctrl"),!0===e.shiftKey&&n.push("shift"),!0===e.altKey&&n.push("alt"),e.keyCode){case 13:n.push("enter");break;case ice.dom.DOM_VK_LEFT:n.push("left");break;case ice.dom.DOM_VK_RIGHT:n.push("right");break;case ice.dom.DOM_VK_UP:n.push("up");break;case ice.dom.DOM_VK_DOWN:n.push("down");break;case 9:n.push("tab");break;case ice.dom.DOM_VK_DELETE:n.push("delete");break;default:e.keyCode?t=e.keyCode:e.which&&(t=e.which),t&&n.push(String.fromCharCode(t).toLowerCase())}var i=n.sort().join("+");return this._fireKeyPressFns(e,i)},_fireKeyPressFns:function(e,t){if(this.keyPressListeners[t])for(var n=this.keyPressListeners[t].length,i=0;i<n;i++){var r=this.keyPressListeners[t][i],o=r.fn,s=r.plugin,a=r.data;if(o)if(!0===ice.dom.isFn(o)){if(!0===o.call(s,e,a))return ice.dom.preventDefault(e),!1}else if(s[o]&&!0===s[o].call(s,e,a))return ice.dom.preventDefault(e),!1}return!0},fireSelectionChanged:function(e){for(var t in this.plugins)this.plugins[t].selectionChanged(e)},fireNodeInserted:function(e,t){for(var n in this.plugins)if(!1===this.plugins[n].nodeInserted(e,t))return!1},fireNodeCreated:function(e,t){for(var n in this.plugins)if(!1===this.plugins[n].nodeCreated(e,t))return!1},fireCaretPositioned:function(){for(var e in this.plugins)this.plugins[e].caretPositioned()},fireClicked:function(e){var t=!0;for(var n in this.plugins)!1===this.plugins[n].clicked(e)&&(t=!1);return t},fireMouseDown:function(e){var t=!0;for(var n in this.plugins)!1===this.plugins[n].mouseDown(e)&&(t=!1);return t},fireKeyDown:function(e){var t=!0;for(var n in this.plugins)!1===this.plugins[n].keyDown(e)&&(t=!1);return t},fireKeyPress:function(e){var t=!0;for(var n in this.plugins)!1===this.plugins[n].keyPress(e)&&(t=!1);return t},fireEnabled:function(e){for(var t in this.plugins)this.plugins[t].setEnabled(e)},fireDisabled:function(e){for(var t in this.plugins)this.plugins[t].setDisabled(e)},fireCaretUpdated:function(){for(var e in this.plugins)this.plugins[e].caretUpdated&&this.plugins[e].caretUpdated()}},this._plugin={},this.IcePluginManager=e}.call(this.ice),function(){var e=function(e){this._ice=e};e.prototype={nodeCreated:function(e,t){e.setAttribute("title",(t.action||"Modified")+" by "+e.getAttribute(this._ice.userNameAttribute)+" - "+ice.dom.date("m/d/Y h:ia",parseInt(e.getAttribute(this._ice.timeAttribute))))}},ice.dom.noInclusionInherits(e,ice.IcePlugin),this._plugin.IceAddTitlePlugin=e}.call(this.ice),function(){var e=function(e){this._ice=e,this._tmpNode=null,this._tmpNodeTagName="icepaste",this._pasteId="icepastediv";var t=this;this.pasteType="formattedClean",this.preserve="p",this.beforePasteClean=function(e){return e},this.afterPasteClean=function(e){return e},e.element.oncopy=function(){return t.handleCopy.apply(t)}};e.prototype={setSettings:function(e){e=e||{},ice.dom.extend(this,e),this.preserve+=","+this._tmpNodeTagName,this.setupPreserved()},keyDown:function(e){if(!0===e.metaKey||!0===e.ctrlKey)return 86==e.keyCode?this.handlePaste():88==e.keyCode&&this.handleCut(),!0},handleCopy:function(e){},handlePaste:function(e){var t,n=this._ice.getCurrentRange();switch(n.collapsed||(this._ice.isTracking?(this._ice.deleteContents(),n=n.cloneRange()):(n.deleteContents(),n.collapse(!0))),this._ice.isTracking&&this._ice._moveRangeToValidTrackingPos(n),n.startContainer==this._ice.element&&((t=ice.dom.find(this._ice.element,this._ice.blockEl)[0])||(t=ice.dom.create("<"+this._ice.blockEl+" ><br/></"+this._ice.blockEl+">"),this._ice.element.appendChild(t)),n.setStart(t,0),n.collapse(!0),this._ice.env.selection.addRange(n)),this._tmpNode=this._ice.env.document.createElement(this._tmpNodeTagName),n.insertNode(this._tmpNode),this.pasteType){case"formatted":this.setupPaste();break;case"formattedClean":this.setupPaste(!0)}return!0},setupPaste:function(t){var e=this.createDiv(this._pasteId),n=this,i=this._ice.getCurrentRange();return i.selectNodeContents(e),this._ice.selection.addRange(i),e.onpaste=function(e){setTimeout(function(){n.handlePasteValue(t)},0),e.stopPropagation()},e.focus(),!0},handlePasteValue:function(e){var t=this._ice.env.document,n=t.getElementById(this._pasteId),i=ice.dom.getHtml(n),r=ice.dom.children("<div>"+i+"</div>",this._ice.blockEl);1===r.length&&ice.dom.getNodeTextContent("<div>"+i+"</div>")===ice.dom.getNodeTextContent(r)&&(i=ice.dom.getHtml(i)),i=this.beforePasteClean.call(this,i),e&&(i=this._ice.getCleanContent(i),i=this.stripPaste(i)),i=this.afterPasteClean.call(this,i),i=ice.dom.trim(i);var o=this._ice.getCurrentRange();o.setStartAfter(this._tmpNode),o.collapse(!0);var s,a=null,c=null,l=null,d=o.createContextualFragment(i),h=this._ice.startBatchChange();if(ice.dom.hasBlockChildren(d)){var u=ice.dom.isChildOfTagName(this._tmpNode,this._ice.blockEl);o.setEndAfter(u.lastChild),this._ice.selection.addRange(o);var f=o.extractContents(),g=t.createElement(this._ice.blockEl);g.appendChild(f),ice.dom.insertAfter(u,g),o.setStart(g,0),o.collapse(!0),this._ice.selection.addRange(o);for(var m,p=o.startContainer;d.firstChild;){3!==d.firstChild.nodeType||jQuery.trim(d.firstChild.nodeValue)?ice.dom.isBlockElement(d.firstChild)?(""!==d.firstChild.textContent&&(m=a=null,this._ice.isTracking?(m=this._ice.createIceNode("insertType"),this._ice.addChange("insertType",[m]),l=t.createElement(d.firstChild.tagName),m.innerHTML=d.firstChild.innerHTML,l.appendChild(m)):(m=l=t.createElement(d.firstChild.tagName),l.innerHTML=d.firstChild.innerHTML),c=m,ice.dom.insertBefore(p,l)),d.removeChild(d.firstChild)):(a||(l=t.createElement(this._ice.blockEl),ice.dom.insertBefore(p,l),this._ice.isTracking?(a=this._ice.createIceNode("insertType"),this._ice.addChange("insertType",[a]),l.appendChild(a)):a=l),(c=a).appendChild(d.removeChild(d.firstChild))):d.removeChild(d.firstChild)}g.textContent||g.parentNode.removeChild(g)}else if(this._ice.isTracking)l=this._ice.createIceNode("insertType",d),this._ice.addChange("insertType",[l]),o.insertNode(l),c=l;else for(;s=d.firstChild;)o.insertNode(s),o.setStartAfter(s),o.collapse(!0),c=s;this._ice.endBatchChange(h),n.parentNode.removeChild(n),this._cleanup(c)},createDiv:function(e){var t=this._ice.env.document,n=t.getElementById(e);n&&ice.dom.remove(n);var i=t.createElement("div");return i.id=e,i.setAttribute("contentEditable",!0),ice.dom.setStyle(i,"width","1px"),ice.dom.setStyle(i,"height","1px"),ice.dom.setStyle(i,"overflow","hidden"),ice.dom.setStyle(i,"position","fixed"),ice.dom.setStyle(i,"top","10px"),ice.dom.setStyle(i,"left","10px"),i.appendChild(t.createElement("br")),t.body.appendChild(i),i},handleCut:function(){var e,t=this,n=this._ice.getCurrentRange();n.collapsed||(this.cutElement=this.createDiv("icecut"),this.cutElement.innerHTML=n.getHTMLContents().replace(/ </g,"&nbsp;<").replace(/> /g,">&nbsp;"),this._ice.isTracking?this._ice.deleteContents():n.deleteContents(),(e=this._ice.env.document.createRange()).setStart(this.cutElement.firstChild,0),e.setEndAfter(this.cutElement.lastChild),setTimeout(function(){t.cutElement.focus(),setTimeout(function(){ice.dom.remove(t.cutElement),n.setStart(n.startContainer,n.startOffset),n.collapse(!1),t._ice.env.selection.addRange(n)},100)},0),t._ice.env.selection.addRange(e))},stripPaste:function(e){return e=this._cleanWordPaste(e),e=this.cleanPreserved(e)},setupPreserved:function(){var r=this;this._tags="",this._attributesMap=[],ice.dom.each(this.preserve.split(","),function(e,t){t.match(/(\w+)(\[(.+)\])?/);var n=RegExp.$1,i=RegExp.$3;r._tags&&(r._tags+=","),r._tags+=n.toLowerCase(),r._attributesMap[n]=i.split("|")})},cleanPreserved:function(e){var o=this,t=this._ice.env.document.createElement("div");return t.innerHTML=e,t=ice.dom.stripEnclosingTags(t,this._tags),ice.dom.each(ice.dom.find(t,this._tags),function(e,t){if(ice.dom.hasClass(t,"skip-clean"))return!0;var n=t.tagName.toLowerCase(),i=o._attributesMap[n];if(i[0]&&"*"===i[0])return!0;if(t.hasAttributes())for(var r=t.attributes,e=r.length-1;0<=e;e--)ice.dom.inArray(r[e].name,i)||t.removeAttribute(r[e].name)}),t.innerHTML},_cleanWordPaste:function(e){return e=(e=(e=(e=(e=e.replace(/<(meta|link)[^>]+>/g,"")).replace(/<!--(.|\s)*?-->/g,"")).replace(/<style>[\s\S]*?<\/style>/g,"")).replace(/<\/?\w+:[^>]*>/gi,"")).replace(/<\\?\?xml[^>]*>/gi,""),e=(e=this._cleanPaste(e)).replace(/<(\w[^>]*) (lang)=([^ |>]*)([^>]*)/gi,"<$1$4")},_cleanPaste:function(e){return e=(e=(e=(e=e.replace(/<b(\s+|>)/g,"<strong$1")).replace(/<\/b(\s+|>)/g,"</strong$1")).replace(/<i(\s+|>)/g,"<em$1")).replace(/<\/i(\s+|>)/g,"</em$1")},_cleanup:function(e){try{this._ice.env.frame?this._ice.env.frame.contentWindow.focus():this._ice.element.focus(),e=e&&e.lastChild||e||this._tmpNode;var t=this._ice.getCurrentRange();t.setStartAfter(e),t.collapse(!0),this._ice.selection.addRange(t),this._tmpNode.parentNode.removeChild(this._tmpNode),this._tmpNode=null;for(var n=this._ice.env.document.getElementsByClassName(this._ice.changeTypes.insertType.alias),i=0;i<n.length;i++)n[i].textContent||n[i].parentNode&&n[i].parentNode.removeChild(n[i])}catch(e){window.console&&console.error(e)}}},ice.dom.noInclusionInherits(e,ice.IcePlugin),this._plugin.IceCopyPastePlugin=e}.call(this.ice),function(){function e(e){this._ice=e}var t=this.ice;e.prototype={convert:function(e){var n=this;try{n._ice.placeholdDeletes(),t.dom.each(e.getElementsByTagName(this._ice.blockEl),function(e,t){n._convertBlock(t)})}catch(e){window.console&&console.error(e)}finally{n._ice.revertDeletePlaceholders()}},_convertBlock:function(e){var n,i,r,o,s,a,c,l,d,h,u,f,g,m,p,C;t.dom.getNodeTextContent(e)<2||(o=String.fromCharCode(8216),s=String.fromCharCode(8217),a=String.fromCharCode(8220),c=String.fromCharCode(8221),l=function(e){return/\d/.test(e)},d=function(e){return/\w/.test(e)},h=function(e){return e===String.fromCharCode(160)||e===String.fromCharCode(32)},u=function(e){return h(e)||"("===e},f=function(e){return h(e)||null==e||";"===e||")"===e||"."==e||"!"===e||","===e||"?"===e||":"===e},g=function(e){return!h(e)},m=function(e){return"'"===e||e===o||e===s},p=t.dom.getHtml(e).match(/(<("[^"]*"|'[^']*'|[^'">])*>|&.*;|.)/g),C=function(e,t,n){var o=e.length,s=n<0?-1:1;return function e(t,n,i){if(n<0||o<=n)return null;var r=t[n+s];return r&&1==r.length&&!(i+=-1*s)?r:e(t,n+s,i)}(e,t,n)},t.dom.each(p,function(e,t){if("&nbsp;"==t&&(t=p[e]=" "),1==t.length){switch(n=C(p,e,-1),i=t,r=C(p,e,1),i){case o:case s:i="'";case"'":(null==n||h(n))&&l(r)&&l(C(p,e,2))&&f(C(p,e,3))?i=s:null==n||u(n)&&g(r)?i=o:(null==r||g(n)&&f(r)||d(n)&&d(r))&&(i=s);break;case a:case c:i='"';case'"':f(r)&&h(n)&&m(C(p,e,-2))?i=c:null==n||u(n)&&g(r)?i=a:null==r||g(n)&&f(r)?i=c:(null==n||h(n))&&h(r)&&m(C(p,e,1))&&(i=a)}null!=i&&(p[e]=i)}}),t.dom.setHtml(e,p.join("")))}},t.dom.noInclusionInherits(e,t.IcePlugin),this.ice._plugin.IceSmartQuotesPlugin=e}.call(this),function(){function e(e){this._ice=e}e.prototype={keyDown:function(e){if(ice.dom.isBrowser("mozilla")){var t=parseInt(ice.dom.browser().version);if(14<t&&173===e.keyCode||t<=14&&109===e.keyCode)return this.convertEmdash(e)}else if(189===e.keyCode)return this.convertEmdash(e);return!0},convertEmdash:function(e){var t=this._ice.getCurrentRange();if(t.collapsed){try{if(t.moveStart(ice.dom.CHARACTER_UNIT,-1),ice.dom.getParents(t.startContainer,this._ice.blockEl)[0]===ice.dom.getParents(t.endContainer,this._ice.blockEl)[0]&&!this._ice.getIceNode(t.startContainer,"deleteType")&&(c=t.toHtml(),"-"===c)){t.extractContents(),t.collapse();var n=this._ice.env.document.createTextNode("—");return this._ice.isTracking?this._ice._insertNode(n,t):(t.insertNode(n),t.setStart(n,1),t.collapse(!0)),!(this._ice._preventKeyPress=!0)}}catch(e){}t.collapse()}return!0}},ice.dom.noInclusionInherits(e,ice.IcePlugin),this._plugin.IceEmdashPlugin=e}.call(this.ice);